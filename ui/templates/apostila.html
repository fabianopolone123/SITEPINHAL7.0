<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apostila</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .apostila-classes { display:grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap:.75rem; }
    .apostila-class-btn {
      display:block;
      padding:.85rem;
      border:1px solid #dbeafe;
      border-radius:12px;
      text-decoration:none;
      color:#0f172a;
      background:#f8fbff;
    }
    .apostila-class-btn.is-active { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37, 99, 235, .14); background:#eff6ff; }
    .apostila-class-btn strong { display:block; margin-bottom:.15rem; }
    .apostila-class-btn small { color:#475569; }

    .apostila-form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
    .apostila-form-grid .full { grid-column:1 / -1; }
    .apostila-form-grid label { display:flex; flex-direction:column; gap:.35rem; font-size:.9rem; color:#334155; font-weight:600; }
    .apostila-form-grid input, .apostila-form-grid textarea {
      width:100%;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:.72rem .85rem;
      font:inherit;
    }
    .apostila-actions { margin-top:.9rem; display:flex; justify-content:flex-end; }

    .apostila-requisito-card {
      border:1px solid #dbeafe;
      border-radius:14px;
      background:#fff;
      padding:.9rem;
    }
    .apostila-requisito-card + .apostila-requisito-card { margin-top:.8rem; }
    .apostila-requisito-head {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.8rem;
      margin-bottom:.6rem;
    }
    .apostila-requisito-ident { display:flex; gap:.7rem; align-items:flex-start; }
    .apostila-requisito-foto {
      width:68px;
      height:68px;
      border-radius:10px;
      object-fit:cover;
      border:1px solid #dbeafe;
      background:#f8fafc;
      flex-shrink:0;
    }
    .apostila-requisito-head h4 { margin:0; }
    .apostila-meta { color:#64748b; font-size:.82rem; }
    .apostila-kv { margin:.22rem 0; }
    .apostila-kv strong { color:#0f172a; }

    .apostila-sub-list {
      width:100%;
      border-collapse:collapse;
      margin-top:.5rem;
    }
    .apostila-sub-list th, .apostila-sub-list td {
      padding:.5rem .45rem;
      border-bottom:1px solid #e2e8f0;
      text-align:left;
      vertical-align:top;
      font-size:.92rem;
    }
    .apostila-sub-list th { color:#334155; }
    .apostila-subform {
      margin-top:.65rem;
      border-top:1px dashed #dbeafe;
      padding-top:.65rem;
    }

    @media (max-width: 900px) {
      .apostila-form-grid { grid-template-columns: 1fr; }
      .apostila-requisito-head { flex-direction:column; }
    }
  </style>
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Apostila</h2>
      <p>Selecione a classe e cadastre os requisitos com dicas e subrequisitos.</p>
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Escolha uma classe abaixo e cadastre os requisitos da apostila.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <h3>Classes</h3>
      <div class="apostila-classes">
        {% for item in apostila_classes %}
          <a class="apostila-class-btn {% if item.is_selected %}is-active{% endif %}" href="?classe={{ item.code }}">
            <strong>{{ item.label }}</strong>
            <small>{{ item.idade }} anos</small><br />
            <small>{{ item.total }} requisito(s)</small>
          </a>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <h3>{{ selected_classe_label }}</h3>
      <details>
        <summary><strong>Cadastrar requisito</strong></summary>
        <form method="post" enctype="multipart/form-data" style="margin-top:.85rem;">
          {% csrf_token %}
          <input type="hidden" name="action" value="cadastrar_requisito" />
          <input type="hidden" name="classe" value="{{ selected_classe }}" />

          <div class="apostila-form-grid">
            <label>
              Número do requisito
              <input type="text" name="numero_requisito" value="{{ form_data.numero_requisito|default:'' }}" placeholder="Ex.: 01, 1.2, A-03" required />
            </label>
            <label>
              Resposta (opcional)
              <input type="text" name="resposta" value="{{ form_data.resposta|default:'' }}" placeholder="Ex.: Sim, Concluído, texto livre" />
            </label>
            <label class="full">
              Descrição
              <textarea name="descricao" rows="4" placeholder="Descreva o requisito..." required>{{ form_data.descricao|default:'' }}</textarea>
            </label>
            <label class="full">
              Foto do requisito (opcional)
              <input type="file" name="foto_requisito" accept="image/*" />
            </label>
          </div>
          <div class="apostila-actions">
            <button type="submit" class="primary">Cadastrar</button>
          </div>
        </form>
      </details>
    </section>

    <section class="painel-card">
      <h3>Requisitos cadastrados</h3>
      {% if requisitos %}
        {% for item in requisitos %}
          <article class="apostila-requisito-card">
            <div class="apostila-requisito-head">
              <div class="apostila-requisito-ident">
                {% if item.foto_requisito %}
                  <img src="{{ item.foto_requisito.url }}" alt="Foto do requisito {{ item.numero_requisito }}" class="apostila-requisito-foto" />
                {% endif %}
                <div>
                  <h4>Requisito {{ item.numero_requisito }}</h4>
                  <p class="apostila-kv"><strong>Descrição:</strong> {{ item.descricao }}</p>
                  <p class="apostila-kv"><strong>Resposta:</strong> {{ item.resposta|default:'-' }}</p>
                  {% if item.dicas %}
                    <p class="apostila-kv"><strong>Dica (legado):</strong> {{ item.dicas }}</p>
                  {% endif %}
                </div>
              </div>
              <div class="apostila-meta">
                {% if item.created_by %}
                  {{ item.created_by.username }}<br />
                {% else %}
                  -
                {% endif %}
                {{ item.created_at|date:'d/m/Y H:i' }}
              </div>
            </div>

            <div>
              <strong>Dicas</strong>
              {% if item.dicas_rows_list %}
                <table class="apostila-sub-list">
                  <thead>
                    <tr>
                      <th>Dica</th>
                      <th>Arquivos</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dica in item.dicas_rows_list %}
                      <tr>
                        <td>{{ dica.texto }}</td>
                        <td>
                          {% for arq in dica.arquivos.all %}
                            <a href="{{ arq.arquivo.url }}" target="_blank" rel="noopener">Arquivo {{ forloop.counter }}</a>{% if not forloop.last %}<br />{% endif %}
                          {% empty %}
                            -
                          {% endfor %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <p class="panel-note" style="margin:.35rem 0 0;">Nenhuma dica cadastrada.</p>
              {% endif %}
            </div>

            <details class="apostila-subform">
              <summary><strong>Cadastrar dica</strong></summary>
              <form method="post" enctype="multipart/form-data" style="margin-top:.65rem;">
                {% csrf_token %}
                <input type="hidden" name="action" value="cadastrar_dica" />
                <input type="hidden" name="classe" value="{{ selected_classe }}" />
                <input type="hidden" name="requisito_id" value="{{ item.id }}" />
                <div class="apostila-form-grid">
                  <label class="full">
                    Texto da dica
                    <textarea name="texto_dica" rows="3" placeholder="Ex.: orientar a criança em passos..." required>{% if form_data.dica_requisito_id == item.id|stringformat:'s' %}{{ form_data.dica_texto|default:'' }}{% endif %}</textarea>
                  </label>
                  <label class="full">
                    Arquivos da dica (opcional)
                    <input type="file" name="dica_arquivos" multiple />
                  </label>
                </div>
                <div class="apostila-actions">
                  <button type="submit" class="primary">Cadastrar dica</button>
                </div>
              </form>
            </details>

            <div>
              <strong>Subrequisitos</strong>
              {% if item.subrequisitos_rows %}
                <table class="apostila-sub-list">
                  <thead>
                    <tr>
                      <th>Código</th>
                      <th>Descrição</th>
                      <th>Resposta</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for sub in item.subrequisitos_rows %}
                      <tr>
                        <td>{{ sub.codigo_subrequisito }}</td>
                        <td>{{ sub.descricao }}</td>
                        <td>{{ sub.resposta|default:'-' }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <p class="panel-note" style="margin:.35rem 0 0;">Nenhum subrequisito cadastrado.</p>
              {% endif %}
            </div>

            <details class="apostila-subform">
              <summary><strong>Cadastrar subrequisito</strong></summary>
              <form method="post" style="margin-top:.65rem;">
                {% csrf_token %}
                <input type="hidden" name="action" value="cadastrar_subrequisito" />
                <input type="hidden" name="classe" value="{{ selected_classe }}" />
                <input type="hidden" name="requisito_id" value="{{ item.id }}" />
                <div class="apostila-form-grid">
                  <label>
                    Código do subrequisito
                    <input
                      type="text"
                      name="codigo_subrequisito"
                      placeholder="Ex.: A, B, C"
                      value="{% if form_data.sub_requisito_id == item.id|stringformat:'s' %}{{ form_data.sub_codigo|default:'' }}{% endif %}"
                      required
                    />
                  </label>
                  <label>
                    Resposta (opcional)
                    <input
                      type="text"
                      name="resposta_subrequisito"
                      placeholder="Ex.: Feito, Sim, texto livre"
                      value="{% if form_data.sub_requisito_id == item.id|stringformat:'s' %}{{ form_data.sub_resposta|default:'' }}{% endif %}"
                    />
                  </label>
                  <label class="full">
                    Descrição do subrequisito
                    <textarea
                      name="descricao_subrequisito"
                      rows="3"
                      placeholder="Descreva o subrequisito..."
                      required
                    >{% if form_data.sub_requisito_id == item.id|stringformat:'s' %}{{ form_data.sub_descricao|default:'' }}{% endif %}</textarea>
                  </label>
                </div>
                <div class="apostila-actions">
                  <button type="submit" class="primary">Cadastrar subrequisito</button>
                </div>
              </form>
            </details>
          </article>
        {% endfor %}
      {% else %}
        <p class="panel-note">Nenhum requisito cadastrado para esta classe.</p>
      {% endif %}
    </section>
  </main>
</body>
</html>
