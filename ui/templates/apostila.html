<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apostila</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .apostila-classes { display:grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap:.75rem; }
    .apostila-passos { margin:.25rem 0 0; padding-left:1.15rem; color:#334155; }
    .apostila-passos li { margin:.3rem 0; }

    .apostila-class-btn {
      display:block;
      padding:.85rem;
      border:1px solid #dbeafe;
      border-radius:12px;
      text-decoration:none;
      color:#0f172a;
      background:#f8fbff;
    }
    .apostila-class-btn.is-active { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37, 99, 235, .14); background:#eff6ff; }
    .apostila-class-btn strong { display:block; margin-bottom:.15rem; }
    .apostila-class-btn small { color:#475569; }

    .apostila-toolbar {
      margin-top:.2rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.8rem;
      flex-wrap:wrap;
    }

    .apostila-btn {
      border:1px solid #2563eb;
      background:#2563eb;
      color:#fff;
      border-radius:10px;
      padding:.58rem .9rem;
      font:inherit;
      font-weight:600;
      cursor:pointer;
    }
    .apostila-btn.secondary {
      border:1px solid #cbd5e1;
      background:#fff;
      color:#0f172a;
      font-weight:500;
    }

    .apostila-form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
    .apostila-form-grid .full { grid-column:1 / -1; }
    .apostila-form-grid label { display:flex; flex-direction:column; gap:.35rem; font-size:.9rem; color:#334155; font-weight:600; }
    .apostila-form-grid input, .apostila-form-grid textarea {
      width:100%;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:.72rem .85rem;
      font:inherit;
    }
    .apostila-actions { margin-top:.9rem; display:flex; justify-content:flex-end; }

    .apostila-requisito-card {
      border:1px solid #dbeafe;
      border-radius:14px;
      background:#fff;
      padding:.9rem;
    }
    .apostila-requisito-card + .apostila-requisito-card { margin-top:.8rem; }
    .apostila-requisito-head {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.8rem;
      margin-bottom:.6rem;
    }
    .apostila-requisito-ident { display:flex; gap:.7rem; align-items:flex-start; }
    .apostila-requisito-foto {
      width:68px;
      height:68px;
      border-radius:10px;
      object-fit:cover;
      border:1px solid #dbeafe;
      background:#f8fafc;
      flex-shrink:0;
    }
    .apostila-requisito-foto-btn {
      border:0;
      padding:0;
      background:transparent;
      cursor:pointer;
      border-radius:10px;
      line-height:0;
    }
    .apostila-requisito-foto-btn:focus-visible {
      outline:2px solid #2563eb;
      outline-offset:2px;
    }
    .apostila-requisito-head h4 { margin:0; }
    .apostila-meta { color:#64748b; font-size:.82rem; }
    .apostila-kv { margin:.22rem 0; }
    .apostila-kv strong { color:#0f172a; }

    .apostila-sub-list {
      width:100%;
      border-collapse:collapse;
      margin-top:.5rem;
    }
    .apostila-sub-list th, .apostila-sub-list td {
      padding:.5rem .45rem;
      border-bottom:1px solid #e2e8f0;
      text-align:left;
      vertical-align:top;
      font-size:.92rem;
    }
    .apostila-sub-list th { color:#334155; }
    .apostila-sub-actions {
      margin-top:.65rem;
      border-top:1px dashed #dbeafe;
      padding-top:.65rem;
    }

    .apostila-modal,
    .apostila-foto-modal {
      position:fixed;
      inset:0;
      background:rgba(15, 23, 42, .72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:998;
      padding:1rem;
    }
    .apostila-modal.is-open,
    .apostila-foto-modal.is-open { display:flex; }

    .apostila-modal-dialog,
    .apostila-foto-dialog {
      width:min(760px, 96vw);
      max-height:92vh;
      background:#fff;
      border-radius:14px;
      overflow:auto;
      box-shadow:0 30px 80px rgba(0, 0, 0, .35);
      display:flex;
      flex-direction:column;
    }
    .apostila-foto-dialog { width:min(960px, 96vw); overflow:hidden; }

    .apostila-modal-head,
    .apostila-foto-head {
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      padding:.8rem .9rem;
      border-bottom:1px solid #e2e8f0;
    }
    .apostila-modal-title,
    .apostila-foto-title { margin:0; font-size:1rem; }
    .apostila-modal-body { padding:.9rem; }
    .apostila-modal-note { margin:.2rem 0 .75rem; color:#475569; }

    .apostila-foto-body {
      padding:.75rem;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:240px;
      background:#f8fafc;
    }
    .apostila-foto-body img {
      max-width:100%;
      max-height:78vh;
      object-fit:contain;
      border-radius:10px;
      background:#fff;
    }

    @media (max-width: 900px) {
      .apostila-form-grid { grid-template-columns: 1fr; }
      .apostila-requisito-head { flex-direction:column; }
      .apostila-modal-dialog,
      .apostila-foto-dialog { width:100%; max-height:95vh; border-radius:12px; }
    }
  </style>
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Apostila</h2>
      <p>Use os passos abaixo para montar a apostila da classe sem confusão.</p>
    </header>

    <section class="painel-card">
      <h3>Passo a passo</h3>
      <ol class="apostila-passos">
        <li>Escolha a classe.</li>
        <li>Clique em <strong>Adicionar novo requisito</strong> para abrir a janela de cadastro.</li>
        <li>Dentro do requisito, clique em <strong>Adicionar dica neste requisito</strong> para abrir a janela de dicas.</li>
      </ol>
    </section>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Passo 1: escolha uma classe. Passo 2: adicione um requisito.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <h3>Classes</h3>
      <div class="apostila-classes">
        {% for item in apostila_classes %}
          <a class="apostila-class-btn {% if item.is_selected %}is-active{% endif %}" href="?classe={{ item.code }}">
            <strong>{{ item.label }}</strong>
            <small>{{ item.idade }} anos</small><br />
            <small>{{ item.total }} requisito(s)</small>
          </a>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <h3>{{ selected_classe_label }}</h3>
      <div class="apostila-toolbar">
        <p class="panel-note" style="margin:0;">Abra o cadastro em janela suspensa para manter a tela organizada.</p>
        <button type="button" class="apostila-btn" id="apostilaOpenRequisitoModal">Adicionar novo requisito</button>
      </div>
    </section>

    <section class="painel-card">
      <h3>Requisitos cadastrados</h3>
      {% if requisitos %}
        {% for item in requisitos %}
          <article class="apostila-requisito-card">
            <div class="apostila-requisito-head">
              <div class="apostila-requisito-ident">
                {% if item.foto_requisito %}
                  <button
                    type="button"
                    class="apostila-requisito-foto-btn"
                    data-apostila-foto-open
                    data-foto-src="{{ item.foto_requisito.url }}"
                    data-foto-title="Requisito {{ item.numero_requisito }}"
                    aria-label="Ampliar foto do requisito {{ item.numero_requisito }}"
                  >
                    <img src="{{ item.foto_requisito.url }}" alt="Foto do requisito {{ item.numero_requisito }}" class="apostila-requisito-foto" />
                  </button>
                {% endif %}
                <div>
                  <h4>Requisito {{ item.numero_requisito }}</h4>
                  <p class="apostila-kv"><strong>Descrição:</strong> {{ item.descricao }}</p>
                  <p class="apostila-kv"><strong>Resposta:</strong> {{ item.resposta|default:'-' }}</p>
                  {% if item.dicas %}
                    <p class="apostila-kv"><strong>Dica (legado):</strong> {{ item.dicas }}</p>
                  {% endif %}
                </div>
              </div>
              <div class="apostila-meta">
                {% if item.created_by %}
                  {{ item.created_by.username }}<br />
                {% else %}
                  -
                {% endif %}
                {{ item.created_at|date:'d/m/Y H:i' }}
              </div>
            </div>

            <div>
              <strong>Dicas</strong>
              {% if item.dicas_rows_list %}
                <table class="apostila-sub-list">
                  <thead>
                    <tr>
                      <th>Dica</th>
                      <th>Arquivos</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dica in item.dicas_rows_list %}
                      <tr>
                        <td>{{ dica.texto }}</td>
                        <td>
                          {% for arq in dica.arquivos.all %}
                            <a href="{{ arq.arquivo.url }}" target="_blank" rel="noopener">Arquivo {{ forloop.counter }}</a>{% if not forloop.last %}<br />{% endif %}
                          {% empty %}
                            -
                          {% endfor %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <p class="panel-note" style="margin:.35rem 0 0;">Nenhuma dica cadastrada.</p>
              {% endif %}
            </div>

            <div class="apostila-sub-actions">
              <button
                type="button"
                class="apostila-btn secondary"
                data-apostila-open-dica
                data-requisito-id="{{ item.id }}"
                data-requisito-label="Requisito {{ item.numero_requisito }}"
              >
                Adicionar dica neste requisito
              </button>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <p class="panel-note">Nenhum requisito cadastrado para esta classe.</p>
      {% endif %}
    </section>
  </main>

  <div class="apostila-modal" id="apostilaRequisitoModal" aria-hidden="true">
    <div class="apostila-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="apostilaRequisitoModalTitle">
      <div class="apostila-modal-head">
        <h3 class="apostila-modal-title" id="apostilaRequisitoModalTitle">Adicionar novo requisito</h3>
        <button type="button" class="apostila-btn secondary" id="apostilaCloseRequisitoModal">Fechar</button>
      </div>
      <div class="apostila-modal-body">
        <p class="apostila-modal-note">Preencha os dados e clique em <strong>Salvar requisito</strong>.</p>
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="action" value="cadastrar_requisito" />
          <input type="hidden" name="classe" value="{{ selected_classe }}" />

          <div class="apostila-form-grid">
            <label>
              Número do requisito
              <input type="text" name="numero_requisito" value="{{ form_data.numero_requisito|default:'' }}" placeholder="Ex.: 01, 1.2, A-03" required />
            </label>
            <label>
              Resposta (opcional)
              <input type="text" name="resposta" value="{{ form_data.resposta|default:'' }}" placeholder="Ex.: Sim, Concluído, texto livre" />
            </label>
            <label class="full">
              Descrição
              <textarea name="descricao" rows="4" placeholder="Descreva o requisito..." required>{{ form_data.descricao|default:'' }}</textarea>
            </label>
            <label class="full">
              Foto do requisito (opcional)
              <input type="file" name="foto_requisito" accept="image/*" />
            </label>
          </div>
          <div class="apostila-actions">
            <button type="submit" class="apostila-btn">Salvar requisito</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="apostila-modal" id="apostilaDicaModal" aria-hidden="true">
    <div class="apostila-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="apostilaDicaModalTitle">
      <div class="apostila-modal-head">
        <h3 class="apostila-modal-title" id="apostilaDicaModalTitle">Adicionar dica</h3>
        <button type="button" class="apostila-btn secondary" id="apostilaCloseDicaModal">Fechar</button>
      </div>
      <div class="apostila-modal-body">
        <p class="apostila-modal-note">Cadastre a dica e, se quiser, anexe arquivos.</p>
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="action" value="cadastrar_dica" />
          <input type="hidden" name="classe" value="{{ selected_classe }}" />
          <input type="hidden" name="requisito_id" id="apostilaDicaRequisitoId" value="{{ form_data.dica_requisito_id|default:'' }}" />

          <div class="apostila-form-grid">
            <label class="full">
              Requisito selecionado
              <input type="text" id="apostilaDicaRequisitoLabel" value="" readonly />
            </label>
            <label class="full">
              Texto da dica
              <textarea name="texto_dica" rows="3" placeholder="Ex.: orientar a criança em passos..." required>{{ form_data.dica_texto|default:'' }}</textarea>
            </label>
            <label class="full">
              Arquivos da dica (opcional)
              <input type="file" name="dica_arquivos" multiple />
            </label>
          </div>
          <div class="apostila-actions">
            <button type="submit" class="apostila-btn">Salvar dica</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="apostila-foto-modal" id="apostilaFotoModal" aria-hidden="true">
    <div class="apostila-foto-dialog" role="dialog" aria-modal="true" aria-labelledby="apostilaFotoModalTitle">
      <div class="apostila-foto-head">
        <h3 class="apostila-foto-title" id="apostilaFotoModalTitle">Foto do requisito</h3>
        <button type="button" class="apostila-btn secondary" id="apostilaFotoModalClose">Fechar</button>
      </div>
      <div class="apostila-foto-body">
        <img id="apostilaFotoModalImage" alt="Foto ampliada do requisito" />
      </div>
    </div>
  </div>

  <script>
    (function () {
      const requisitoModal = document.getElementById('apostilaRequisitoModal');
      const openRequisitoBtn = document.getElementById('apostilaOpenRequisitoModal');
      const closeRequisitoBtn = document.getElementById('apostilaCloseRequisitoModal');

      const dicaModal = document.getElementById('apostilaDicaModal');
      const closeDicaBtn = document.getElementById('apostilaCloseDicaModal');
      const dicaReqIdInput = document.getElementById('apostilaDicaRequisitoId');
      const dicaReqLabelInput = document.getElementById('apostilaDicaRequisitoLabel');

      const fotoModal = document.getElementById('apostilaFotoModal');
      const fotoModalImage = document.getElementById('apostilaFotoModalImage');
      const fotoModalTitle = document.getElementById('apostilaFotoModalTitle');
      const closeFotoBtn = document.getElementById('apostilaFotoModalClose');

      const allModals = [requisitoModal, dicaModal, fotoModal].filter(Boolean);

      const lockScroll = () => {
        if (allModals.some((m) => m.classList.contains('is-open'))) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      };

      const openModal = (modal) => {
        if (!modal) return;
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        lockScroll();
      };

      const closeModal = (modal) => {
        if (!modal) return;
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        lockScroll();
      };

      if (openRequisitoBtn) {
        openRequisitoBtn.addEventListener('click', () => openModal(requisitoModal));
      }
      if (closeRequisitoBtn) {
        closeRequisitoBtn.addEventListener('click', () => closeModal(requisitoModal));
      }

      const requisitoMap = {};
      document.querySelectorAll('[data-apostila-open-dica]').forEach((btn) => {
        const reqId = btn.getAttribute('data-requisito-id') || '';
        const reqLabel = btn.getAttribute('data-requisito-label') || '';
        if (reqId) requisitoMap[reqId] = reqLabel;

        btn.addEventListener('click', () => {
          if (dicaReqIdInput) dicaReqIdInput.value = reqId;
          if (dicaReqLabelInput) dicaReqLabelInput.value = reqLabel || ('Requisito #' + reqId);
          openModal(dicaModal);
        });
      });

      if (closeDicaBtn) {
        closeDicaBtn.addEventListener('click', () => closeModal(dicaModal));
      }

      document.querySelectorAll('[data-apostila-foto-open]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const src = btn.getAttribute('data-foto-src') || '';
          const title = btn.getAttribute('data-foto-title') || 'Foto do requisito';
          if (!src || !fotoModalImage || !fotoModalTitle) return;
          fotoModalImage.src = src;
          fotoModalTitle.textContent = title;
          openModal(fotoModal);
        });
      });

      if (closeFotoBtn) {
        closeFotoBtn.addEventListener('click', () => {
          closeModal(fotoModal);
          if (fotoModalImage) fotoModalImage.removeAttribute('src');
        });
      }

      allModals.forEach((modal) => {
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal(modal);
            if (modal === fotoModal && fotoModalImage) fotoModalImage.removeAttribute('src');
          }
        });
      });

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        allModals.forEach((modal) => {
          if (modal.classList.contains('is-open')) closeModal(modal);
        });
        if (fotoModalImage) fotoModalImage.removeAttribute('src');
      });

      const hasRequisitoFormData = !!("{{ form_data.numero_requisito|default:'' }}".trim() || "{{ form_data.descricao|default:'' }}".trim());
      if (hasRequisitoFormData) {
        openModal(requisitoModal);
      }

      const initialDicaReqId = ("{{ form_data.dica_requisito_id|default:'' }}" || '').trim();
      if (initialDicaReqId) {
        if (dicaReqIdInput) dicaReqIdInput.value = initialDicaReqId;
        if (dicaReqLabelInput) dicaReqLabelInput.value = requisitoMap[initialDicaReqId] || ('Requisito #' + initialDicaReqId);
        openModal(dicaModal);
      }
    })();
  </script>
</body>
</html>
