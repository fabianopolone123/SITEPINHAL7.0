<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financeiro</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .financeiro-tabs { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:1rem; }
    .financeiro-tab {
      display:inline-flex; align-items:center; justify-content:center;
      padding:.65rem .9rem; border-radius:10px; border:1px solid #cbd5e1;
      background:#fff; color:#0f172a; text-decoration:none; font-weight:600;
    }
    .financeiro-tab.is-active {
      background:#0f172a; color:#fff; border-color:#0f172a;
    }
    .financeiro-grid { display:grid; grid-template-columns: 1.2fr .55fr auto; gap:.75rem; align-items:end; }
    .financeiro-grid label { font-size:.9rem; color:#334155; }
    .financeiro-grid select, .financeiro-grid input { width:100%; padding:.75rem .85rem; border:1px solid #cbd5e1; border-radius:10px; }
    .mensalidades-list { margin-top: 1rem; }
    .mensalidades-list table { width:100%; border-collapse: collapse; }
    .mensalidades-list th, .mensalidades-list td { padding:.7rem .6rem; border-bottom:1px solid #e2e8f0; text-align:left; }
    .badge-status {
      display:inline-flex; padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:700;
      background:#fef3c7; color:#92400e; border:1px solid #fcd34d;
    }
    .financeiro-scroll { overflow:auto; margin-top:1rem; }
    .resumo-mensalidades { width:100%; min-width:980px; border-collapse:collapse; }
    .resumo-mensalidades th, .resumo-mensalidades td { padding:.55rem .45rem; border-bottom:1px solid #e2e8f0; text-align:center; white-space:nowrap; }
    .resumo-mensalidades th:first-child, .resumo-mensalidades td:first-child { text-align:left; position:sticky; left:0; background:#fff; z-index:1; }
    .resumo-mensalidades small { display:block; color:#64748b; }
    .cell-filled { display:inline-flex; padding:.18rem .45rem; border-radius:8px; background:#eff6ff; color:#1d4ed8; font-weight:600; }
    .cell-clickable, .mensalidade-open {
      border:0; background:none; padding:0; margin:0; cursor:pointer; color:inherit; font:inherit;
    }
    .cell-clickable:hover .cell-filled, .mensalidade-open:hover { filter:brightness(.95); }
    .mensalidade-open { text-decoration:underline; text-underline-offset:2px; }
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(15,23,42,.55); display:none; align-items:center; justify-content:center;
      padding:1rem; z-index:1000;
    }
    .modal-backdrop.is-open { display:flex; }
    .modal-card {
      width:min(100%, 440px); background:#fff; border-radius:14px; border:1px solid #cbd5e1; box-shadow:0 18px 40px rgba(15,23,42,.2);
      padding:1rem;
    }
    .modal-card h3 { margin:.1rem 0 .35rem; }
    .modal-card p { margin:.15rem 0 .85rem; color:#475569; }
    .modal-card label { display:block; font-size:.9rem; color:#334155; margin-bottom:.3rem; }
    .modal-card input {
      width:100%; padding:.75rem .85rem; border:1px solid #cbd5e1; border-radius:10px; margin-bottom:.9rem;
    }
    .modal-actions { display:flex; gap:.5rem; justify-content:flex-end; flex-wrap:wrap; }
    .modal-actions button {
      padding:.65rem .9rem; border-radius:10px; border:1px solid #cbd5e1; background:#fff; cursor:pointer;
    }
    .modal-actions .danger { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .modal-actions .primary { border-color:#0f172a; background:#0f172a; color:#fff; }
    .modal-actions .ghost { background:#fff; color:#0f172a; }
    @media (max-width: 768px) {
      .financeiro-grid { grid-template-columns: 1fr; }
      .financeiro-grid .primary { width:100%; }
    }
  </style>
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Financeiro</h2>
      <p>Módulo inicial para geração e visualização de mensalidades.</p>
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Selecione um aventureiro e clique em gerar mensalidades.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <div class="financeiro-tabs" role="tablist" aria-label="Seções do financeiro">
        <a class="financeiro-tab is-active" href="{% url 'accounts:financeiro' %}" aria-current="page">Mensalidades</a>
      </div>

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="gerar_mensalidades" />
        <div class="financeiro-grid">
          <div>
            <label for="aventureiro_id">Aventureiro</label>
            <select id="aventureiro_id" name="aventureiro_id" required>
              <option value="">Selecione...</option>
              {% for av in aventureiros %}
                <option value="{{ av.pk }}"{% if selected_aventureiro_id == av.pk|stringformat:'s' %} selected{% endif %}>
                  {{ av.nome }}{% if av.responsavel and av.responsavel.user %} (Resp.: {{ av.responsavel.user.username }}){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="valor_mensalidade">Valor</label>
            <input id="valor_mensalidade" name="valor_mensalidade" type="text" value="{{ valor_mensalidade|default:'35' }}" inputmode="decimal" />
          </div>
          <button type="submit" class="primary">Gerar mensalidades</button>
        </div>
      </form>

      <div class="mensalidades-list">
        {% if selected_aventureiro %}
          <h3 style="margin-bottom:.75rem;">{{ selected_aventureiro.nome }}</h3>
          {% if mensalidades %}
            <table>
              <thead>
                <tr>
                  <th>Competência</th>
                  <th>Valor</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for item in mensalidades %}
                  <tr>
                    <td>{{ item.competencia }}</td>
                    <td>
                      <button
                        type="button"
                        class="mensalidade-open"
                        data-mensalidade-open
                        data-id="{{ item.id }}"
                        data-aventureiro-id="{{ selected_aventureiro_id }}"
                        data-competencia="{{ item.competencia }}"
                        data-valor="{{ item.valor_raw }}"
                      >
                        {{ item.valor }}
                      </button>
                    </td>
                    <td><span class="badge-status">{{ item.status }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="panel-note">Nenhuma mensalidade gerada ainda para este aventureiro.</p>
          {% endif %}
        {% else %}
          <p class="panel-note">A listagem das mensalidades aparecerá abaixo após selecionar um aventureiro.</p>
        {% endif %}
      </div>

      <div class="mensalidades-list">
        <h3 style="margin-top:1.25rem;">Aventureiros com mensalidades ({{ resumo_ano }})</h3>
        {% if resumo_rows %}
          <div class="financeiro-scroll">
            <table class="resumo-mensalidades">
              <thead>
                <tr>
                  <th>Aventureiro</th>
                  {% for mes in resumo_meses %}
                    <th>{{ mes }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in resumo_rows %}
                  <tr>
                    <td>
                      {{ row.aventureiro_nome }}
                      {% if row.responsavel_username %}<small>Resp.: {{ row.responsavel_username }}</small>{% endif %}
                    </td>
                    {% for cell in row.cells %}
                      <td>
                        {% if cell.filled %}
                          <button
                            type="button"
                            class="cell-clickable"
                            data-mensalidade-open
                            data-id="{{ cell.id }}"
                            data-aventureiro-id="{{ row.aventureiro_id }}"
                            data-competencia="{{ cell.competencia }}"
                            data-valor="{{ cell.valor_raw }}"
                            aria-label="Editar mensalidade {{ cell.competencia }}"
                          >
                            <span class="cell-filled">{{ cell.label }}</span>
                          </button>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="panel-note">Nenhum aventureiro possui mensalidades cadastradas no ano atual.</p>
        {% endif %}
      </div>
    </section>
  </main>

  <div class="modal-backdrop" id="mensalidadeModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="mensalidadeModalTitle">
      <h3 id="mensalidadeModalTitle">Editar mensalidade</h3>
      <p id="mensalidadeModalSubtitle">Altere o valor ou exclua a mensalidade selecionada.</p>
      <form method="post" id="mensalidadeModalForm">
        {% csrf_token %}
        <input type="hidden" name="action" id="mensalidadeModalAction" value="editar_mensalidade" />
        <input type="hidden" name="mensalidade_id" id="mensalidadeModalId" />
        <input type="hidden" name="aventureiro_id" id="mensalidadeModalAventureiroId" />
        <input type="hidden" name="valor_mensalidade" id="mensalidadeModalValorTela" value="{{ valor_mensalidade|default:'35' }}" />
        <label for="mensalidadeModalValor">Valor da mensalidade</label>
        <input id="mensalidadeModalValor" name="valor_mensalidade_edicao" type="text" inputmode="decimal" required />
        <div class="modal-actions">
          <button type="button" class="ghost" id="mensalidadeModalCancelar">Cancelar</button>
          <button type="submit" class="danger" id="mensalidadeModalExcluir">Excluir</button>
          <button type="submit" class="primary" id="mensalidadeModalSalvar">Salvar valor</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById('mensalidadeModal');
      const form = document.getElementById('mensalidadeModalForm');
      const actionInput = document.getElementById('mensalidadeModalAction');
      const idInput = document.getElementById('mensalidadeModalId');
      const aventureiroInput = document.getElementById('mensalidadeModalAventureiroId');
      const valorInput = document.getElementById('mensalidadeModalValor');
      const valorTelaInput = document.getElementById('mensalidadeModalValorTela');
      const subtitle = document.getElementById('mensalidadeModalSubtitle');
      const cancelBtn = document.getElementById('mensalidadeModalCancelar');
      const salvarBtn = document.getElementById('mensalidadeModalSalvar');
      const excluirBtn = document.getElementById('mensalidadeModalExcluir');
      const seletorValorTela = document.getElementById('valor_mensalidade');

      function openModal(trigger) {
        idInput.value = trigger.dataset.id || '';
        aventureiroInput.value = trigger.dataset.aventureiroId || '';
        valorInput.value = trigger.dataset.valor || '';
        subtitle.textContent = 'Mensalidade: ' + (trigger.dataset.competencia || '');
        actionInput.value = 'editar_mensalidade';
        valorInput.required = true;
        if (seletorValorTela) {
          valorTelaInput.value = seletorValorTela.value || '35';
        }
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        window.setTimeout(function () {
          valorInput.focus();
          valorInput.select();
        }, 0);
      }

      function closeModal() {
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        actionInput.value = 'editar_mensalidade';
        valorInput.required = true;
      }

      document.querySelectorAll('[data-mensalidade-open]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          openModal(btn);
        });
      });

      cancelBtn.addEventListener('click', closeModal);

      modal.addEventListener('click', function (event) {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && modal.classList.contains('is-open')) {
          closeModal();
        }
      });

      salvarBtn.addEventListener('click', function () {
        actionInput.value = 'editar_mensalidade';
        valorInput.required = true;
      });

      excluirBtn.addEventListener('click', function (event) {
        if (!window.confirm('Deseja excluir esta mensalidade?')) {
          event.preventDefault();
          return;
        }
        actionInput.value = 'excluir_mensalidade';
        valorInput.required = false;
      });
    })();
  </script>
</body>
</html>
