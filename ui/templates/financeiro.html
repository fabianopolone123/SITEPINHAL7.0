<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financeiro</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .financeiro-tabs { display:flex; gap:.6rem; flex-wrap:wrap; margin-bottom:1rem; }
    .financeiro-tab {
      display:inline-flex; align-items:center; justify-content:center;
      padding:.65rem .9rem; border-radius:10px; border:1px solid #cbd5e1;
      background:#fff; color:#0f172a; text-decoration:none; font-weight:600;
    }
    .financeiro-tab.is-active {
      background:#0f172a; color:#fff; border-color:#0f172a;
    }
    .financeiro-grid { display:grid; grid-template-columns: 1.2fr .55fr auto; gap:.75rem; align-items:end; }
    .financeiro-grid label { font-size:.9rem; color:#334155; }
    .financeiro-grid select, .financeiro-grid input { width:100%; padding:.75rem .85rem; border:1px solid #cbd5e1; border-radius:10px; }
    .mensalidades-list { margin-top: 1rem; }
    .mensalidades-list table { width:100%; border-collapse: collapse; }
    .mensalidades-list th, .mensalidades-list td { padding:.7rem .6rem; border-bottom:1px solid #e2e8f0; text-align:left; }
    .responsavel-financeiro table { width:100%; border-collapse: collapse; }
    .responsavel-financeiro th, .responsavel-financeiro td { padding:.75rem .6rem; border-bottom:1px solid #e2e8f0; vertical-align:top; text-align:left; }
    .mensalidade-checks { display:flex; flex-wrap:wrap; gap:.55rem; }
    .mensalidade-checks label {
      display:flex; align-items:center; gap:.4rem; padding:.45rem .55rem; border:1px solid #dbeafe; background:#f8fbff;
      border-radius:10px; font-size:.9rem;
    }
    .mensalidade-checks small { color:#64748b; }
    .tag-atrasada { color:#b45309; font-weight:700; }
    .financeiro-actions { margin-top:1rem; display:flex; justify-content:flex-end; }
    .financeiro-actions-wrap { margin-top:1rem; display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
    .financeiro-total-selecionado {
      display:inline-flex; align-items:center; gap:.35rem; padding:.55rem .7rem;
      border:1px solid #cbd5e1; border-radius:10px; background:#f8fafc; color:#0f172a; font-weight:600;
    }
    .financeiro-total-selecionado small { color:#64748b; font-weight:500; }
    .financeiro-actions .primary[disabled] { opacity:.8; cursor:not-allowed; }
    .badge-status {
      display:inline-flex; padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:700;
      background:#fef3c7; color:#92400e; border:1px solid #fcd34d;
    }
    .badge-status.is-paid { background:#ecfdf5; color:#166534; border-color:#bbf7d0; }
    .financeiro-scroll { overflow:auto; margin-top:1rem; }
    .resumo-mensalidades { width:100%; min-width:980px; border-collapse:collapse; }
    .resumo-mensalidades th, .resumo-mensalidades td { padding:.55rem .45rem; border-bottom:1px solid #e2e8f0; text-align:center; white-space:nowrap; }
    .resumo-mensalidades th:first-child, .resumo-mensalidades td:first-child { text-align:left; position:sticky; left:0; background:#fff; z-index:1; }
    .resumo-mensalidades small { display:block; color:#64748b; }
    .cell-filled { display:inline-flex; padding:.18rem .45rem; border-radius:8px; background:#eff6ff; color:#1d4ed8; font-weight:600; }
    .cell-filled.is-paid { background:#ecfdf5; color:#166534; }
    .cell-clickable, .mensalidade-open {
      border:0; background:none; padding:0; margin:0; cursor:pointer; color:inherit; font:inherit;
    }
    .cell-clickable:hover .cell-filled, .mensalidade-open:hover { filter:brightness(.95); }
    .mensalidade-open { text-decoration:underline; text-underline-offset:2px; }
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(15,23,42,.55); display:none; align-items:center; justify-content:center;
      padding:1rem; z-index:1000;
    }
    .modal-backdrop.is-open { display:flex; }
    .modal-card {
      width:min(100%, 440px); background:#fff; border-radius:14px; border:1px solid #cbd5e1; box-shadow:0 18px 40px rgba(15,23,42,.2);
      padding:1rem;
    }
    .modal-card h3 { margin:.1rem 0 .35rem; }
    .modal-card p { margin:.15rem 0 .85rem; color:#475569; }
    .modal-card label { display:block; font-size:.9rem; color:#334155; margin-bottom:.3rem; }
    .modal-card input {
      width:100%; padding:.75rem .85rem; border:1px solid #cbd5e1; border-radius:10px; margin-bottom:.9rem;
    }
    .modal-actions { display:flex; gap:.5rem; justify-content:flex-end; flex-wrap:wrap; }
    .modal-actions button {
      padding:.65rem .9rem; border-radius:10px; border:1px solid #cbd5e1; background:#fff; cursor:pointer;
    }
    .modal-actions .danger { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .modal-actions .primary { border-color:#0f172a; background:#0f172a; color:#fff; }
    .modal-actions .ghost { background:#fff; color:#0f172a; }
    .pix-modal-qr { width:min(100%, 260px); display:block; margin:.6rem auto; border:1px solid #e2e8f0; border-radius:12px; background:#fff; }
    .pix-code-box {
      width:100%; min-height:88px; padding:.7rem .8rem; border:1px solid #cbd5e1; border-radius:10px;
      font-family:Consolas, monospace; font-size:.82rem; line-height:1.35; resize:vertical;
    }
    .pix-status-box {
      margin:.5rem 0 .8rem; padding:.55rem .65rem; border-radius:10px; border:1px solid #dbeafe; background:#f8fbff; color:#1e3a8a;
      font-weight:600;
    }
    .pix-status-box.is-paid { background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
    .pix-modal-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:.45rem; }
    .pix-modal-row small { color:#64748b; }
    @media (max-width: 768px) {
      .financeiro-grid { grid-template-columns: 1fr; }
      .financeiro-grid .primary { width:100%; }
    }
  </style>
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Financeiro</h2>
      <p>Módulo inicial para geração e visualização de mensalidades.</p>
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Selecione um aventureiro e clique em gerar mensalidades.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <div class="financeiro-tabs" role="tablist" aria-label="Seções do financeiro">
        <a class="financeiro-tab is-active" href="{% url 'accounts:financeiro' %}" aria-current="page">Mensalidades</a>
      </div>

      {% if financeiro_mode == 'responsavel' %}
      <div class="responsavel-financeiro">
        <p class="panel-note">
          Selecione as mensalidades pendentes dos seus aventureiros para pagamento.
          {% if responsavel_incluir_ano_todo %}
            Estão sendo exibidas as mensalidades pendentes atrasadas e também as futuras do ano {{ ano_atual }}.
          {% else %}
            São exibidas apenas mensalidades atrasadas e do mês atual ({{ mes_atual_label }}/{{ ano_atual }}).
          {% endif %}
        </p>

        <form method="get" style="margin:.55rem 0 1rem;">
          <label style="display:inline-flex; align-items:center; gap:.45rem; font-weight:600; color:#0f172a;">
            <input type="checkbox" name="incluir_ano_todo" value="1" {% if responsavel_incluir_ano_todo %}checked{% endif %} onchange="this.form.submit();" />
            Incluir também mensalidades futuras do ano ({{ ano_atual }})
          </label>
        </form>

        {% if responsavel_rows %}
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="pagar_mensalidades" />
            <input type="hidden" name="incluir_ano_todo" value="{% if responsavel_incluir_ano_todo %}1{% else %}0{% endif %}" />
            <table>
              <thead>
                <tr>
                  <th>Aventureiro</th>
                  <th>Mensalidades pendentes</th>
                </tr>
              </thead>
              <tbody>
                {% for row in responsavel_rows %}
                  <tr>
                    <td>{{ row.aventureiro_nome }}</td>
                    <td>
                      <div class="mensalidade-checks">
                        {% for item in row.mensalidades %}
                          <label>
                            <input type="checkbox" name="mensalidades_ids" value="{{ item.id }}" data-valor="{{ item.valor }}" />
                            <span>{{ item.competencia }}</span>
                            <small>{{ item.valor }}</small>
                            {% if item.is_atrasada %}<small class="tag-atrasada">Atrasada</small>{% endif %}
                          </label>
                        {% endfor %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="financeiro-actions-wrap">
              <div class="financeiro-total-selecionado" id="financeiroTotalSelecionado" aria-live="polite">
                <small>Total selecionado:</small>
                <span id="financeiroTotalSelecionadoValor">R$ 0,00</span>
              </div>
              <div class="financeiro-actions">
                <button type="button" class="secondary" id="financeiroSelecionarTodas">Selecionar todas</button>
                <button type="button" class="secondary" id="financeiroLimparSelecao">Limpar</button>
                <button type="submit" class="primary">Pagar</button>
              </div>
            </div>
          </form>
        {% elif responsavel_tem_aventureiros %}
          <p class="panel-note">Nenhuma mensalidade pendente (atrasada ou do mês atual) foi encontrada para seus aventureiros.</p>
          <div class="financeiro-actions">
            <button type="button" class="primary" disabled>Pagar</button>
          </div>
        {% else %}
          <p class="panel-note">Nenhum aventureiro vinculado ao seu usuário de responsável.</p>
        {% endif %}
      </div>
      {% else %}
      <form method="post">
        {% csrf_token %}
        <div class="financeiro-grid">
          <div>
            <label for="aventureiro_id">Aventureiro</label>
            <select id="aventureiro_id" name="aventureiro_id" required>
              <option value="">Selecione...</option>
              {% for av in aventureiros %}
                <option value="{{ av.pk }}"{% if selected_aventureiro_id == av.pk|stringformat:'s' %} selected{% endif %}>
                  {{ av.nome }}{% if av.responsavel and av.responsavel.user %} (Resp.: {{ av.responsavel.user.username }}){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="valor_mensalidade">Valor</label>
            <input id="valor_mensalidade" name="valor_mensalidade" type="text" value="{{ valor_mensalidade|default:'30' }}" inputmode="decimal" />
          </div>
          <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <button type="submit" class="primary" name="action" value="gerar_mensalidades">Gerar mensalidades</button>
            <button type="submit" class="secondary" name="action" value="gerar_mensalidades_todos" formnovalidate>Gerar para todos</button>
          </div>
        </div>
      </form>

      <div class="mensalidades-list">
        {% if selected_aventureiro %}
          <h3 style="margin-bottom:.75rem;">{{ selected_aventureiro.nome }}</h3>
          {% if mensalidades %}
            <table>
              <thead>
                <tr>
                  <th>Competência</th>
                  <th>Valor</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for item in mensalidades %}
                  <tr>
                    <td>{{ item.competencia }}</td>
                    <td>
                      <button
                        type="button"
                        class="mensalidade-open"
                        data-mensalidade-open
                        data-id="{{ item.id }}"
                        data-aventureiro-id="{{ selected_aventureiro_id }}"
                        data-competencia="{{ item.competencia }}"
                        data-valor="{{ item.valor_raw }}"
                        data-status="{{ item.status_code }}"
                      >
                        {{ item.valor }}
                      </button>
                    </td>
                    <td><span class="badge-status{% if item.status_code == 'paga' %} is-paid{% endif %}">{{ item.status }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="panel-note">Nenhuma mensalidade gerada ainda para este aventureiro.</p>
          {% endif %}
        {% else %}
          <p class="panel-note">A listagem das mensalidades aparecerá abaixo após selecionar um aventureiro.</p>
        {% endif %}
      </div>

      <div class="mensalidades-list">
        <h3 style="margin-top:1.25rem;">Aventureiros com mensalidades ({{ resumo_ano }})</h3>
        {% if resumo_rows %}
          <div class="financeiro-scroll">
            <table class="resumo-mensalidades">
              <thead>
                <tr>
                  <th>Aventureiro</th>
                  {% for mes in resumo_meses %}
                    <th>{{ mes }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in resumo_rows %}
                  <tr>
                    <td>
                      {{ row.aventureiro_nome }}
                      {% if row.responsavel_username %}<small>Resp.: {{ row.responsavel_username }}</small>{% endif %}
                    </td>
                    {% for cell in row.cells %}
                      <td>
                        {% if cell.filled %}
                          <button
                            type="button"
                            class="cell-clickable"
                            data-mensalidade-open
                            data-id="{{ cell.id }}"
                            data-aventureiro-id="{{ row.aventureiro_id }}"
                            data-competencia="{{ cell.competencia }}"
                            data-valor="{{ cell.valor_raw }}"
                            data-status="{{ cell.status_code }}"
                            aria-label="Editar mensalidade {{ cell.competencia }}"
                          >
                            <span class="cell-filled{% if cell.status_code == 'paga' %} is-paid{% endif %}">{{ cell.label }}</span>
                          </button>
                        {% else %}
                          -
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="panel-note">Nenhum aventureiro possui mensalidades cadastradas no ano atual.</p>
        {% endif %}
      </div>
      {% endif %}
    </section>
  </main>

  {% if financeiro_mode == 'responsavel' %}
  <div class="modal-backdrop{% if responsavel_pix_pagamento %} is-open{% endif %}" id="pixPagamentoModal" aria-hidden="{% if responsavel_pix_pagamento %}false{% else %}true{% endif %}">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pixPagamentoModalTitle">
      <h3 id="pixPagamentoModalTitle">Pagamento via Pix</h3>
      <p>Escaneie o QR Code ou copie o código Pix para concluir o pagamento das mensalidades selecionadas.</p>
      <div class="pix-modal-row">
        <small>Total</small>
        <strong id="pixPagamentoTotal">{% if responsavel_pix_pagamento %}{{ responsavel_pix_pagamento.valor_total }}{% else %}R$ 0,00{% endif %}</strong>
      </div>
      <div class="pix-status-box{% if responsavel_pix_pagamento and responsavel_pix_pagamento.status == 'pago' %} is-paid{% endif %}" id="pixPagamentoStatus">
        {% if responsavel_pix_pagamento %}{{ responsavel_pix_pagamento.status_label }}{% else %}Aguardando pagamento{% endif %}
      </div>
      <img
        id="pixPagamentoQr"
        class="pix-modal-qr"
        alt="QR Code Pix"
        {% if responsavel_pix_pagamento and responsavel_pix_pagamento.qr_base64 %}
        src="data:image/png;base64,{{ responsavel_pix_pagamento.qr_base64 }}"
        {% else %}
        hidden
        {% endif %}
      />
      <label for="pixPagamentoCodigo">Código Pix (copia e cola)</label>
      <textarea id="pixPagamentoCodigo" class="pix-code-box" readonly>{% if responsavel_pix_pagamento %}{{ responsavel_pix_pagamento.pix_code }}{% endif %}</textarea>
      <div class="modal-actions">
        <button type="button" class="ghost" id="pixPagamentoCopiar">Copiar código</button>
        <button type="button" class="ghost" id="pixPagamentoFechar">Fechar</button>
      </div>
      {% if responsavel_pix_pagamento %}
      <div
        id="pixPagamentoData"
        data-pagamento-id="{{ responsavel_pix_pagamento.id }}"
        data-status-url="{% url 'accounts:financeiro_pagamento_status' responsavel_pix_pagamento.id %}"
      ></div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if financeiro_mode != 'responsavel' %}
  <div class="modal-backdrop" id="mensalidadeModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="mensalidadeModalTitle">
      <h3 id="mensalidadeModalTitle">Editar mensalidade</h3>
      <p id="mensalidadeModalSubtitle">Altere o valor ou exclua a mensalidade selecionada.</p>
      <form method="post" id="mensalidadeModalForm">
        {% csrf_token %}
        <input type="hidden" name="action" id="mensalidadeModalAction" value="editar_mensalidade" />
        <input type="hidden" name="mensalidade_id" id="mensalidadeModalId" />
        <input type="hidden" name="aventureiro_id" id="mensalidadeModalAventureiroId" />
        <input type="hidden" name="valor_mensalidade" id="mensalidadeModalValorTela" value="{{ valor_mensalidade|default:'30' }}" />
        <input type="hidden" id="mensalidadeModalStatus" value="" />
        <label for="mensalidadeModalValor">Valor da mensalidade</label>
        <input id="mensalidadeModalValor" name="valor_mensalidade_edicao" type="text" inputmode="decimal" required />
        <div class="modal-actions">
          <button type="button" class="ghost" id="mensalidadeModalCancelar">Cancelar</button>
          <button type="submit" class="ghost" id="mensalidadeModalToggleStatus">Marcar como paga</button>
          <button type="submit" class="danger" id="mensalidadeModalExcluir">Excluir</button>
          <button type="submit" class="primary" id="mensalidadeModalSalvar">Salvar valor</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById('mensalidadeModal');
      const form = document.getElementById('mensalidadeModalForm');
      const actionInput = document.getElementById('mensalidadeModalAction');
      const idInput = document.getElementById('mensalidadeModalId');
      const aventureiroInput = document.getElementById('mensalidadeModalAventureiroId');
      const valorInput = document.getElementById('mensalidadeModalValor');
      const valorTelaInput = document.getElementById('mensalidadeModalValorTela');
      const statusInput = document.getElementById('mensalidadeModalStatus');
      const subtitle = document.getElementById('mensalidadeModalSubtitle');
      const cancelBtn = document.getElementById('mensalidadeModalCancelar');
      const salvarBtn = document.getElementById('mensalidadeModalSalvar');
      const excluirBtn = document.getElementById('mensalidadeModalExcluir');
      const toggleStatusBtn = document.getElementById('mensalidadeModalToggleStatus');
      const seletorValorTela = document.getElementById('valor_mensalidade');

      function openModal(trigger) {
        idInput.value = trigger.dataset.id || '';
        aventureiroInput.value = trigger.dataset.aventureiroId || '';
        valorInput.value = trigger.dataset.valor || '';
        statusInput.value = trigger.dataset.status || 'pendente';
        subtitle.textContent = 'Mensalidade: ' + (trigger.dataset.competencia || '');
        actionInput.value = 'editar_mensalidade';
        valorInput.required = true;
        if (toggleStatusBtn) {
          toggleStatusBtn.textContent = statusInput.value === 'paga' ? 'Marcar como pendente' : 'Marcar como paga';
        }
        if (seletorValorTela) {
          valorTelaInput.value = seletorValorTela.value || '30';
        }
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        window.setTimeout(function () {
          valorInput.focus();
          valorInput.select();
        }, 0);
      }

      function closeModal() {
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        actionInput.value = 'editar_mensalidade';
        valorInput.required = true;
      }

      document.querySelectorAll('[data-mensalidade-open]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          openModal(btn);
        });
      });

      cancelBtn.addEventListener('click', closeModal);

      modal.addEventListener('click', function (event) {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && modal.classList.contains('is-open')) {
          closeModal();
        }
      });

      salvarBtn.addEventListener('click', function () {
        actionInput.value = 'editar_mensalidade';
        valorInput.required = true;
      });

      excluirBtn.addEventListener('click', function (event) {
        if (!window.confirm('Deseja excluir esta mensalidade?')) {
          event.preventDefault();
          return;
        }
        actionInput.value = 'excluir_mensalidade';
        valorInput.required = false;
      });

      if (toggleStatusBtn) {
        toggleStatusBtn.addEventListener('click', function () {
          actionInput.value = statusInput.value === 'paga' ? 'marcar_mensalidade_pendente' : 'marcar_mensalidade_paga';
          valorInput.required = false;
        });
      }
    })();
  </script>
  {% endif %}
  {% if financeiro_mode == 'responsavel' %}
  <script>
    (function () {
      const checks = Array.from(document.querySelectorAll('input[name="mensalidades_ids"][data-valor]'));
      const totalNode = document.getElementById('financeiroTotalSelecionadoValor');
      const btnSelecionarTodas = document.getElementById('financeiroSelecionarTodas');
      const btnLimparSelecao = document.getElementById('financeiroLimparSelecao');

      function parseMoedaBRL(texto) {
        const normalizado = String(texto || '')
          .replace('R$', '')
          .replace(/\s+/g, '')
          .replace(/\./g, '')
          .replace(',', '.');
        const valor = Number(normalizado);
        return Number.isFinite(valor) ? valor : 0;
      }

      function formatMoedaBRL(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      function atualizarTotal() {
        let total = 0;
        checks.forEach(function (check) {
          if (check.checked) total += parseMoedaBRL(check.dataset.valor);
        });
        totalNode.textContent = formatMoedaBRL(total);
      }

      if (checks.length && totalNode) {
        checks.forEach(function (check) {
          check.addEventListener('change', atualizarTotal);
        });
        atualizarTotal();
      }

      if (btnSelecionarTodas) {
        btnSelecionarTodas.addEventListener('click', function () {
          checks.forEach(function (check) { check.checked = true; });
          atualizarTotal();
        });
      }

      if (btnLimparSelecao) {
        btnLimparSelecao.addEventListener('click', function () {
          checks.forEach(function (check) { check.checked = false; });
          atualizarTotal();
        });
      }

      const pixModal = document.getElementById('pixPagamentoModal');
      const pixData = document.getElementById('pixPagamentoData');
      const pixStatus = document.getElementById('pixPagamentoStatus');
      const pixQr = document.getElementById('pixPagamentoQr');
      const pixCodigo = document.getElementById('pixPagamentoCodigo');
      const btnFechar = document.getElementById('pixPagamentoFechar');
      const btnCopiar = document.getElementById('pixPagamentoCopiar');
      let pollHandle = null;
      let pagamentoAprovado = pixStatus ? pixStatus.classList.contains('is-paid') : false;

      function stopPolling() {
        if (pollHandle) {
          window.clearInterval(pollHandle);
          pollHandle = null;
        }
      }

      function closePixModal() {
        if (!pixModal) return;
        pixModal.classList.remove('is-open');
        pixModal.setAttribute('aria-hidden', 'true');
        stopPolling();
        if (pagamentoAprovado) {
          window.location.reload();
        }
      }

      async function refreshPixStatus() {
        if (!pixData) return;
        try {
          const response = await fetch(pixData.dataset.statusUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const payload = await response.json();
          if (!payload || !payload.ok) return;
          pixStatus.textContent = payload.status_label || 'Aguardando pagamento';
          pixStatus.classList.toggle('is-paid', !!payload.is_paid);
          if (payload.is_paid) {
            pagamentoAprovado = true;
            stopPolling();
          }
        } catch (_err) {
          // mantém silencioso para não poluir a UI do responsável.
        }
      }

      if (btnFechar) {
        btnFechar.addEventListener('click', closePixModal);
      }
      if (pixModal) {
        pixModal.addEventListener('click', function (event) {
          if (event.target === pixModal) closePixModal();
        });
      }
      if (btnCopiar && pixCodigo) {
        btnCopiar.addEventListener('click', async function () {
          const valor = (pixCodigo.value || '').trim();
          if (!valor) return;
          try {
            await navigator.clipboard.writeText(valor);
            btnCopiar.textContent = 'Copiado';
            window.setTimeout(function () { btnCopiar.textContent = 'Copiar código'; }, 1500);
          } catch (_err) {
            pixCodigo.focus();
            pixCodigo.select();
          }
        });
      }

      if (pixModal && pixModal.classList.contains('is-open') && pixData) {
        refreshPixStatus();
        pollHandle = window.setInterval(refreshPixStatus, 7000);
      }
    })();
  </script>
  {% endif %}
</body>
</html>
