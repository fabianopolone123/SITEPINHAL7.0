<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Documentos de inscrição</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Documentos de inscrição</h2>
      <p>Crie o template, arraste os campos e gere fichas preenchidas para impressão.</p>
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Crie um template ou selecione um existente para editar.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card documentos-grid">
      <div class="documentos-col">
        <h3>Novo template</h3>
        <form method="post" enctype="multipart/form-data" class="form-compact">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_template" />
          <label>Nome do template</label>
          <input type="text" name="name" placeholder="Ficha Aventureiro" />
          <label>Tipo</label>
          <select name="template_type">
            {% for value, label in template_types %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
          <label>Imagem de fundo</label>
          <input type="file" name="background" accept="image/*" />
          <button type="submit" class="primary">Criar template</button>
        </form>

        <h3>Templates</h3>
        <ul class="documentos-lista">
          {% for template in templates %}
            <li class="{% if selected_template and template.pk == selected_template.pk %}active{% endif %}">
              <a href="?template={{ template.pk }}">
                {{ template.name }} <span>{{ template.get_template_type_display }}</span>
              </a>
            </li>
          {% empty %}
            <li>Nenhum template criado.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="documentos-col">
        {% if selected_template %}
          <h3>Editor de campos</h3>
          <p class="panel-note">Arraste os campos para posicionar sobre a ficha.</p>

          <div class="documentos-editor">
            <div class="documentos-campos" id="doc-fields">
              {% for key, label, field_type in fields %}
                <div class="doc-field-pill" draggable="true" data-key="{{ key }}" data-type="{{ field_type }}">{{ label }}</div>
              {% endfor %}
            </div>
            <div class="documentos-canvas-wrap">
              <div class="documentos-canvas" id="doc-canvas" data-bg="{{ selected_template.background.url }}">
                <img src="{{ selected_template.background.url }}" alt="Template" id="doc-background" />
              </div>
            </div>
          </div>

          <form method="post" class="form-compact" id="doc-save-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="save_positions" />
            <input type="hidden" name="template_id" value="{{ selected_template.pk }}" />
            <input type="hidden" name="positions_json" id="doc-positions" />
            <button type="submit" class="primary">Salvar posições</button>
          </form>

          <div class="documentos-gerar">
            <h3>Gerar documentos</h3>
            <div class="documentos-gerar-grid">
              <div>
                <h4>Responsáveis</h4>
                <ul>
                  {% for responsavel in responsaveis %}
                    <li>
                      {{ responsavel.user.username }} - {{ responsavel.responsavel_nome|default:responsavel.mae_nome|default:responsavel.pai_nome }}
                      <a class="secondary small-link" href="{% url 'accounts:documento_gerar' selected_template.pk 'responsavel' responsavel.pk %}" target="_blank">Gerar ficha</a>
                    </li>
                  {% empty %}
                    <li>Sem responsáveis.</li>
                  {% endfor %}
                </ul>
              </div>
              <div>
                <h4>Aventureiros</h4>
                <ul>
                  {% for aventureiro in aventureiros %}
                    <li>
                      {{ aventureiro.nome }} ({{ aventureiro.responsavel.user.username }})
                      <a class="secondary small-link" href="{% url 'accounts:documento_gerar' selected_template.pk 'aventureiro' aventureiro.pk %}" target="_blank">Gerar ficha</a>
                    </li>
                  {% empty %}
                    <li>Sem aventureiros.</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>

          {{ selected_template.positions|json_script:"doc-positions-data" }}
        {% else %}
          <p class="panel-note">Selecione um template para editar os campos e gerar documentos.</p>
        {% endif %}
      </div>
    </section>
  </main>
  <script src="{% static 'js/documentos.js' %}" defer></script>
</body>
</html>
