<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loja</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .loja-grid { display:grid; grid-template-columns: 1fr; gap:1rem; }
    .loja-form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:.9rem; }
    .loja-form-grid .full { grid-column: 1 / -1; }
    .loja-form-grid label { display:flex; flex-direction:column; gap:.35rem; color:#334155; font-weight:600; font-size:.9rem; }
    .loja-form-grid input, .loja-form-grid textarea { width:100%; padding:.75rem .85rem; border:1px solid #cbd5e1; border-radius:10px; }
    .variacoes-wrap { border:1px solid #e2e8f0; border-radius:12px; padding:.85rem; background:#fafcff; }
    .variacoes-head { display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.75rem; }
    .variacoes-list { display:flex; flex-direction:column; gap:.55rem; }
    .variacao-row { display:grid; grid-template-columns: 1.4fr .8fr .7fr auto; gap:.5rem; align-items:center; }
    .variacao-row input { padding:.65rem .7rem; border:1px solid #cbd5e1; border-radius:10px; }
    .variacao-remove { border:1px solid #fecaca; background:#fff1f2; color:#9f1239; border-radius:10px; padding:.6rem .75rem; cursor:pointer; }
    .fotos-wrap { border:1px solid #e2e8f0; border-radius:12px; padding:.85rem; background:#fff; }
    .fotos-head { display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.75rem; }
    .fotos-list { display:flex; flex-direction:column; gap:.55rem; }
    .foto-row { display:grid; grid-template-columns: minmax(180px, 1.1fr) 1fr auto; gap:.5rem; align-items:start; }
    .foto-row input[type="file"] { width:100%; padding:.65rem .7rem; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .foto-variacoes-box { border:1px solid #cbd5e1; border-radius:10px; background:#fff; padding:.55rem; display:grid; gap:.35rem; max-height: 168px; overflow:auto; }
    .foto-variacoes-item { display:flex; align-items:flex-start; gap:.45rem; font-size:.86rem; color:#334155; line-height:1.25; }
    .foto-variacoes-item input { margin-top:.12rem; }
    .foto-variacoes-hint { font-size:.75rem; color:#64748b; margin-top:.15rem; }
    .foto-remove { border:1px solid #fecaca; background:#fff1f2; color:#9f1239; border-radius:10px; padding:.6rem .75rem; cursor:pointer; }
    .loja-actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.9rem; }
    .loja-products { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; }
    .loja-card { border:1px solid #e2e8f0; border-radius:14px; background:#fff; overflow:hidden; }
    .loja-card img { width:100%; height:180px; object-fit:cover; background:#f8fafc; display:block; }
    .loja-card-body { padding:.9rem; }
    .loja-card h3 { margin:0 0 .35rem; }
    .loja-card p { color:#475569; margin:.2rem 0 .6rem; }
    .loja-prod-rule { margin:.25rem 0 .65rem; padding:.45rem .55rem; border-radius:10px; border:1px solid #dbeafe; background:#f8fbff; color:#1e3a8a; font-size:.85rem; }
    .loja-var-list { margin:0; padding-left:1rem; }
    .loja-var-list li { margin:.2rem 0; }
    .loja-fotos-mini { display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.45rem; }
    .loja-fotos-mini a { display:block; }
    .loja-fotos-mini img { width:54px; height:54px; object-fit:cover; border-radius:8px; border:1px solid #dbeafe; background:#f8fafc; }
    .loja-fotos-badge { display:inline-block; margin-top:.4rem; font-size:.76rem; color:#0f172a; background:#eff6ff; border:1px solid #dbeafe; border-radius:999px; padding:.15rem .45rem; }
    .stock-empty { color:#64748b; }
    .loja-catalog-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 340px)); gap:1rem; justify-content:center; }
    .catalog-card { width:100%; max-width:340px; justify-self:center; border:1px solid #dbeafe; border-radius:16px; background:#fff; box-shadow: 0 10px 24px rgba(15,23,42,.05); overflow:hidden; display:flex; flex-direction:column; }
    .catalog-media { padding:.8rem .8rem .35rem; }
    .catalog-main-photo-wrap {
      width:100%;
      aspect-ratio: 4 / 3;
      border-radius:12px;
      border:1px solid #e2e8f0;
      background: linear-gradient(180deg, #f8fafc, #f1f5f9);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .catalog-main-photo {
      width:100%;
      height:100%;
      object-fit: contain;
      display:block;
      background:#fff;
    }
    .catalog-main-photo.empty { display:none; }
    .catalog-main-photo-fallback {
      color:#64748b;
      font-size:.9rem;
      text-align:center;
      padding:1rem;
    }
    .catalog-thumb-row { margin-top:.45rem; display:flex; gap:.35rem; flex-wrap:wrap; }
    .catalog-thumb {
      width:44px;
      height:44px;
      border-radius:8px;
      border:1px solid #dbeafe;
      background:#fff;
      padding:0;
      cursor:pointer;
      overflow:hidden;
    }
    .catalog-thumb img { width:100%; height:100%; object-fit:contain; display:block; background:#fff; }
    .catalog-body { padding:.35rem .8rem .85rem; display:grid; gap:.75rem; }
    .catalog-title { margin:0; color:#0f172a; font-size:1.02rem; line-height:1.2; }
    .catalog-desc { margin:0; color:#475569; font-size:.9rem; line-height:1.4; }
    .catalog-variations { border:1px solid #e2e8f0; border-radius:12px; padding:.65rem; display:grid; gap:.45rem; background:#fcfdff; }
    .catalog-variations h4 { margin:0; font-size:.88rem; color:#0f172a; }
    .catalog-variation-select {
      width:100%;
      padding:.7rem .8rem;
      border:1px solid #cbd5e1;
      border-radius:10px;
      background:#fff;
      color:#0f172a;
      font-weight:600;
    }
    .catalog-variation-stock {
      font-size:.8rem;
      color:#64748b;
      min-height:1rem;
    }
    .catalog-buy-row { display:grid; grid-template-columns: 1fr auto; gap:.65rem; align-items:end; }
    .catalog-qty-wrap { display:grid; gap:.25rem; }
    .catalog-label { font-size:.8rem; color:#475569; font-weight:700; }
    .catalog-qty-control { display:inline-grid; grid-template-columns: 38px 58px 38px; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden; width:max-content; background:#fff; }
    .catalog-qty-control button { border:0; background:#eff6ff; color:#1d4ed8; font-weight:800; cursor:pointer; }
    .catalog-qty-control input { width:58px; border:0; text-align:center; font-weight:700; color:#0f172a; }
    .catalog-price-box { border:1px solid #dbeafe; border-radius:12px; background:#f8fbff; padding:.55rem .65rem; }
    .catalog-price-label { display:block; font-size:.76rem; color:#475569; }
    .catalog-price-value { display:block; color:#1d4ed8; font-size:1.05rem; font-weight:800; }
    .catalog-cart-btn { width:100%; border:0; border-radius:12px; padding:.78rem .9rem; font-weight:800; color:#fff; background: linear-gradient(135deg,#1d4ed8,#2563eb); cursor:pointer; box-shadow: 0 10px 20px rgba(37,99,235,.18); }
    .catalog-cart-btn:hover { filter:brightness(1.03); }
    .catalog-feedback { margin:0; font-size:.8rem; color:#0369a1; min-height:1.1rem; }
    .catalog-hidden-media { display:none; }
    .cart-toolbar { display:flex; justify-content:flex-end; margin-bottom:.25rem; }
    .cart-open-btn {
      border:1px solid #bfdbfe;
      background: linear-gradient(180deg,#ffffff,#f8fbff);
      color:#1d4ed8;
      border-radius:12px;
      padding:.6rem .8rem;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      box-shadow: 0 8px 16px rgba(37,99,235,.08);
    }
    .cart-open-count {
      min-width: 1.5rem;
      height: 1.5rem;
      border-radius:999px;
      display:grid;
      place-items:center;
      background:#1d4ed8;
      color:#fff;
      font-size:.78rem;
      font-weight:800;
      padding:0 .25rem;
    }
    .cart-drawer-overlay[hidden] { display:none !important; }
    .cart-drawer-overlay {
      position: fixed;
      inset: 0;
      z-index: 1100;
      background: rgba(15,23,42,.48);
      opacity: 0;
      transition: opacity .2s ease;
    }
    .cart-drawer-overlay.is-open { opacity: 1; }
    .cart-drawer {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: min(420px, 100vw);
      background:#fff;
      border-left:1px solid #dbeafe;
      box-shadow: -16px 0 40px rgba(15,23,42,.18);
      display:grid;
      grid-template-rows: auto 1fr auto;
      transform: translateX(104%);
      transition: transform .24s ease;
    }
    .cart-drawer-overlay.is-open .cart-drawer { transform: translateX(0); }
    .cart-drawer-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      padding:.8rem .9rem;
      border-bottom:1px solid #e2e8f0;
      background:#f8fbff;
    }
    .cart-drawer-title { margin:0; color:#0f172a; font-size:1rem; }
    .cart-drawer-close {
      border:1px solid #cbd5e1;
      background:#fff;
      color:#0f172a;
      border-radius:10px;
      padding:.45rem .6rem;
      font-weight:700;
      cursor:pointer;
    }
    .cart-drawer-body {
      overflow:auto;
      padding:.8rem .9rem;
      display:grid;
      gap:.75rem;
      align-content:start;
    }
    .cart-empty {
      margin:0;
      border:1px dashed #cbd5e1;
      border-radius:12px;
      background:#f8fafc;
      color:#64748b;
      padding:.85rem;
      text-align:center;
    }
    .cart-items { display:grid; gap:.65rem; }
    .cart-item {
      border:1px solid #e2e8f0;
      border-radius:12px;
      padding:.65rem;
      background:#fff;
      display:grid;
      grid-template-columns: 54px 1fr auto;
      gap:.55rem;
      align-items:start;
    }
    .cart-item-thumb {
      width:54px; height:54px; border-radius:10px; border:1px solid #dbeafe; background:#fff;
      display:grid; place-items:center; overflow:hidden;
    }
    .cart-item-thumb img { width:100%; height:100%; object-fit:contain; background:#fff; }
    .cart-item-thumb span { color:#94a3b8; font-size:.72rem; text-align:center; padding:.2rem; }
    .cart-item-main { display:grid; gap:.22rem; min-width:0; }
    .cart-item-main strong { color:#0f172a; font-size:.88rem; line-height:1.25; }
    .cart-item-meta, .cart-item-subtotal { color:#475569; font-size:.78rem; }
    .cart-item-subtotal { color:#1d4ed8; font-weight:700; }
    .cart-item-actions { display:grid; gap:.45rem; justify-items:end; }
    .cart-item-remove {
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#9f1239;
      border-radius:8px;
      padding:.28rem .5rem;
      font-size:.74rem;
      font-weight:700;
      cursor:pointer;
    }
    .cart-item-qty {
      display:inline-grid;
      grid-template-columns: 28px 38px 28px;
      border:1px solid #cbd5e1;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
    }
    .cart-item-qty button {
      border:0;
      background:#eff6ff;
      color:#1d4ed8;
      font-weight:800;
      cursor:pointer;
      padding:0;
    }
    .cart-item-qty input {
      border:0;
      width:38px;
      text-align:center;
      font-size:.82rem;
      font-weight:700;
      color:#0f172a;
      background:#fff;
    }
    .cart-drawer-foot {
      border-top:1px solid #e2e8f0;
      padding:.85rem .9rem;
      background:#fff;
      display:grid;
      gap:.65rem;
    }
    .cart-total-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      color:#0f172a;
      font-weight:800;
    }
    .cart-total-value { color:#1d4ed8; font-size:1.1rem; }
    .cart-payment-select {
      width:100%;
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:.7rem .8rem;
      background:#fff;
      color:#0f172a;
      font-weight:600;
    }
    .cart-finalize-btn {
      width:100%;
      border:0;
      border-radius:12px;
      padding:.8rem .9rem;
      font-weight:800;
      color:#fff;
      background: linear-gradient(135deg,#0f766e,#0ea5a4);
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(13,148,136,.16);
    }
    .cart-finalize-btn:disabled {
      cursor:not-allowed;
      opacity:.55;
      box-shadow:none;
    }
    .cart-foot-note { margin:0; font-size:.78rem; color:#64748b; }
    .cart-inline-feedback { margin:0; font-size:.8rem; color:#0369a1; min-height:1rem; }
    .pix-modal[hidden] { display:none !important; }
    .pix-modal {
      position: fixed;
      inset: 0;
      z-index: 1150;
      display: grid;
      place-items: center;
      padding: .75rem;
      background: rgba(15,23,42,.62);
      backdrop-filter: blur(2px);
    }
    .pix-modal-dialog {
      width: min(560px, 100%);
      max-height: 94vh;
      overflow:auto;
      background:#fff;
      border:1px solid #dbeafe;
      border-radius:16px;
      box-shadow: 0 30px 80px rgba(15,23,42,.25);
      display:grid;
      gap:.75rem;
      padding:.85rem;
    }
    .pix-modal-head { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .pix-modal-title { margin:0; color:#0f172a; font-size:1rem; }
    .pix-modal-close {
      border:1px solid #cbd5e1; background:#fff; color:#0f172a;
      border-radius:10px; padding:.45rem .6rem; font-weight:700; cursor:pointer;
    }
    .pix-modal-status {
      border:1px solid #dbeafe; background:#f8fbff; color:#1e3a8a;
      border-radius:12px; padding:.55rem .65rem; display:grid; gap:.15rem;
    }
    .pix-modal-status strong { color:#0f172a; }
    .pix-modal-qr-wrap {
      border:1px solid #e2e8f0; border-radius:14px; background:#fff;
      padding:.85rem; display:grid; place-items:center;
    }
    .pix-modal-qr-wrap img { width:min(320px, 100%); height:auto; object-fit:contain; display:block; }
    .pix-modal-code-wrap { display:grid; gap:.35rem; }
    .pix-modal-code-label { font-size:.8rem; color:#475569; font-weight:700; }
    .pix-modal-code {
      width:100%; min-height:92px; resize:vertical;
      border:1px solid #cbd5e1; border-radius:10px;
      padding:.65rem .75rem; font-family: Consolas, monospace; font-size:.8rem;
      color:#0f172a; background:#fff;
    }
    .pix-modal-actions { display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    .pix-secondary-btn, .pix-primary-btn {
      border-radius:12px; padding:.75rem .85rem; font-weight:800; cursor:pointer;
    }
    .pix-secondary-btn {
      border:1px solid #cbd5e1; background:#fff; color:#0f172a;
    }
    .pix-primary-btn {
      border:0; background: linear-gradient(135deg,#1d4ed8,#2563eb); color:#fff;
      box-shadow: 0 10px 20px rgba(37,99,235,.16);
    }
    .pix-modal-note { margin:0; font-size:.8rem; color:#64748b; }
    .order-success-modal[hidden] { display:none !important; }
    .order-success-modal {
      position: fixed;
      inset: 0;
      z-index: 1160;
      display: grid;
      place-items: center;
      padding: .75rem;
      background: rgba(15,23,42,.66);
      backdrop-filter: blur(2px);
    }
    .order-success-dialog {
      width: min(520px, 100%);
      background:#fff;
      border:1px solid #bbf7d0;
      border-radius:16px;
      box-shadow: 0 28px 70px rgba(15,23,42,.28);
      padding:.95rem;
      display:grid;
      gap:.8rem;
    }
    .order-success-badge {
      width:56px;
      height:56px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg,#dcfce7,#bbf7d0);
      color:#166534;
      border:1px solid #86efac;
      font-size:1.5rem;
      font-weight:900;
      margin:0 auto;
    }
    .order-success-title {
      margin:0;
      text-align:center;
      color:#166534;
      font-size:1.05rem;
    }
    .order-success-text {
      margin:0;
      text-align:center;
      color:#475569;
      font-size:.9rem;
      line-height:1.45;
    }
    .order-success-summary {
      border:1px solid #dbeafe;
      background:#f8fbff;
      border-radius:12px;
      padding:.7rem .8rem;
      display:grid;
      gap:.3rem;
      color:#0f172a;
      font-size:.88rem;
    }
    .order-success-summary strong { color:#0f172a; }
    .order-success-actions { display:grid; gap:.55rem; }
    .order-success-btn {
      width:100%;
      border:0;
      border-radius:12px;
      padding:.82rem .9rem;
      font-weight:800;
      color:#fff;
      background: linear-gradient(135deg,#16a34a,#22c55e);
      box-shadow: 0 10px 20px rgba(34,197,94,.2);
      cursor:pointer;
    }
    .image-modal[hidden] { display:none !important; }
    .image-modal {
      position: fixed;
      inset: 0;
      z-index: 1200;
      display: grid;
      place-items: center;
      padding: .75rem;
      background: rgba(15, 23, 42, .72);
      backdrop-filter: blur(2px);
    }
    .image-modal-dialog {
      width: min(980px, 100%);
      max-height: min(92vh, 820px);
      background: #fff;
      border-radius: 16px;
      border: 1px solid #dbeafe;
      box-shadow: 0 30px 80px rgba(15,23,42,.35);
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
    }
    .image-modal-head {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:.75rem;
      padding:.7rem .85rem;
      border-bottom:1px solid #e2e8f0;
      background:#f8fbff;
    }
    .image-modal-title {
      margin:0;
      color:#0f172a;
      font-size:.95rem;
      line-height:1.2;
    }
    .image-modal-close {
      border:1px solid #cbd5e1;
      background:#fff;
      color:#0f172a;
      border-radius:10px;
      padding:.45rem .6rem;
      font-weight:700;
      cursor:pointer;
    }
    .image-modal-body {
      padding:.7rem;
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:.5rem;
      align-items:center;
      background:#fff;
    }
    .image-modal-nav {
      border:1px solid #cbd5e1;
      background:#fff;
      color:#0f172a;
      border-radius:10px;
      width:42px;
      height:42px;
      display:grid;
      place-items:center;
      font-size:1.1rem;
      cursor:pointer;
      font-weight:800;
      flex:0 0 auto;
    }
    .image-modal-nav[disabled] {
      opacity:.45;
      cursor:not-allowed;
    }
    .image-modal-figure {
      width:100%;
      display:grid;
      gap:.45rem;
      justify-items:center;
    }
    .image-modal-body img {
      width:100%;
      height:100%;
      max-width: 100%;
      max-height: min(78vh, 700px);
      object-fit: contain;
      border-radius: 12px;
      background: #fff;
    }
    .image-modal-counter {
      font-size:.82rem;
      color:#475569;
      min-height:1rem;
    }
    @media (max-width: 800px) {
      .loja-form-grid { grid-template-columns: 1fr; }
      .variacao-row { grid-template-columns: 1fr; }
      .variacao-remove { width:100%; }
      .foto-row { grid-template-columns: 1fr; }
      .foto-remove { width:100%; }
      .catalog-buy-row { grid-template-columns: 1fr; }
      .catalog-qty-control { width:100%; grid-template-columns: 42px 1fr 42px; }
      .catalog-qty-control input { width:100%; }
      .cart-drawer { width: min(100vw, 420px); }
      .cart-item { grid-template-columns: 46px 1fr; }
      .cart-item-actions { grid-column: 1 / -1; justify-items:stretch; }
      .cart-item-remove { width:100%; }
      .cart-item-qty { justify-self:stretch; width:100%; grid-template-columns: 32px 1fr 32px; }
      .cart-item-qty input { width:100%; }
      .pix-modal { padding:.4rem; }
      .pix-modal-dialog { border-radius:12px; padding:.7rem; }
      .pix-modal-actions { grid-template-columns: 1fr; }
      .order-success-modal { padding:.4rem; }
      .order-success-dialog { border-radius:12px; padding:.8rem; }
      .image-modal { padding: .4rem; }
      .image-modal-dialog { max-height: 95vh; border-radius: 12px; }
      .image-modal-head { padding:.6rem .7rem; }
      .image-modal-title { font-size:.88rem; }
      .image-modal-body { padding:.45rem; grid-template-columns: 1fr; }
      .image-modal-body img { max-height: 82vh; border-radius: 10px; }
      .image-modal-nav { width:100%; height:40px; }
    }
  </style>
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Loja</h2>
      {% if loja_mode == 'responsavel' %}
        <p>Escolha os produtos disponíveis, selecione a variação e a quantidade para preparar seu carrinho.</p>
      {% else %}
        <p>Cadastre produtos com foto e variações (valor e estoque opcional).</p>
      {% endif %}
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          {% if loja_mode == 'responsavel' %}
            <p data-state="info">Selecione um produto, escolha a variação e ajuste a quantidade para validar o catálogo.</p>
          {% else %}
            <p data-state="info">Use o botão Cadastrar produto para adicionar itens da loja.</p>
          {% endif %}
        {% endfor %}
      </div>
    </section>

    {% if loja_mode == 'responsavel' %}
    <section class="painel-card loja-grid">
      <div class="cart-toolbar">
        <button type="button" class="cart-open-btn" id="catalogCartOpenBtn">
          Carrinho
          <span class="cart-open-count" id="catalogCartOpenCount">0</span>
        </button>
      </div>
      <h3 style="margin:0;">Produtos disponíveis</h3>
      {% if responsavel_catalogo_tem_produtos %}
        <div class="loja-catalog-grid" id="loja-catalog-grid">
          {% for row in catalog_rows %}
            <article class="catalog-card" data-catalog-card data-product-id="{{ row.produto.id }}" data-product-title="{{ row.produto.titulo }}">
              <div class="catalog-media">
                <div class="catalog-main-photo-wrap">
                  {% if row.produto_capa_url %}
                    <img
                      class="catalog-main-photo"
                      src="{{ row.produto_capa_url }}"
                      alt="Foto de {{ row.produto.titulo }}"
                      data-catalog-main-image
                      data-default-src="{{ row.produto_capa_url }}"
                    />
                    <div class="catalog-main-photo-fallback" data-catalog-main-fallback hidden>Sem foto disponível</div>
                  {% else %}
                    <img class="catalog-main-photo empty" alt="" data-catalog-main-image data-default-src="" />
                    <div class="catalog-main-photo-fallback" data-catalog-main-fallback>Sem foto disponível</div>
                  {% endif %}
                </div>
                <div class="catalog-thumb-row" data-catalog-thumbs></div>
                <div class="catalog-hidden-media" data-catalog-variant-media>
                  {% for v in row.variacoes %}
                    <div data-variant-id="{{ v.id }}">
                      {% for foto in v.fotos_vinculadas %}
                        <span data-photo-url="{{ foto.foto.url }}" data-photo-alt="Foto de {{ row.produto.titulo }} - {{ v.nome }}"></span>
                      {% endfor %}
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="catalog-body">
                <div>
                  <h3 class="catalog-title">{{ row.produto.titulo }}</h3>
                  {% if row.produto.descricao %}
                    <p class="catalog-desc">{{ row.produto.descricao }}</p>
                  {% endif %}
                </div>

                <div class="catalog-variations">
                  <h4>Variações</h4>
                  {% for v in row.variacoes %}
                    {% if forloop.first %}
                      <select class="catalog-variation-select" data-catalog-variation-select>
                    {% endif %}
                        <option
                          value="{{ v.id }}"
                          data-variant-id="{{ v.id }}"
                          data-price="{{ v.valor }}"
                          data-stock-label="{% if v.estoque is not None %}Estoque: {{ v.estoque }}{% endif %}"
                        >
                          {{ v.nome }}
                        </option>
                    {% if forloop.last %}
                      </select>
                    {% endif %}
                  {% empty %}
                    <p class="panel-note" style="margin:0;">Sem variações ativas disponíveis.</p>
                  {% endfor %}
                  {% if row.variacoes %}
                    <div class="catalog-variation-stock" data-catalog-stock></div>
                  {% endif %}
                </div>

                <div class="catalog-price-box">
                  <span class="catalog-price-label">Valor da variação selecionada</span>
                  <span class="catalog-price-value" data-catalog-price>Selecione uma variação</span>
                </div>

                <div class="catalog-buy-row">
                  <div class="catalog-qty-wrap">
                    <span class="catalog-label">Quantidade</span>
                    <div class="catalog-qty-control">
                      <button type="button" data-qty-minus>-</button>
                      <input type="number" value="1" min="1" step="1" data-catalog-qty readonly />
                      <button type="button" data-qty-plus>+</button>
                    </div>
                  </div>
                  <button type="button" class="catalog-cart-btn" data-catalog-add-btn>Adicionar ao carrinho</button>
                </div>
                <p class="catalog-feedback" data-catalog-feedback aria-live="polite"></p>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum produto ativo disponível no momento.</p>
      {% endif %}
    </section>
    {% else %}
    <section class="painel-card loja-grid">
      <h3 style="margin:0;">Cadastrar produto</h3>
      <form method="post" enctype="multipart/form-data" id="loja-form">
        {% csrf_token %}
        <div class="loja-form-grid">
          <label>
            Título
            <input type="text" name="titulo" required value="{{ form_data.titulo|default:'' }}" />
          </label>
          <div class="panel-note" style="align-self:end;">
            Cada foto cadastrada abaixo precisa ser vinculada a uma variação.
          </div>
          <label class="full">
            Descrição
            <textarea name="descricao" rows="4" placeholder="Descrição do produto (opcional)">{{ form_data.descricao|default:'' }}</textarea>
          </label>
          <label>
            Mínimo de pedidos pagos para produção (opcional)
            <input type="number" name="minimo_pedidos_pagos" min="1" step="1" value="{{ form_data.minimo_pedidos_pagos|default:'' }}" placeholder="Ex.: 10" />
          </label>
          <div class="panel-note" style="align-self:end;">
            Ex.: camiseta de atividade só vai para confecção quando atingir 10 pedidos pagos.
          </div>
        </div>

        <div class="variacoes-wrap" style="margin-top:1rem;">
          <div class="variacoes-head">
            <div>
              <strong>Variações</strong>
              <div class="panel-note">Cadastre pelo menos uma variação com valor. Ex.: P, M, G; cor; tamanho etc.</div>
            </div>
            <button type="button" class="secondary" id="btn-add-variacao">Adicionar variação</button>
          </div>
          <div class="variacoes-list" id="variacoes-list">
            {% if form_data.variacoes %}
              {% for var in form_data.variacoes %}
                <div class="variacao-row">
                  <input type="text" name="variacao_nome[]" placeholder="Variação (ex.: P / Azul)" value="{{ var.nome|default:'' }}" />
                  <input type="text" name="variacao_valor[]" placeholder="Valor" inputmode="decimal" value="{{ var.valor|default:'' }}" />
                  <input type="number" name="variacao_estoque[]" placeholder="Estoque" min="0" value="{{ var.estoque|default:'' }}" />
                  <button type="button" class="variacao-remove">Remover</button>
                </div>
              {% endfor %}
            {% else %}
              <div class="variacao-row">
                <input type="text" name="variacao_nome[]" placeholder="Variação (ex.: P / Azul)" />
                <input type="text" name="variacao_valor[]" placeholder="Valor" inputmode="decimal" />
                <input type="number" name="variacao_estoque[]" placeholder="Estoque" min="0" />
                <button type="button" class="variacao-remove">Remover</button>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="fotos-wrap" style="margin-top:1rem;">
          <div class="fotos-head">
            <div>
              <strong>Fotos do produto</strong>
              <div class="panel-note">Você pode cadastrar várias fotos. Cada foto pode ser vinculada a uma ou mais variações, ou a todas.</div>
            </div>
            <button type="button" class="secondary" id="btn-add-foto">Adicionar foto</button>
          </div>
          <div class="fotos-list" id="fotos-list">
            {% if form_data.fotos %}
              {% for row in form_data.fotos %}
                <div class="foto-row" data-row-id="{{ row.row_id|default:'foto1' }}">
                  <input type="hidden" name="foto_row_id[]" value="{{ row.row_id|default:'foto1' }}" />
                  <input type="file" name="foto_arquivo__{{ row.row_id|default:'foto1' }}" accept="image/*" />
                  <div class="foto-variacao-select" data-row-id="{{ row.row_id|default:'foto1' }}" data-selected="{{ row.variacao_refs_csv|default:'' }}"></div>
                  <button type="button" class="foto-remove">Remover</button>
                </div>
              {% endfor %}
            {% else %}
              <div class="foto-row" data-row-id="foto1">
                <input type="hidden" name="foto_row_id[]" value="foto1" />
                <input type="file" name="foto_arquivo__foto1" accept="image/*" />
                <div class="foto-variacao-select" data-row-id="foto1"></div>
                <button type="button" class="foto-remove">Remover</button>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="loja-actions">
          <button type="submit" class="primary">Cadastrar produto</button>
        </div>
      </form>
    </section>

    <section class="painel-card loja-grid">
      <h3 style="margin:0;">Produtos cadastrados</h3>
      {% if produtos %}
        <div class="loja-products">
          {% for row in produtos %}
            <article class="loja-card">
              {% if row.capa_foto %}
                <img src="{{ row.capa_foto.url }}" alt="Foto de {{ row.produto.titulo }}" />
              {% else %}
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='400'%3E%3Crect width='100%25' height='100%25' fill='%23f8fafc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-size='28'%3ESem foto%3C/text%3E%3C/svg%3E" alt="Sem foto" />
              {% endif %}
              <div class="loja-card-body">
                <h3>{{ row.produto.titulo }}</h3>
                {% if row.produto.descricao %}<p>{{ row.produto.descricao }}</p>{% endif %}
                {% if row.produto.minimo_pedidos_pagos %}
                  <div class="loja-prod-rule">
                    Produção sob pedido: mínimo de <strong>{{ row.produto.minimo_pedidos_pagos }}</strong> pedido(s) pagos.
                  </div>
                {% endif %}
                <ul class="loja-var-list">
                  {% for v in row.variacoes %}
                    <li>
                      <strong>{{ v.nome }}</strong> - R$ {{ v.valor }}
                      {% if v.estoque is not None %}
                        <span>(Estoque: {{ v.estoque }})</span>
                      {% else %}
                        <span class="stock-empty">(Estoque não informado)</span>
                      {% endif %}
                      {% if v.fotos_vinculadas %}
                        <div class="loja-fotos-badge">{{ v.fotos_vinculadas|length }} foto(s) vinculada(s)</div>
                        <div class="loja-fotos-mini">
                          {% for foto in v.fotos_vinculadas %}
                            <a href="{{ foto.foto.url }}" target="_blank" rel="noopener">
                              <img src="{{ foto.foto.url }}" alt="Foto da variação {{ v.nome }}" />
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum produto cadastrado ainda.</p>
      {% endif %}
    </section>
    {% endif %}
  </main>

  {% if loja_mode == 'responsavel' %}
  <div class="cart-drawer-overlay" id="catalogCartDrawerOverlay" hidden aria-hidden="true">
    <aside class="cart-drawer" role="dialog" aria-modal="true" aria-labelledby="catalogCartDrawerTitle">
      <div class="cart-drawer-head">
        <h3 class="cart-drawer-title" id="catalogCartDrawerTitle">Seu carrinho</h3>
        <button type="button" class="cart-drawer-close" id="catalogCartDrawerClose">Fechar</button>
      </div>
      <div class="cart-drawer-body">
        <p class="cart-empty" id="catalogCartEmpty">Seu carrinho está vazio.</p>
        <div class="cart-items" id="catalogCartItems"></div>
        <p class="cart-inline-feedback" id="catalogCartInlineFeedback" aria-live="polite"></p>
      </div>
      <div class="cart-drawer-foot">
        <div class="cart-total-row">
          <span>Total do pedido</span>
          <span class="cart-total-value" id="catalogCartTotal">R$ 0,00</span>
        </div>
        <label style="display:grid; gap:.3rem;">
          <span class="catalog-label">Forma de pagamento</span>
          <select class="cart-payment-select" id="catalogCartPaymentMethod">
            <option value="pix" selected>Pix</option>
          </select>
        </label>
        <button type="button" class="cart-finalize-btn" id="catalogCartFinalizeBtn" disabled>Finalizar pedido</button>
        <p class="cart-foot-note">Ao finalizar, o sistema gera o Pix do pedido. As próximas etapas (histórico/gestão completa dos pedidos) serão implementadas depois.</p>
      </div>
    </aside>
  </div>
  {% endif %}

  {% if loja_mode == 'responsavel' %}
  <div
    id="lojaPixApiConfig"
    data-create-url="{% url 'accounts:loja_pedido_criar_pix' %}"
    data-status-url-template="{% url 'accounts:loja_pedido_status' 0 %}"
  ></div>
  <div class="pix-modal" id="catalogPixModal" hidden aria-hidden="true">
    <div class="pix-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="catalogPixModalTitle">
      <div class="pix-modal-head">
        <h3 class="pix-modal-title" id="catalogPixModalTitle">Pagamento via Pix</h3>
        <button type="button" class="pix-modal-close" id="catalogPixModalClose">Fechar</button>
      </div>
      <div class="pix-modal-status">
        <span><strong>Pedido:</strong> <span id="catalogPixPedidoId">-</span></span>
        <span><strong>Status:</strong> <span id="catalogPixStatusLabel">Aguardando pagamento</span></span>
        <span><strong>Total:</strong> <span id="catalogPixValorTotal">R$ 0,00</span></span>
      </div>
      <div class="pix-modal-qr-wrap">
        <img id="catalogPixQrImage" alt="QR Code Pix do pedido" />
      </div>
      <div class="pix-modal-code-wrap">
        <span class="pix-modal-code-label">Pix copia e cola</span>
        <textarea class="pix-modal-code" id="catalogPixCode" readonly></textarea>
      </div>
      <div class="pix-modal-actions">
        <button type="button" class="pix-secondary-btn" id="catalogPixCopyBtn">Copiar código Pix</button>
        <button type="button" class="pix-primary-btn" id="catalogPixRefreshBtn">Atualizar status</button>
      </div>
      <p class="pix-modal-note" id="catalogPixModalNote">Após pagar, aguarde alguns segundos. O status será atualizado automaticamente.</p>
    </div>
  </div>

  <div class="order-success-modal" id="catalogOrderSuccessModal" hidden aria-hidden="true">
    <div class="order-success-dialog" role="dialog" aria-modal="true" aria-labelledby="catalogOrderSuccessTitle">
      <div class="order-success-badge" aria-hidden="true">✓</div>
      <h3 class="order-success-title" id="catalogOrderSuccessTitle">Pagamento aprovado</h3>
      <p class="order-success-text">
        Seu pedido da loja foi confirmado com sucesso. Obrigado pelo pagamento.
      </p>
      <div class="order-success-summary">
        <span><strong>Pedido:</strong> <span id="catalogOrderSuccessPedidoId">-</span></span>
        <span><strong>Status:</strong> <span id="catalogOrderSuccessStatus">Pagamento aprovado</span></span>
        <span><strong>Total:</strong> <span id="catalogOrderSuccessTotal">R$ 0,00</span></span>
      </div>
      <div class="order-success-actions">
        <button type="button" class="order-success-btn" id="catalogOrderSuccessClose">Continuar na loja</button>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="image-modal" id="catalogImageModal" hidden aria-hidden="true">
    <div class="image-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="catalogImageModalTitle">
      <div class="image-modal-head">
        <h3 class="image-modal-title" id="catalogImageModalTitle">Visualização da imagem</h3>
        <button type="button" class="image-modal-close" id="catalogImageModalClose">Fechar</button>
      </div>
      <div class="image-modal-body">
        <button type="button" class="image-modal-nav" id="catalogImageModalPrev" aria-label="Foto anterior">‹</button>
        <div class="image-modal-figure">
          <img id="catalogImageModalImg" src="" alt="Visualização ampliada do produto" />
          <div class="image-modal-counter" id="catalogImageModalCounter"></div>
        </div>
        <button type="button" class="image-modal-nav" id="catalogImageModalNext" aria-label="Próxima foto">›</button>
      </div>
    </div>
  </div>

  {% if loja_mode != 'responsavel' %}
  <template id="variacao-template">
    <div class="variacao-row">
      <input type="text" name="variacao_nome[]" placeholder="Variação (ex.: P / Azul)" />
      <input type="text" name="variacao_valor[]" placeholder="Valor" inputmode="decimal" />
      <input type="number" name="variacao_estoque[]" placeholder="Estoque" min="0" />
      <button type="button" class="variacao-remove">Remover</button>
    </div>
  </template>

  <template id="foto-template">
    <div class="foto-row" data-row-id="__ROW_ID__">
      <input type="hidden" name="foto_row_id[]" value="__ROW_ID__" />
      <input type="file" name="foto_arquivo____ROW_ID__" accept="image/*" />
      <div class="foto-variacao-select" data-row-id="__ROW_ID__"></div>
      <button type="button" class="foto-remove">Remover</button>
    </div>
  </template>
  {% endif %}

  <script>
    (function () {
      const cards = document.querySelectorAll('[data-catalog-card]');
      const modal = document.getElementById('catalogImageModal');
      const modalImg = document.getElementById('catalogImageModalImg');
      const modalTitle = document.getElementById('catalogImageModalTitle');
      const modalClose = document.getElementById('catalogImageModalClose');
      const modalPrev = document.getElementById('catalogImageModalPrev');
      const modalNext = document.getElementById('catalogImageModalNext');
      const modalCounter = document.getElementById('catalogImageModalCounter');
      const cartOpenBtn = document.getElementById('catalogCartOpenBtn');
      const cartOpenCount = document.getElementById('catalogCartOpenCount');
      const cartOverlay = document.getElementById('catalogCartDrawerOverlay');
      const cartCloseBtn = document.getElementById('catalogCartDrawerClose');
      const cartItemsWrap = document.getElementById('catalogCartItems');
      const cartEmpty = document.getElementById('catalogCartEmpty');
      const cartTotalEl = document.getElementById('catalogCartTotal');
      const cartPaymentSelect = document.getElementById('catalogCartPaymentMethod');
      const cartFinalizeBtn = document.getElementById('catalogCartFinalizeBtn');
      const cartInlineFeedback = document.getElementById('catalogCartInlineFeedback');
      const pixApiConfig = document.getElementById('lojaPixApiConfig');
      const pixModal = document.getElementById('catalogPixModal');
      const pixModalClose = document.getElementById('catalogPixModalClose');
      const pixPedidoIdEl = document.getElementById('catalogPixPedidoId');
      const pixStatusLabelEl = document.getElementById('catalogPixStatusLabel');
      const pixValorTotalEl = document.getElementById('catalogPixValorTotal');
      const pixQrImageEl = document.getElementById('catalogPixQrImage');
      const pixCodeEl = document.getElementById('catalogPixCode');
      const pixCopyBtn = document.getElementById('catalogPixCopyBtn');
      const pixRefreshBtn = document.getElementById('catalogPixRefreshBtn');
      const pixModalNote = document.getElementById('catalogPixModalNote');
      const orderSuccessModal = document.getElementById('catalogOrderSuccessModal');
      const orderSuccessCloseBtn = document.getElementById('catalogOrderSuccessClose');
      const orderSuccessPedidoId = document.getElementById('catalogOrderSuccessPedidoId');
      const orderSuccessStatus = document.getElementById('catalogOrderSuccessStatus');
      const orderSuccessTotal = document.getElementById('catalogOrderSuccessTotal');
      if (!cards.length) return;

      const CART_STORAGE_KEY = 'sitepinhal_loja_cart_responsavel_v1';
      const PIX_CREATE_URL = pixApiConfig ? String(pixApiConfig.dataset.createUrl || '') : '';
      const PIX_STATUS_URL_TEMPLATE = pixApiConfig ? String(pixApiConfig.dataset.statusUrlTemplate || '') : '';
      let modalGalleryItems = [];
      let modalGalleryIndex = 0;
      let cartState = { items: [], payment_method: 'pix' };
      let pixPedidoAtual = null;
      let pixPollingTimer = null;
      let approvedSuccessShownForPedido = '';

      function normalizeCartState(raw) {
        const base = (raw && typeof raw === 'object') ? raw : {};
        const items = Array.isArray(base.items) ? base.items : [];
        return {
          payment_method: String(base.payment_method || 'pix') || 'pix',
          items: items
            .filter(function (item) {
              return item && item.key && item.product_id && item.variation_id;
            })
            .map(function (item) {
              return {
                key: String(item.key),
                product_id: String(item.product_id),
                product_title: String(item.product_title || 'Produto'),
                variation_id: String(item.variation_id),
                variation_label: String(item.variation_label || 'Variação'),
                unit_price: Number(item.unit_price || 0) || 0,
                quantity: Math.max(1, parseInt(item.quantity || 1, 10) || 1),
                image_url: String(item.image_url || ''),
                image_alt: String(item.image_alt || 'Foto do produto'),
              };
            }),
        };
      }

      function loadCartState() {
        try {
          const raw = window.localStorage.getItem(CART_STORAGE_KEY);
          if (!raw) return;
          cartState = normalizeCartState(JSON.parse(raw));
        } catch (error) {
          cartState = { items: [], payment_method: '' };
        }
      }

      function saveCartState() {
        try {
          window.localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartState));
        } catch (error) {
          // Ignora falha de armazenamento local.
        }
      }

      function cartItemsCount() {
        return cartState.items.reduce(function (acc, item) { return acc + (item.quantity || 0); }, 0);
      }

      function formatPriceNumber(value) {
        const num = Number(value || 0);
        return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderCart() {
        if (!cartItemsWrap || !cartTotalEl) return;
        const items = cartState.items || [];
        const total = items.reduce(function (acc, item) {
          return acc + (Number(item.unit_price || 0) * Number(item.quantity || 0));
        }, 0);

        if (cartOpenCount) cartOpenCount.textContent = String(cartItemsCount());
        cartTotalEl.textContent = formatPriceNumber(total);
        if (!cartState.payment_method) cartState.payment_method = 'pix';
        if (cartPaymentSelect) cartPaymentSelect.value = cartState.payment_method || 'pix';
        if (cartFinalizeBtn) {
          cartFinalizeBtn.disabled = !(items.length && (cartState.payment_method || '').trim());
        }

        if (cartEmpty) cartEmpty.hidden = items.length > 0;
        cartItemsWrap.innerHTML = '';

        items.forEach(function (item) {
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.setAttribute('data-cart-item-key', item.key);
          row.innerHTML = ''
            + '<div class="cart-item-thumb">'
            +   (item.image_url
                  ? '<img src="' + escapeHtml(item.image_url) + '" alt="' + escapeHtml(item.image_alt || 'Foto do produto') + '"/>'
                  : '<span>Sem foto</span>')
            + '</div>'
            + '<div class="cart-item-main">'
            +   '<strong>' + escapeHtml(item.product_title) + '</strong>'
            +   '<div class="cart-item-meta">Variação: ' + escapeHtml(item.variation_label) + '</div>'
            +   '<div class="cart-item-meta">Unitário: ' + formatPriceNumber(item.unit_price) + '</div>'
            +   '<div class="cart-item-subtotal">Subtotal: ' + formatPriceNumber(Number(item.unit_price) * Number(item.quantity)) + '</div>'
            + '</div>'
            + '<div class="cart-item-actions">'
            +   '<button type="button" class="cart-item-remove" data-cart-action="remove">Remover</button>'
            +   '<div class="cart-item-qty">'
            +     '<button type="button" data-cart-action="minus">-</button>'
            +     '<input type="number" value="' + item.quantity + '" min="1" readonly />'
            +     '<button type="button" data-cart-action="plus">+</button>'
            +   '</div>'
            + '</div>';
          cartItemsWrap.appendChild(row);
        });
      }

      function setCartFeedback(text) {
        if (!cartInlineFeedback) return;
        cartInlineFeedback.textContent = text || '';
      }

      function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let i = 0; i < cookies.length; i += 1) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            return decodeURIComponent(cookie.slice(name.length + 1));
          }
        }
        return '';
      }

      function clearPixPolling() {
        if (pixPollingTimer) {
          clearTimeout(pixPollingTimer);
          pixPollingTimer = null;
        }
      }

      function closePixModal() {
        clearPixPolling();
        if (!pixModal || pixModal.hidden) return;
        pixModal.hidden = true;
        pixModal.setAttribute('aria-hidden', 'true');
      }

      function openPixModal() {
        if (!pixModal) return;
        pixModal.hidden = false;
        pixModal.setAttribute('aria-hidden', 'false');
        if (pixModalClose) pixModalClose.focus();
      }

      function closeOrderSuccessModal() {
        if (!orderSuccessModal || orderSuccessModal.hidden) return;
        orderSuccessModal.hidden = true;
        orderSuccessModal.setAttribute('aria-hidden', 'true');
      }

      function openOrderSuccessModal() {
        if (!orderSuccessModal) return;
        orderSuccessModal.hidden = false;
        orderSuccessModal.setAttribute('aria-hidden', 'false');
        if (orderSuccessCloseBtn) orderSuccessCloseBtn.focus();
      }

      function showApprovedOrderSuccessModal(pedido) {
        if (!pedido) return;
        const pedidoId = String(pedido.pedido_id || pedido.id || '');
        if (pedidoId && approvedSuccessShownForPedido === pedidoId) return;
        approvedSuccessShownForPedido = pedidoId || approvedSuccessShownForPedido;
        if (orderSuccessPedidoId) orderSuccessPedidoId.textContent = pedidoId || '-';
        if (orderSuccessStatus) orderSuccessStatus.textContent = String(pedido.status_label || 'Pagamento aprovado');
        if (orderSuccessTotal) orderSuccessTotal.textContent = String(pedido.valor_total || 'R$ 0,00');
        closePixModal();
        openOrderSuccessModal();
      }

      function renderPixModal(pedido) {
        if (!pedido) return;
        pixPedidoAtual = pedido;
        if (pixPedidoIdEl) pixPedidoIdEl.textContent = String(pedido.pedido_id || pedido.id || '-');
        if (pixStatusLabelEl) pixStatusLabelEl.textContent = String(pedido.status_label || 'Aguardando pagamento');
        if (pixValorTotalEl) pixValorTotalEl.textContent = String(pedido.valor_total || 'R$ 0,00');
        if (pixCodeEl) pixCodeEl.value = String(pedido.pix_code || '');
        if (pixQrImageEl) {
          const base64 = String(pedido.qr_base64 || '');
          pixQrImageEl.src = base64 ? ('data:image/png;base64,' + base64) : '';
        }
        if (pixRefreshBtn) pixRefreshBtn.disabled = false;
        if (pixModalNote) {
          pixModalNote.textContent = pedido.status === 'pago'
            ? 'Pagamento aprovado. O pedido foi marcado como pago.'
            : 'Após pagar, aguarde alguns segundos. O status será atualizado automaticamente.';
        }
        openPixModal();
      }

      async function fetchPixStatus() {
        if (!pixPedidoAtual || !pixPedidoAtual.pedido_id || !PIX_STATUS_URL_TEMPLATE) return;
        const url = PIX_STATUS_URL_TEMPLATE.replace('/0/status/', '/' + String(pixPedidoAtual.pedido_id) + '/status/');
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin',
        });
        const data = await response.json().catch(function () { return {}; });
        if (!response.ok || !data.ok) {
          throw new Error(data.message || data.error || 'Falha ao consultar status do pedido.');
        }
        pixPedidoAtual.status = data.status;
        pixPedidoAtual.status_label = data.status_label;
        renderPixModal(pixPedidoAtual);
        if (data.is_paid) {
          cartState.items = [];
          saveCartState();
          renderCart();
          setCartFeedback('Pagamento aprovado. Seu pedido foi marcado como pago.');
          closeCartDrawer();
          clearPixPolling();
          showApprovedOrderSuccessModal(pixPedidoAtual);
        }
        return data;
      }

      function schedulePixPolling() {
        clearPixPolling();
        if (!pixPedidoAtual || pixPedidoAtual.status === 'pago') return;
        pixPollingTimer = setTimeout(function () {
          fetchPixStatus()
            .catch(function () {})
            .finally(function () {
              if (pixPedidoAtual && pixPedidoAtual.status !== 'pago' && pixModal && !pixModal.hidden) {
                schedulePixPolling();
              }
            });
        }, 5000);
      }

      async function createPixPedidoFromCart() {
        if (!PIX_CREATE_URL) throw new Error('URL de criação de pedido não configurada.');
        const payload = {
          payment_method: 'pix',
          items: (cartState.items || []).map(function (item) {
            return {
              product_id: item.product_id,
              variation_id: item.variation_id,
              quantity: item.quantity,
            };
          }),
        };
        const response = await fetch(PIX_CREATE_URL, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify(payload),
        });
        const data = await response.json().catch(function () { return {}; });
        if (!response.ok || !data.ok) {
          throw new Error(data.message || data.error || 'Não foi possível gerar o pagamento Pix.');
        }
        return data.pedido || null;
      }

      function openCartDrawer() {
        if (!cartOverlay) return;
        cartOverlay.hidden = false;
        cartOverlay.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(function () {
          cartOverlay.classList.add('is-open');
        });
      }

      function closeCartDrawer() {
        if (!cartOverlay || cartOverlay.hidden) return;
        cartOverlay.classList.remove('is-open');
        const closeNow = function () {
          cartOverlay.hidden = true;
          cartOverlay.setAttribute('aria-hidden', 'true');
          cartOverlay.removeEventListener('transitionend', closeNow);
        };
        cartOverlay.addEventListener('transitionend', closeNow);
      }

      function upsertCartItem(item) {
        const existing = cartState.items.find(function (row) { return row.key === item.key; });
        if (existing) {
          existing.quantity = Math.max(1, Number(existing.quantity || 1) + Number(item.quantity || 1));
          existing.unit_price = Number(item.unit_price || existing.unit_price || 0);
          existing.image_url = item.image_url || existing.image_url || '';
          existing.image_alt = item.image_alt || existing.image_alt || 'Foto do produto';
        } else {
          cartState.items.push(item);
        }
        saveCartState();
        renderCart();
      }

      function updateCartItemQty(itemKey, delta) {
        const item = cartState.items.find(function (row) { return row.key === itemKey; });
        if (!item) return;
        item.quantity = Math.max(1, Number(item.quantity || 1) + delta);
        saveCartState();
        renderCart();
      }

      function removeCartItem(itemKey) {
        cartState.items = cartState.items.filter(function (row) { return row.key !== itemKey; });
        saveCartState();
        renderCart();
      }

      loadCartState();

      function renderModalImage() {
        if (!modal || !modalImg) return;
        const item = modalGalleryItems[modalGalleryIndex];
        if (!item || !item.url) return;
        modalImg.src = item.url;
        modalImg.alt = item.alt || 'Visualização ampliada do produto';
        if (modalTitle) modalTitle.textContent = item.alt || 'Visualização da imagem';
        if (modalCounter) {
          if (modalGalleryItems.length > 1) {
            modalCounter.textContent = 'Foto ' + (modalGalleryIndex + 1) + ' de ' + modalGalleryItems.length;
          } else {
            modalCounter.textContent = 'Foto única';
          }
        }
        const canNavigate = modalGalleryItems.length > 1;
        if (modalPrev) modalPrev.disabled = !canNavigate;
        if (modalNext) modalNext.disabled = !canNavigate;
      }

      function openImageModalGallery(items, startIndex) {
        if (!modal || !modalImg || !items || !items.length) return;
        modalGalleryItems = items.filter(function (item) { return item && item.url; });
        if (!modalGalleryItems.length) return;
        modalGalleryIndex = Math.min(
          Math.max(parseInt(startIndex || 0, 10) || 0, 0),
          modalGalleryItems.length - 1
        );
        renderModalImage();
        modal.hidden = false;
        modal.setAttribute('aria-hidden', 'false');
        if (modalClose) modalClose.focus();
      }

      function openImageModal(url, alt) {
        openImageModalGallery([{ url: url, alt: alt }], 0);
      }

      function moveModalImage(delta) {
        if (!modalGalleryItems.length || modalGalleryItems.length <= 1) return;
        const len = modalGalleryItems.length;
        modalGalleryIndex = (modalGalleryIndex + delta + len) % len;
        renderModalImage();
      }

      function closeImageModal() {
        if (!modal || modal.hidden) return;
        modal.hidden = true;
        modal.setAttribute('aria-hidden', 'true');
        if (modalImg) modalImg.removeAttribute('src');
        modalGalleryItems = [];
        modalGalleryIndex = 0;
      }

      if (modal) {
        modal.addEventListener('click', function (event) {
          if (event.target === modal) closeImageModal();
        });
      }
      if (modalClose) {
        modalClose.addEventListener('click', closeImageModal);
      }
      if (modalPrev) modalPrev.addEventListener('click', function () { moveModalImage(-1); });
      if (modalNext) modalNext.addEventListener('click', function () { moveModalImage(1); });
      if (cartOpenBtn) {
        cartOpenBtn.addEventListener('click', function () {
          setCartFeedback('');
          openCartDrawer();
        });
      }
      if (cartCloseBtn) cartCloseBtn.addEventListener('click', closeCartDrawer);
      if (cartOverlay) {
        cartOverlay.addEventListener('click', function (event) {
          if (event.target === cartOverlay) closeCartDrawer();
        });
      }
      if (cartItemsWrap) {
        cartItemsWrap.addEventListener('click', function (event) {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const action = target.getAttribute('data-cart-action');
          if (!action) return;
          const row = target.closest('[data-cart-item-key]');
          if (!row) return;
          const itemKey = row.getAttribute('data-cart-item-key') || '';
          if (!itemKey) return;
          if (action === 'plus') {
            updateCartItemQty(itemKey, 1);
            setCartFeedback('');
          } else if (action === 'minus') {
            updateCartItemQty(itemKey, -1);
            setCartFeedback('');
          } else if (action === 'remove') {
            removeCartItem(itemKey);
            setCartFeedback('Item removido do carrinho.');
          }
        });
      }
      if (cartPaymentSelect) {
        cartPaymentSelect.addEventListener('change', function () {
          cartState.payment_method = String(cartPaymentSelect.value || '');
          saveCartState();
          renderCart();
          setCartFeedback('');
        });
      }
      if (cartFinalizeBtn) {
        cartFinalizeBtn.addEventListener('click', async function () {
          if (!cartState.items.length) {
            setCartFeedback('Adicione itens ao carrinho antes de finalizar.');
            return;
          }
          if (!String(cartState.payment_method || '').trim()) {
            setCartFeedback('Selecione a forma de pagamento para continuar.');
            return;
          }
          try {
            cartFinalizeBtn.disabled = true;
            setCartFeedback('Gerando pagamento Pix do pedido...');
            const pedidoPix = await createPixPedidoFromCart();
            if (!pedidoPix) throw new Error('Resposta inválida ao gerar pagamento.');
            renderPixModal(pedidoPix);
            if (pedidoPix.status !== 'pago') {
              schedulePixPolling();
            } else {
              cartState.items = [];
              saveCartState();
              renderCart();
              closeCartDrawer();
              showApprovedOrderSuccessModal(pedidoPix);
            }
            setCartFeedback('');
          } catch (error) {
            setCartFeedback((error && error.message) ? error.message : 'Não foi possível gerar o pagamento Pix agora.');
          } finally {
            renderCart();
          }
        });
      }
      if (pixModal) {
        pixModal.addEventListener('click', function (event) {
          if (event.target === pixModal) closePixModal();
        });
      }
      if (pixModalClose) pixModalClose.addEventListener('click', closePixModal);
      if (orderSuccessModal) {
        orderSuccessModal.addEventListener('click', function (event) {
          if (event.target === orderSuccessModal) closeOrderSuccessModal();
        });
      }
      if (orderSuccessCloseBtn) {
        orderSuccessCloseBtn.addEventListener('click', closeOrderSuccessModal);
      }
      if (pixCopyBtn) {
        pixCopyBtn.addEventListener('click', async function () {
          const text = pixCodeEl ? String(pixCodeEl.value || '') : '';
          if (!text) return;
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
            } else if (pixCodeEl) {
              pixCodeEl.select();
              document.execCommand('copy');
            }
            if (pixModalNote) pixModalNote.textContent = 'Código Pix copiado para a área de transferência.';
          } catch (error) {
            if (pixModalNote) pixModalNote.textContent = 'Não foi possível copiar automaticamente. Copie manualmente o código Pix.';
          }
        });
      }
      if (pixRefreshBtn) {
        pixRefreshBtn.addEventListener('click', async function () {
          try {
            pixRefreshBtn.disabled = true;
            if (pixModalNote) pixModalNote.textContent = 'Consultando status do pagamento...';
            await fetchPixStatus();
            if (pixPedidoAtual && pixPedidoAtual.status !== 'pago') {
              if (pixModalNote) pixModalNote.textContent = 'Pagamento ainda pendente. Continue e atualize novamente em alguns segundos.';
            }
          } catch (error) {
            if (pixModalNote) pixModalNote.textContent = (error && error.message) ? error.message : 'Falha ao consultar status do pedido.';
          } finally {
            if (pixRefreshBtn) pixRefreshBtn.disabled = false;
          }
        });
      }
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          if (orderSuccessModal && !orderSuccessModal.hidden) {
            closeOrderSuccessModal();
            return;
          }
          if (pixModal && !pixModal.hidden) {
            closePixModal();
            return;
          }
          if (modal && !modal.hidden) {
            closeImageModal();
            return;
          }
          if (cartOverlay && !cartOverlay.hidden) {
            closeCartDrawer();
            return;
          }
          closeImageModal();
          return;
        }
        if (!modal || modal.hidden) return;
        if (event.key === 'ArrowLeft') moveModalImage(-1);
        if (event.key === 'ArrowRight') moveModalImage(1);
      });

      function formatPrice(raw) {
        const value = Number(String(raw || '').replace(',', '.'));
        if (Number.isNaN(value)) return 'R$ -';
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      cards.forEach(function (card) {
        const productId = String(card.getAttribute('data-product-id') || '');
        const productTitle = String(card.getAttribute('data-product-title') || 'Produto');
        const mainImage = card.querySelector('[data-catalog-main-image]');
        const fallback = card.querySelector('[data-catalog-main-fallback]');
        const thumbsWrap = card.querySelector('[data-catalog-thumbs]');
        const variationSelect = card.querySelector('[data-catalog-variation-select]');
        const priceEl = card.querySelector('[data-catalog-price]');
        const stockEl = card.querySelector('[data-catalog-stock]');
        const qtyInput = card.querySelector('[data-catalog-qty]');
        const btnMinus = card.querySelector('[data-qty-minus]');
        const btnPlus = card.querySelector('[data-qty-plus]');
        const addBtn = card.querySelector('[data-catalog-add-btn]');
        const feedback = card.querySelector('[data-catalog-feedback]');
        const hiddenMedia = card.querySelector('[data-catalog-variant-media]');
        let currentGalleryPhotos = [];

        function getVariantUrls(variantId) {
          if (!hiddenMedia) return [];
          const source = hiddenMedia.querySelector('[data-variant-id=\"' + variantId + '\"]');
          if (!source) return [];
          return Array.from(source.querySelectorAll('[data-photo-url]')).map(function (node) {
            return {
              url: node.getAttribute('data-photo-url') || '',
              alt: node.getAttribute('data-photo-alt') || 'Foto do produto',
            };
          }).filter(function (item) { return item.url; });
        }

        function setMainPhoto(url, alt) {
          if (!mainImage || !fallback) return;
          if (url) {
            mainImage.src = url;
            mainImage.alt = alt || mainImage.alt || 'Foto do produto';
            mainImage.classList.remove('empty');
            mainImage.hidden = false;
            fallback.hidden = true;
          } else {
            mainImage.classList.add('empty');
            mainImage.hidden = true;
            fallback.hidden = false;
          }
        }

        function renderThumbs(photos) {
          if (!thumbsWrap) return;
          thumbsWrap.innerHTML = '';
          if (!photos.length) return;
          photos.forEach(function (photo, idx) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'catalog-thumb';
            btn.setAttribute('aria-label', 'Ver foto ' + (idx + 1));
            const img = document.createElement('img');
            img.src = photo.url;
            img.alt = photo.alt || ('Foto ' + (idx + 1));
            btn.appendChild(img);
            btn.addEventListener('click', function () {
              setMainPhoto(photo.url, photo.alt);
              openImageModalGallery(photos, idx);
            });
            thumbsWrap.appendChild(btn);
          });
        }

        function updateBySelection() {
          const selected = variationSelect && variationSelect.options.length
            ? variationSelect.options[variationSelect.selectedIndex]
            : null;
          if (!selected) {
            if (priceEl) priceEl.textContent = 'Selecione uma variação';
            if (stockEl) stockEl.textContent = '';
            const defaultSrc = (mainImage && mainImage.dataset.defaultSrc) || '';
            setMainPhoto(defaultSrc, mainImage ? mainImage.alt : '');
            renderThumbs([]);
            currentGalleryPhotos = defaultSrc ? [{ url: defaultSrc, alt: (mainImage && mainImage.alt) || 'Foto do produto' }] : [];
            return;
          }
          if (priceEl) priceEl.textContent = formatPrice(selected.dataset.price || '');
          if (stockEl) stockEl.textContent = selected.dataset.stockLabel || '';
          const photos = getVariantUrls(selected.dataset.variantId || selected.value);
          if (photos.length) {
            setMainPhoto(photos[0].url, photos[0].alt);
            renderThumbs(photos);
            currentGalleryPhotos = photos.slice();
          } else {
            const defaultSrc = (mainImage && mainImage.dataset.defaultSrc) || '';
            setMainPhoto(defaultSrc, mainImage ? mainImage.alt : '');
            renderThumbs([]);
            currentGalleryPhotos = defaultSrc ? [{ url: defaultSrc, alt: (mainImage && mainImage.alt) || 'Foto do produto' }] : [];
          }
        }

        function changeQty(delta) {
          if (!qtyInput) return;
          const current = parseInt(qtyInput.value || '1', 10);
          const next = Math.max(1, (Number.isNaN(current) ? 1 : current) + delta);
          qtyInput.value = String(next);
        }

        if (variationSelect) variationSelect.addEventListener('change', updateBySelection);
        if (btnMinus) btnMinus.addEventListener('click', function () { changeQty(-1); });
        if (btnPlus) btnPlus.addEventListener('click', function () { changeQty(1); });
        if (mainImage) {
          const mainWrap = card.querySelector('.catalog-main-photo-wrap');
          if (mainWrap) {
            mainWrap.style.cursor = 'zoom-in';
            mainWrap.addEventListener('click', function () {
              if (!mainImage.hidden && mainImage.getAttribute('src')) {
                const src = mainImage.getAttribute('src');
                const alt = mainImage.getAttribute('alt');
                if (currentGalleryPhotos && currentGalleryPhotos.length) {
                  let startIndex = 0;
                  for (let i = 0; i < currentGalleryPhotos.length; i += 1) {
                    if (currentGalleryPhotos[i].url === src) {
                      startIndex = i;
                      break;
                    }
                  }
                  openImageModalGallery(currentGalleryPhotos, startIndex);
                } else {
                  openImageModal(src, alt);
                }
              }
            });
          }
        }
        if (addBtn) {
          addBtn.addEventListener('click', function () {
            const selected = variationSelect && variationSelect.options.length
              ? variationSelect.options[variationSelect.selectedIndex]
              : null;
            if (!selected) {
              if (feedback) feedback.textContent = 'Selecione uma variação para continuar.';
              return;
            }
            const varLabel = selected.textContent ? selected.textContent.trim() : 'Variação';
            const qty = qtyInput ? Math.max(1, parseInt(qtyInput.value || '1', 10) || 1) : 1;
            const variationId = String(selected.value || '');
            const imageUrl = (mainImage && !mainImage.hidden && mainImage.getAttribute('src')) ? String(mainImage.getAttribute('src')) : '';
            const imageAlt = (mainImage && mainImage.getAttribute('alt')) ? String(mainImage.getAttribute('alt')) : ('Foto de ' + productTitle);
            const unitPrice = Number(String(selected.dataset.price || '').replace(',', '.')) || 0;
            const cartItem = {
              key: 'p' + productId + '-v' + variationId,
              product_id: productId,
              product_title: productTitle,
              variation_id: variationId,
              variation_label: varLabel,
              unit_price: unitPrice,
              quantity: qty,
              image_url: imageUrl,
              image_alt: imageAlt,
            };
            upsertCartItem(cartItem);
            openCartDrawer();
            if (feedback) {
              feedback.textContent = 'Adicionado ao carrinho: ' + varLabel + ' (quantidade ' + qty + ').';
            }
            setCartFeedback('');
          });
        }

        updateBySelection();
      });

      renderCart();
    })();
  </script>

  {% if loja_mode != 'responsavel' %}
  <script>
    (function () {
      const list = document.getElementById('variacoes-list');
      const template = document.getElementById('variacao-template');
      const addBtn = document.getElementById('btn-add-variacao');
      const fotosList = document.getElementById('fotos-list');
      const fotoTemplate = document.getElementById('foto-template');
      const addFotoBtn = document.getElementById('btn-add-foto');
      if (!list || !template || !addBtn || !fotosList || !fotoTemplate || !addFotoBtn) return;

      let fotoCounter = (function () {
        let max = 0;
        fotosList.querySelectorAll('.foto-row').forEach(function (row) {
          const rowId = row.getAttribute('data-row-id') || '';
          const m = rowId.match(/^foto(\d+)$/);
          if (m) max = Math.max(max, parseInt(m[1], 10));
        });
        return max || 1;
      })();

      function nextFotoRowId() {
        fotoCounter += 1;
        return 'foto' + fotoCounter;
      }

      function getVariationRows() {
        return Array.from(list.querySelectorAll('.variacao-row'));
      }

      function getVariationData() {
        return getVariationRows().map(function (row, idx) {
          const nomeInput = row.querySelector('input[name=\"variacao_nome[]\"]');
          const nome = (nomeInput && nomeInput.value || '').trim();
          return {
            value: 'v' + idx,
            label: nome || ('Variação ' + (idx + 1)),
          };
        });
      }

      function refreshFotoVariationOptions() {
        const options = getVariationData();
        fotosList.querySelectorAll('.foto-variacao-select').forEach(function (box) {
          const rowId = box.dataset.rowId || '';
          if (!rowId) return;
          const currentValues = Array.from(box.querySelectorAll('input[type="checkbox"]:checked'))
            .map(function (input) { return input.value; })
            .filter(Boolean);
          const savedValues = (box.dataset.selected || '')
            .split(',')
            .map(function (value) { return value.trim(); })
            .filter(Boolean);
          const selectedValues = currentValues.length ? currentValues : savedValues;
          const validValues = new Set(['all'].concat(options.map(function (opt) { return opt.value; })));
          const selectedSet = new Set(selectedValues.filter(function (value) { return validValues.has(value); }));

          box.innerHTML = '';
          box.classList.add('foto-variacoes-box');

          function addCheckbox(value, labelText) {
            const label = document.createElement('label');
            label.className = 'foto-variacoes-item';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'foto_variacoes__' + rowId + '[]';
            input.value = value;
            input.checked = selectedSet.has(value);
            const span = document.createElement('span');
            span.textContent = labelText;
            label.appendChild(input);
            label.appendChild(span);
            box.appendChild(label);
          }

          addCheckbox('all', 'Todas as variações');
          options.forEach(function (opt) {
            addCheckbox(opt.value, opt.label);
          });

          const hint = document.createElement('div');
          hint.className = 'foto-variacoes-hint';
          hint.textContent = 'No celular, toque para marcar. Se marcar "Todas", as outras são desmarcadas.';
          box.appendChild(hint);

          box.dataset.selected = '';
        });
      }

      function bindRemove(button) {
        button.addEventListener('click', function () {
          const rows = list.querySelectorAll('.variacao-row');
          if (rows.length <= 1) {
            rows[0].querySelectorAll('input').forEach(function (input) { input.value = ''; });
            refreshFotoVariationOptions();
            return;
          }
          const row = button.closest('.variacao-row');
          if (row) {
            row.remove();
            refreshFotoVariationOptions();
          }
        });
      }

      function resetFotoRow(row) {
        const box = row.querySelector('.foto-variacao-select');
        if (box) {
          box.querySelectorAll('input[type="checkbox"]').forEach(function (input) { input.checked = false; });
          box.dataset.selected = '';
        }
        const fileInput = row.querySelector('input[type=\"file\"]');
        if (fileInput) {
          const cleanInput = fileInput.cloneNode();
          fileInput.replaceWith(cleanInput);
        }
      }

      function bindFotoRemove(button) {
        button.addEventListener('click', function () {
          const rows = fotosList.querySelectorAll('.foto-row');
          if (rows.length <= 1) {
            resetFotoRow(rows[0]);
            return;
          }
          const row = button.closest('.foto-row');
          if (row) row.remove();
        });
      }

      list.querySelectorAll('.variacao-remove').forEach(bindRemove);
      list.addEventListener('input', function (event) {
        if (event.target && event.target.name === 'variacao_nome[]') {
          refreshFotoVariationOptions();
        }
      });

      fotosList.querySelectorAll('.foto-remove').forEach(bindFotoRemove);
      fotosList.addEventListener('change', function (event) {
        const target = event.target;
        if (!(target instanceof HTMLInputElement) || target.type !== 'checkbox') return;
        if (!target.name.includes('foto_variacoes__')) return;
        const box = target.closest('.foto-variacao-select');
        if (!box) return;
        const checkboxes = Array.from(box.querySelectorAll('input[type="checkbox"]'));
        const allInput = checkboxes.find(function (input) { return input.value === 'all'; });
        const others = checkboxes.filter(function (input) { return input.value !== 'all'; });

        if (target.value === 'all' && target.checked) {
          others.forEach(function (input) { input.checked = false; });
        } else if (target.value !== 'all' && target.checked && allInput) {
          allInput.checked = false;
        }
      });

      addBtn.addEventListener('click', function () {
        const node = template.content.firstElementChild.cloneNode(true);
        bindRemove(node.querySelector('.variacao-remove'));
        list.appendChild(node);
        refreshFotoVariationOptions();
      });

      addFotoBtn.addEventListener('click', function () {
        const rowId = nextFotoRowId();
        const html = fotoTemplate.innerHTML.replaceAll('__ROW_ID__', rowId);
        const temp = document.createElement('div');
        temp.innerHTML = html.trim();
        const node = temp.firstElementChild;
        bindFotoRemove(node.querySelector('.foto-remove'));
        fotosList.appendChild(node);
        refreshFotoVariationOptions();
      });

      refreshFotoVariationOptions();
    })();
  </script>
  {% endif %}
</body>
</html>
