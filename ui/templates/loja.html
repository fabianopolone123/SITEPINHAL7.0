<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loja</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .loja-grid { display:grid; grid-template-columns: 1fr; gap:1rem; }
    .loja-form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:.9rem; }
    .loja-form-grid .full { grid-column: 1 / -1; }
    .loja-form-grid label { display:flex; flex-direction:column; gap:.35rem; color:#334155; font-weight:600; font-size:.9rem; }
    .loja-form-grid input, .loja-form-grid textarea { width:100%; padding:.75rem .85rem; border:1px solid #cbd5e1; border-radius:10px; }
    .variacoes-wrap { border:1px solid #e2e8f0; border-radius:12px; padding:.85rem; background:#fafcff; }
    .variacoes-head { display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.75rem; }
    .variacoes-list { display:flex; flex-direction:column; gap:.55rem; }
    .variacao-row { display:grid; grid-template-columns: 1.4fr .8fr .7fr auto; gap:.5rem; align-items:center; }
    .variacao-row input { padding:.65rem .7rem; border:1px solid #cbd5e1; border-radius:10px; }
    .variacao-remove { border:1px solid #fecaca; background:#fff1f2; color:#9f1239; border-radius:10px; padding:.6rem .75rem; cursor:pointer; }
    .fotos-wrap { border:1px solid #e2e8f0; border-radius:12px; padding:.85rem; background:#fff; }
    .fotos-head { display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.75rem; }
    .fotos-list { display:flex; flex-direction:column; gap:.55rem; }
    .foto-row { display:grid; grid-template-columns: minmax(180px, 1.1fr) 1fr auto; gap:.5rem; align-items:start; }
    .foto-row input[type="file"] { width:100%; padding:.65rem .7rem; border:1px solid #cbd5e1; border-radius:10px; background:#fff; }
    .foto-variacoes-box { border:1px solid #cbd5e1; border-radius:10px; background:#fff; padding:.55rem; display:grid; gap:.35rem; max-height: 168px; overflow:auto; }
    .foto-variacoes-item { display:flex; align-items:flex-start; gap:.45rem; font-size:.86rem; color:#334155; line-height:1.25; }
    .foto-variacoes-item input { margin-top:.12rem; }
    .foto-variacoes-hint { font-size:.75rem; color:#64748b; margin-top:.15rem; }
    .foto-remove { border:1px solid #fecaca; background:#fff1f2; color:#9f1239; border-radius:10px; padding:.6rem .75rem; cursor:pointer; }
    .loja-actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:.9rem; }
    .loja-products { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; }
    .loja-card { border:1px solid #e2e8f0; border-radius:14px; background:#fff; overflow:hidden; }
    .loja-card img { width:100%; height:180px; object-fit:cover; background:#f8fafc; display:block; }
    .loja-card-body { padding:.9rem; }
    .loja-card h3 { margin:0 0 .35rem; }
    .loja-card p { color:#475569; margin:.2rem 0 .6rem; }
    .loja-prod-rule { margin:.25rem 0 .65rem; padding:.45rem .55rem; border-radius:10px; border:1px solid #dbeafe; background:#f8fbff; color:#1e3a8a; font-size:.85rem; }
    .loja-var-list { margin:0; padding-left:1rem; }
    .loja-var-list li { margin:.2rem 0; }
    .loja-fotos-mini { display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.45rem; }
    .loja-fotos-mini a { display:block; }
    .loja-fotos-mini img { width:54px; height:54px; object-fit:cover; border-radius:8px; border:1px solid #dbeafe; background:#f8fafc; }
    .loja-fotos-badge { display:inline-block; margin-top:.4rem; font-size:.76rem; color:#0f172a; background:#eff6ff; border:1px solid #dbeafe; border-radius:999px; padding:.15rem .45rem; }
    .stock-empty { color:#64748b; }
    @media (max-width: 800px) {
      .loja-form-grid { grid-template-columns: 1fr; }
      .variacao-row { grid-template-columns: 1fr; }
      .variacao-remove { width:100%; }
      .foto-row { grid-template-columns: 1fr; }
      .foto-remove { width:100%; }
    }
  </style>
</head>
<body class="painel-page">
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Loja</h2>
      <p>Cadastre produtos com foto e variações (valor e estoque opcional).</p>
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Use o botão Cadastrar produto para adicionar itens da loja.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card loja-grid">
      <h3 style="margin:0;">Cadastrar produto</h3>
      <form method="post" enctype="multipart/form-data" id="loja-form">
        {% csrf_token %}
        <div class="loja-form-grid">
          <label>
            Título
            <input type="text" name="titulo" required value="{{ form_data.titulo|default:'' }}" />
          </label>
          <div class="panel-note" style="align-self:end;">
            Cada foto cadastrada abaixo precisa ser vinculada a uma variação.
          </div>
          <label class="full">
            Descrição
            <textarea name="descricao" rows="4" placeholder="Descrição do produto (opcional)">{{ form_data.descricao|default:'' }}</textarea>
          </label>
          <label>
            Mínimo de pedidos pagos para produção (opcional)
            <input type="number" name="minimo_pedidos_pagos" min="1" step="1" value="{{ form_data.minimo_pedidos_pagos|default:'' }}" placeholder="Ex.: 10" />
          </label>
          <div class="panel-note" style="align-self:end;">
            Ex.: camiseta de atividade só vai para confecção quando atingir 10 pedidos pagos.
          </div>
        </div>

        <div class="variacoes-wrap" style="margin-top:1rem;">
          <div class="variacoes-head">
            <div>
              <strong>Variações</strong>
              <div class="panel-note">Cadastre pelo menos uma variação com valor. Ex.: P, M, G; cor; tamanho etc.</div>
            </div>
            <button type="button" class="secondary" id="btn-add-variacao">Adicionar variação</button>
          </div>
          <div class="variacoes-list" id="variacoes-list">
            {% if form_data.variacoes %}
              {% for var in form_data.variacoes %}
                <div class="variacao-row">
                  <input type="text" name="variacao_nome[]" placeholder="Variação (ex.: P / Azul)" value="{{ var.nome|default:'' }}" />
                  <input type="text" name="variacao_valor[]" placeholder="Valor" inputmode="decimal" value="{{ var.valor|default:'' }}" />
                  <input type="number" name="variacao_estoque[]" placeholder="Estoque" min="0" value="{{ var.estoque|default:'' }}" />
                  <button type="button" class="variacao-remove">Remover</button>
                </div>
              {% endfor %}
            {% else %}
              <div class="variacao-row">
                <input type="text" name="variacao_nome[]" placeholder="Variação (ex.: P / Azul)" />
                <input type="text" name="variacao_valor[]" placeholder="Valor" inputmode="decimal" />
                <input type="number" name="variacao_estoque[]" placeholder="Estoque" min="0" />
                <button type="button" class="variacao-remove">Remover</button>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="fotos-wrap" style="margin-top:1rem;">
          <div class="fotos-head">
            <div>
              <strong>Fotos do produto</strong>
              <div class="panel-note">Você pode cadastrar várias fotos. Cada foto pode ser vinculada a uma ou mais variações, ou a todas.</div>
            </div>
            <button type="button" class="secondary" id="btn-add-foto">Adicionar foto</button>
          </div>
          <div class="fotos-list" id="fotos-list">
            {% if form_data.fotos %}
              {% for row in form_data.fotos %}
                <div class="foto-row" data-row-id="{{ row.row_id|default:'foto1' }}">
                  <input type="hidden" name="foto_row_id[]" value="{{ row.row_id|default:'foto1' }}" />
                  <input type="file" name="foto_arquivo__{{ row.row_id|default:'foto1' }}" accept="image/*" />
                  <div class="foto-variacao-select" data-row-id="{{ row.row_id|default:'foto1' }}" data-selected="{{ row.variacao_refs_csv|default:'' }}"></div>
                  <button type="button" class="foto-remove">Remover</button>
                </div>
              {% endfor %}
            {% else %}
              <div class="foto-row" data-row-id="foto1">
                <input type="hidden" name="foto_row_id[]" value="foto1" />
                <input type="file" name="foto_arquivo__foto1" accept="image/*" />
                <div class="foto-variacao-select" data-row-id="foto1"></div>
                <button type="button" class="foto-remove">Remover</button>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="loja-actions">
          <button type="submit" class="primary">Cadastrar produto</button>
        </div>
      </form>
    </section>

    <section class="painel-card loja-grid">
      <h3 style="margin:0;">Produtos cadastrados</h3>
      {% if produtos %}
        <div class="loja-products">
          {% for row in produtos %}
            <article class="loja-card">
              {% if row.capa_foto %}
                <img src="{{ row.capa_foto.url }}" alt="Foto de {{ row.produto.titulo }}" />
              {% else %}
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='400'%3E%3Crect width='100%25' height='100%25' fill='%23f8fafc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2394a3b8' font-size='28'%3ESem foto%3C/text%3E%3C/svg%3E" alt="Sem foto" />
              {% endif %}
              <div class="loja-card-body">
                <h3>{{ row.produto.titulo }}</h3>
                {% if row.produto.descricao %}<p>{{ row.produto.descricao }}</p>{% endif %}
                {% if row.produto.minimo_pedidos_pagos %}
                  <div class="loja-prod-rule">
                    Produção sob pedido: mínimo de <strong>{{ row.produto.minimo_pedidos_pagos }}</strong> pedido(s) pagos.
                  </div>
                {% endif %}
                <ul class="loja-var-list">
                  {% for v in row.variacoes %}
                    <li>
                      <strong>{{ v.nome }}</strong> - R$ {{ v.valor }}
                      {% if v.estoque is not None %}
                        <span>(Estoque: {{ v.estoque }})</span>
                      {% else %}
                        <span class="stock-empty">(Estoque não informado)</span>
                      {% endif %}
                      {% if v.fotos_vinculadas %}
                        <div class="loja-fotos-badge">{{ v.fotos_vinculadas|length }} foto(s) vinculada(s)</div>
                        <div class="loja-fotos-mini">
                          {% for foto in v.fotos_vinculadas %}
                            <a href="{{ foto.foto.url }}" target="_blank" rel="noopener">
                              <img src="{{ foto.foto.url }}" alt="Foto da variação {{ v.nome }}" />
                            </a>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum produto cadastrado ainda.</p>
      {% endif %}
    </section>
  </main>

  <template id="variacao-template">
    <div class="variacao-row">
      <input type="text" name="variacao_nome[]" placeholder="Variação (ex.: P / Azul)" />
      <input type="text" name="variacao_valor[]" placeholder="Valor" inputmode="decimal" />
      <input type="number" name="variacao_estoque[]" placeholder="Estoque" min="0" />
      <button type="button" class="variacao-remove">Remover</button>
    </div>
  </template>

  <template id="foto-template">
    <div class="foto-row" data-row-id="__ROW_ID__">
      <input type="hidden" name="foto_row_id[]" value="__ROW_ID__" />
      <input type="file" name="foto_arquivo____ROW_ID__" accept="image/*" />
      <div class="foto-variacao-select" data-row-id="__ROW_ID__"></div>
      <button type="button" class="foto-remove">Remover</button>
    </div>
  </template>

  <script>
    (function () {
      const list = document.getElementById('variacoes-list');
      const template = document.getElementById('variacao-template');
      const addBtn = document.getElementById('btn-add-variacao');
      const fotosList = document.getElementById('fotos-list');
      const fotoTemplate = document.getElementById('foto-template');
      const addFotoBtn = document.getElementById('btn-add-foto');
      if (!list || !template || !addBtn || !fotosList || !fotoTemplate || !addFotoBtn) return;

      let fotoCounter = (function () {
        let max = 0;
        fotosList.querySelectorAll('.foto-row').forEach(function (row) {
          const rowId = row.getAttribute('data-row-id') || '';
          const m = rowId.match(/^foto(\d+)$/);
          if (m) max = Math.max(max, parseInt(m[1], 10));
        });
        return max || 1;
      })();

      function nextFotoRowId() {
        fotoCounter += 1;
        return 'foto' + fotoCounter;
      }

      function getVariationRows() {
        return Array.from(list.querySelectorAll('.variacao-row'));
      }

      function getVariationData() {
        return getVariationRows().map(function (row, idx) {
          const nomeInput = row.querySelector('input[name=\"variacao_nome[]\"]');
          const nome = (nomeInput && nomeInput.value || '').trim();
          return {
            value: 'v' + idx,
            label: nome || ('Variação ' + (idx + 1)),
          };
        });
      }

      function refreshFotoVariationOptions() {
        const options = getVariationData();
        fotosList.querySelectorAll('.foto-variacao-select').forEach(function (box) {
          const rowId = box.dataset.rowId || '';
          if (!rowId) return;
          const currentValues = Array.from(box.querySelectorAll('input[type="checkbox"]:checked'))
            .map(function (input) { return input.value; })
            .filter(Boolean);
          const savedValues = (box.dataset.selected || '')
            .split(',')
            .map(function (value) { return value.trim(); })
            .filter(Boolean);
          const selectedValues = currentValues.length ? currentValues : savedValues;
          const validValues = new Set(['all'].concat(options.map(function (opt) { return opt.value; })));
          const selectedSet = new Set(selectedValues.filter(function (value) { return validValues.has(value); }));

          box.innerHTML = '';
          box.classList.add('foto-variacoes-box');

          function addCheckbox(value, labelText) {
            const label = document.createElement('label');
            label.className = 'foto-variacoes-item';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'foto_variacoes__' + rowId + '[]';
            input.value = value;
            input.checked = selectedSet.has(value);
            const span = document.createElement('span');
            span.textContent = labelText;
            label.appendChild(input);
            label.appendChild(span);
            box.appendChild(label);
          }

          addCheckbox('all', 'Todas as variações');
          options.forEach(function (opt) {
            addCheckbox(opt.value, opt.label);
          });

          const hint = document.createElement('div');
          hint.className = 'foto-variacoes-hint';
          hint.textContent = 'No celular, toque para marcar. Se marcar "Todas", as outras são desmarcadas.';
          box.appendChild(hint);

          box.dataset.selected = '';
        });
      }

      function bindRemove(button) {
        button.addEventListener('click', function () {
          const rows = list.querySelectorAll('.variacao-row');
          if (rows.length <= 1) {
            rows[0].querySelectorAll('input').forEach(function (input) { input.value = ''; });
            refreshFotoVariationOptions();
            return;
          }
          const row = button.closest('.variacao-row');
          if (row) {
            row.remove();
            refreshFotoVariationOptions();
          }
        });
      }

      function resetFotoRow(row) {
        const box = row.querySelector('.foto-variacao-select');
        if (box) {
          box.querySelectorAll('input[type="checkbox"]').forEach(function (input) { input.checked = false; });
          box.dataset.selected = '';
        }
        const fileInput = row.querySelector('input[type=\"file\"]');
        if (fileInput) {
          const cleanInput = fileInput.cloneNode();
          fileInput.replaceWith(cleanInput);
        }
      }

      function bindFotoRemove(button) {
        button.addEventListener('click', function () {
          const rows = fotosList.querySelectorAll('.foto-row');
          if (rows.length <= 1) {
            resetFotoRow(rows[0]);
            return;
          }
          const row = button.closest('.foto-row');
          if (row) row.remove();
        });
      }

      list.querySelectorAll('.variacao-remove').forEach(bindRemove);
      list.addEventListener('input', function (event) {
        if (event.target && event.target.name === 'variacao_nome[]') {
          refreshFotoVariationOptions();
        }
      });

      fotosList.querySelectorAll('.foto-remove').forEach(bindFotoRemove);
      fotosList.addEventListener('change', function (event) {
        const target = event.target;
        if (!(target instanceof HTMLInputElement) || target.type !== 'checkbox') return;
        if (!target.name.includes('foto_variacoes__')) return;
        const box = target.closest('.foto-variacao-select');
        if (!box) return;
        const checkboxes = Array.from(box.querySelectorAll('input[type="checkbox"]'));
        const allInput = checkboxes.find(function (input) { return input.value === 'all'; });
        const others = checkboxes.filter(function (input) { return input.value !== 'all'; });

        if (target.value === 'all' && target.checked) {
          others.forEach(function (input) { input.checked = false; });
        } else if (target.value !== 'all' && target.checked && allInput) {
          allInput.checked = false;
        }
      });

      addBtn.addEventListener('click', function () {
        const node = template.content.firstElementChild.cloneNode(true);
        bindRemove(node.querySelector('.variacao-remove'));
        list.appendChild(node);
        refreshFotoVariationOptions();
      });

      addFotoBtn.addEventListener('click', function () {
        const rowId = nextFotoRowId();
        const html = fotoTemplate.innerHTML.replaceAll('__ROW_ID__', rowId);
        const temp = document.createElement('div');
        temp.innerHTML = html.trim();
        const node = temp.firstElementChild;
        bindFotoRemove(node.querySelector('.foto-remove'));
        fotosList.appendChild(node);
        refreshFotoVariationOptions();
      });

      refreshFotoVariationOptions();
    })();
  </script>
</body>
</html>
