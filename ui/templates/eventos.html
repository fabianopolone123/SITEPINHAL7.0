<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eventos</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .event-top-actions {
      margin-top: 0.85rem;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .event-status-chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.2rem 0.55rem;
      font-size: 0.78rem;
      font-weight: 700;
      color: #1e293b;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      margin-bottom: 0.45rem;
    }
    .event-fields {
      display: grid;
      gap: 0.6rem;
      margin-top: 0.4rem;
    }
    .event-field-row {
      display: grid;
      grid-template-columns: minmax(180px, 1fr) minmax(120px, 180px) auto;
      gap: 0.55rem;
      align-items: center;
    }
    .event-field-row button {
      margin-top: 0;
      padding: 0.55rem 0.7rem;
      min-height: 40px;
    }
    .event-list {
      display: grid;
      gap: 0.8rem;
    }
    .event-item {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #fff;
      padding: 0.8rem;
    }
    .event-item h4 {
      margin-bottom: 0.25rem;
    }
    .event-meta {
      color: #475569;
      font-size: 0.9rem;
      margin-bottom: 0.55rem;
    }
    .event-fields-list {
      list-style: none;
      display: grid;
      gap: 0.35rem;
    }
    .event-field-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.2rem 0.55rem;
      border: 1px solid #cbd5e1;
      border-radius: 999px;
      background: #f8fafc;
      width: fit-content;
      font-size: 0.86rem;
    }
    .event-field-type {
      color: #1d4ed8;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.03em;
    }
    .preset-list {
      display: grid;
      gap: 0.45rem;
    }
    .preset-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 0.45rem 0.65rem;
      background: #fff;
      font-size: 0.9rem;
    }
    .event-modal .modal-content {
      width: min(860px, 96vw);
      max-height: 88vh;
      overflow: auto;
    }
    @media (max-width: 900px) {
      .event-field-row {
        grid-template-columns: 1fr;
      }
      .event-field-row button {
        width: 100%;
      }
    }
  </style>
</head>
<body class="painel-page">
  {{ presets_json|json_script:"event-presets-data" }}
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Eventos</h2>
      <p>Cadastre eventos e monte os campos de cada evento (ex.: Local, Data, Hora, Comentário).</p>
      <div class="event-top-actions">
        <button type="button" class="primary" id="open-create-event">Criar novo evento</button>
      </div>
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          <p data-state="info">Clique em "Criar novo evento" para começar.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <h3>Pré-configurações salvas</h3>
      <div class="preset-list">
        {% for preset in presets %}
          <div class="preset-item">
            <span>
              <strong>{{ preset.preset_name }}</strong>
              {% if preset.event_name %} | Evento: {{ preset.event_name }}{% endif %}
            </span>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_preset" />
              <input type="hidden" name="preset_id" value="{{ preset.id }}" />
              <button type="submit" class="secondary">Excluir</button>
            </form>
          </div>
        {% empty %}
          <p class="panel-note">Nenhuma pré-configuração salva.</p>
        {% endfor %}
      </div>
    </section>

    <section class="painel-card">
      <h3>Eventos cadastrados</h3>
      <div class="event-list">
        {% for row in eventos %}
          {% with evento=row.evento %}
            <article class="event-item">
              <span class="event-status-chip">{{ row.relative_label }}</span>
              <h4>{{ evento.name }}</h4>
              <p class="event-meta">
                Tipo: {{ evento.event_type|default:"-" }} |
                Data do evento: {{ evento.event_date|date:"d/m/Y"|default:"-" }} |
                Hora do evento: {{ evento.event_time|time:"H:i"|default:"-" }} |
                Criado por: {{ evento.created_by.username|default:"sistema" }} |
                Data do cadastro: {{ evento.created_at|date:"d/m/Y H:i" }}
              </p>
              {% if evento.fields_data %}
                <ul class="event-fields-list">
                  {% for campo in evento.fields_data %}
                    <li class="event-field-pill">
                      <span>{{ campo.name|default:campo.label|default:"Campo" }}</span>
                      <span class="event-field-type">{{ campo.type|default:"texto" }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="panel-note">Sem campos adicionais.</p>
              {% endif %}
              <form method="post" class="action-row">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_event" />
                <input type="hidden" name="event_id" value="{{ evento.id }}" />
                <button type="submit" class="secondary js-confirm-delete-event">Excluir evento</button>
              </form>
            </article>
          {% endwith %}
        {% empty %}
          <p class="panel-note">Nenhum evento cadastrado até agora.</p>
        {% endfor %}
      </div>
    </section>
  </main>

  <div class="modal event-modal" id="event-modal" aria-hidden="true">
    <div class="modal-content">
      <header>
        <h3>Criar novo evento</h3>
        <button type="button" id="close-event-modal" aria-label="Fechar">×</button>
      </header>

      <form method="post" id="event-form">
        {% csrf_token %}
        <input type="hidden" name="action" id="event-action" value="create_event" />

        <div class="field-section">
          <label>
            Carregar pré-configuração
            <select id="preset-select">
              <option value="">-- selecionar --</option>
              {% for preset in presets %}
                <option value="{{ preset.id }}">{{ preset.preset_name }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            Nome para salvar esta configuração
            <input type="text" name="preset_name" id="preset-name" placeholder="Ex.: Reunião padrão do clube" />
          </label>
        </div>

        <div class="field-section">
          <label>
            Nome do evento *
            <input type="text" name="name" id="event-name" placeholder="Ex.: Reunião mensal de pais" required />
          </label>
          <label>
            Tipo do evento (opcional)
            <input type="text" name="event_type" id="event-type" placeholder="Ex.: reunião, vendas, acampamento" />
          </label>
          <label>
            Data do evento *
            <input type="date" name="event_date" id="event-date" required />
          </label>
          <label>
            Hora do evento *
            <input type="time" name="event_time" id="event-time" required />
          </label>
        </div>

        <div class="field-section">
          <h3>Campos do evento</h3>
          <p class="panel-note">Use o botão + para adicionar os campos que esse evento precisa.</p>

          <div class="event-fields" id="event-fields">
            <div class="event-field-row">
              <input type="text" name="field_name[]" placeholder="Nome do campo (ex.: Local)" />
              <select name="field_type[]">
                <option value="texto">Texto</option>
                <option value="data">Data</option>
                <option value="hora">Hora</option>
                <option value="numero">Número</option>
                <option value="booleano">Sim/Não</option>
              </select>
              <button type="button" class="secondary remove-field" disabled>Remover</button>
            </div>
          </div>

          <div class="action-row">
            <button type="button" class="secondary" id="add-field">+ Adicionar campo</button>
          </div>
        </div>

        <div class="action-row">
          <button type="submit" class="primary" id="save-event-btn">Salvar evento</button>
          <button type="button" class="secondary" id="save-preset-btn">Salvar pré-configuração</button>
          <button type="button" class="secondary" id="cancel-event-modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById('event-modal');
      const openBtn = document.getElementById('open-create-event');
      const closeBtn = document.getElementById('close-event-modal');
      const cancelBtn = document.getElementById('cancel-event-modal');
      const fieldsContainer = document.getElementById('event-fields');
      const addButton = document.getElementById('add-field');
      const form = document.getElementById('event-form');
      const actionInput = document.getElementById('event-action');
      const saveEventBtn = document.getElementById('save-event-btn');
      const savePresetBtn = document.getElementById('save-preset-btn');
      const presetSelect = document.getElementById('preset-select');
      const presetsNode = document.getElementById('event-presets-data');
      const presets = presetsNode ? JSON.parse(presetsNode.textContent || '[]') : [];

      const openModal = () => {
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
      };

      const closeModal = () => {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
      };

      const createFieldRow = (nameValue, typeValue) => {
        const row = document.createElement('div');
        row.className = 'event-field-row';
        row.innerHTML = '' +
          '<input type="text" name="field_name[]" placeholder="Nome do campo" />' +
          '<select name="field_type[]">' +
            '<option value="texto">Texto</option>' +
            '<option value="data">Data</option>' +
            '<option value="hora">Hora</option>' +
            '<option value="numero">Número</option>' +
            '<option value="booleano">Sim/Não</option>' +
          '</select>' +
          '<button type="button" class="secondary remove-field">Remover</button>';
        const input = row.querySelector('input[name="field_name[]"]');
        const select = row.querySelector('select[name="field_type[]"]');
        if (input) input.value = nameValue || '';
        if (select && typeValue) select.value = typeValue;
        return row;
      };

      const clearFieldsToDefault = () => {
        fieldsContainer.innerHTML = '';
        fieldsContainer.appendChild(createFieldRow('', 'texto'));
        attachRemoveHandlers();
      };

      const loadPreset = (presetId) => {
        const preset = presets.find((item) => String(item.id) === String(presetId));
        if (!preset) return;
        document.getElementById('event-name').value = preset.event_name || '';
        document.getElementById('event-type').value = preset.event_type || '';
        document.getElementById('event-date').value = preset.event_date || '';
        document.getElementById('event-time').value = preset.event_time || '';
        fieldsContainer.innerHTML = '';
        const rows = Array.isArray(preset.fields_data) ? preset.fields_data : [];
        if (!rows.length) {
          fieldsContainer.appendChild(createFieldRow('', 'texto'));
        } else {
          rows.forEach((field) => {
            fieldsContainer.appendChild(createFieldRow(field.name || field.label || '', field.type || 'texto'));
          });
        }
        attachRemoveHandlers();
      };

      const attachRemoveHandlers = () => {
        const rows = fieldsContainer.querySelectorAll('.event-field-row');
        rows.forEach((row) => {
          const btn = row.querySelector('.remove-field');
          if (!btn) return;
          btn.disabled = rows.length <= 1;
          btn.onclick = () => {
            row.remove();
            attachRemoveHandlers();
          };
        });
      };

      if (openBtn) openBtn.addEventListener('click', openModal);
      if (closeBtn) closeBtn.addEventListener('click', closeModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal();
      });

      if (!fieldsContainer || !addButton || !form || !actionInput) return;

      addButton.addEventListener('click', () => {
        fieldsContainer.appendChild(createFieldRow('', 'texto'));
        attachRemoveHandlers();
      });

      if (presetSelect) {
        presetSelect.addEventListener('change', (event) => {
          const selected = (event.target.value || '').trim();
          if (!selected) return;
          loadPreset(selected);
        });
      }

      if (saveEventBtn) {
        saveEventBtn.addEventListener('click', () => {
          actionInput.value = 'create_event';
        });
      }

      if (savePresetBtn) {
        savePresetBtn.addEventListener('click', () => {
          actionInput.value = 'save_preset';
          form.requestSubmit();
        });
      }

      clearFieldsToDefault();

      const deleteButtons = document.querySelectorAll('.js-confirm-delete-event');
      deleteButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          const ok = window.confirm('Tem certeza que deseja excluir este evento?');
          if (!ok) {
            event.preventDefault();
          }
        });
      });
    })();
  </script>
</body>
</html>
