<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Presença</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .attendance-toolbar {
      display: grid;
      gap: 0.65rem;
      grid-template-columns: 1fr;
    }
    .attendance-control-card {
      border: 1px solid #dbeafe;
      background: linear-gradient(180deg, #f8fbff 0%, #eef6ff 100%);
      border-radius: 12px;
      padding: 0.7rem;
    }
    .attendance-control-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #1e3a8a;
      font-weight: 800;
      margin-bottom: 0.35rem;
    }
    .event-highlight-list {
      display: grid;
      gap: 0.45rem;
      margin: 0.75rem 0 0.35rem;
    }
    .event-highlight-item {
      border: 1px solid #cbd5e1;
      border-left-width: 5px;
      border-radius: 10px;
      background: #fff;
      padding: 0.5rem 0.65rem;
      display: grid;
      gap: 0.2rem;
      text-decoration: none;
      color: #0f172a;
    }
    .event-highlight-item.is-selected {
      box-shadow: 0 0 0 2px #2563eb inset;
      background: #eff6ff;
    }
    .event-highlight-meta {
      font-size: 0.82rem;
      color: #475569;
    }
    .status-hoje {
      border-left-color: #16a34a;
      background: #f0fdf4;
    }
    .status-amanha {
      border-left-color: #2563eb;
      background: #eff6ff;
    }
    .status-futuro {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    .status-passado {
      border-left-color: #64748b;
      background: #f8fafc;
    }
    .status-sem_data {
      border-left-color: #94a3b8;
      background: #f8fafc;
    }
    .attendance-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.65rem;
      flex-wrap: wrap;
      margin-top: 0.6rem;
    }
    .attendance-chip {
      border: 1px solid #1d4ed8;
      color: #1d4ed8;
      background: #eff6ff;
      border-radius: 999px;
      padding: 0.2rem 0.55rem;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .event-status-badge {
      display: inline-flex;
      width: fit-content;
      border-radius: 999px;
      padding: 0.12rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 800;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #1f2937;
      margin-bottom: 0.2rem;
    }
    .event-status-badge.status-hoje {
      border-color: #16a34a;
      color: #166534;
      background: #dcfce7;
    }
    .event-status-badge.status-amanha {
      border-color: #2563eb;
      color: #1d4ed8;
      background: #dbeafe;
    }
    .event-status-badge.status-futuro {
      border-color: #f59e0b;
      color: #92400e;
      background: #fef3c7;
    }
    .event-status-badge.status-passado {
      border-color: #94a3b8;
      color: #334155;
      background: #e2e8f0;
    }
    .event-status-badge.status-sem_data {
      border-color: #94a3b8;
      color: #334155;
      background: #e2e8f0;
    }
    .attendance-list {
      display: grid;
      gap: 0.55rem;
      margin-top: 0.8rem;
    }
    .attendance-row {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.65rem;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.7rem;
      align-items: center;
      background: #fff;
    }
    .attendance-person {
      display: grid;
      grid-template-columns: 52px 1fr;
      gap: 0.65rem;
      align-items: center;
      min-width: 0;
    }
    .attendance-avatar {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
    }
    .attendance-avatar-trigger {
      border: 0;
      padding: 0;
      margin: 0;
      background: transparent;
      border-radius: 12px;
      line-height: 0;
      cursor: zoom-in;
    }
    .attendance-avatar-trigger:focus-visible {
      outline: 3px solid rgba(59, 130, 246, .38);
      outline-offset: 2px;
    }
    .attendance-avatar-placeholder {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      border: 1px dashed #cbd5e1;
      background: #f8fafc;
      color: #64748b;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.1;
      padding: 0.2rem;
    }
    .attendance-person-info {
      min-width: 0;
    }
    .attendance-row.present {
      border-color: #16a34a;
      background: #f0fdf4;
    }
    .attendance-name {
      font-weight: 700;
      color: #0f172a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .attendance-meta {
      font-size: 0.82rem;
      color: #475569;
    }
    .presence-toggle {
      min-width: 110px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
      padding: 0.55rem 0.75rem;
      cursor: pointer;
    }
    .presence-toggle.is-present {
      background: #16a34a;
      border-color: #15803d;
      color: #fff;
    }
    .presence-toggle:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    .resp-presence-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 0.85rem;
      margin-top: 0.4rem;
    }
    .resp-presence-card {
      border: 1px solid #dbeafe;
      border-radius: 14px;
      background: #fff;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
    }
    .resp-presence-card summary {
      list-style: none;
      cursor: pointer;
      padding: 0.75rem;
      display: grid;
      grid-template-columns: 60px 1fr auto;
      gap: 0.75rem;
      align-items: center;
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
    }
    .resp-presence-card summary::-webkit-details-marker { display: none; }
    .resp-presence-avatar {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid #bfdbfe;
      background: #f8fafc;
      display: block;
    }
    .resp-presence-avatar-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      border: 1px dashed #cbd5e1;
      background: #f8fafc;
      color: #64748b;
      display: grid;
      place-items: center;
      text-align: center;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 0.25rem;
      line-height: 1.1;
    }
    .resp-presence-main { min-width: 0; display: grid; gap: 0.15rem; }
    .resp-presence-name {
      color: #0f172a;
      font-weight: 800;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .resp-presence-sub { color: #475569; font-size: 0.82rem; }
    .resp-presence-badges { display: grid; justify-items: end; gap: 0.35rem; }
    .resp-presence-chip {
      border-radius: 999px;
      padding: 0.16rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 800;
      white-space: nowrap;
      border: 1px solid #dbeafe;
      color: #1d4ed8;
      background: #eff6ff;
    }
    .resp-presence-toggle-indicator {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      display: grid;
      place-items: center;
      color: #1d4ed8;
      font-weight: 900;
      background: #fff;
    }
    .resp-presence-toggle-indicator::before { content: "+"; }
    .resp-presence-card[open] .resp-presence-toggle-indicator { background: #eff6ff; }
    .resp-presence-card[open] .resp-presence-toggle-indicator::before { content: "-"; }
    .resp-presence-detail {
      border-top: 1px solid #e2e8f0;
      padding: 0.75rem;
      display: grid;
      gap: 0.6rem;
      background: #fff;
    }
    .resp-presence-detail-head { color: #334155; font-size: 0.84rem; font-weight: 700; }
    .resp-presence-events { display: grid; gap: 0.45rem; }
    .resp-presence-event-row {
      border: 1px solid #e2e8f0;
      border-left-width: 4px;
      border-radius: 10px;
      background: #fff;
      padding: 0.55rem 0.6rem;
      display: grid;
      gap: 0.2rem;
    }
    .resp-presence-event-row.status-hoje { border-left-color: #16a34a; }
    .resp-presence-event-row.status-amanha { border-left-color: #2563eb; }
    .resp-presence-event-row.status-futuro { border-left-color: #f59e0b; }
    .resp-presence-event-row.status-passado,
    .resp-presence-event-row.status-sem_data { border-left-color: #64748b; }
    .resp-presence-event-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
      color: #0f172a;
      font-weight: 700;
    }
    .resp-presence-event-meta { color: #475569; font-size: 0.8rem; }
    .resp-presence-presence-badge {
      border-radius: 999px;
      padding: 0.14rem 0.48rem;
      font-size: 0.74rem;
      font-weight: 800;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #334155;
      white-space: nowrap;
    }
    .resp-presence-presence-badge.is-present {
      border-color: #16a34a;
      background: #dcfce7;
      color: #166534;
    }
    .resp-presence-event-audit { color: #64748b; font-size: 0.75rem; }
    @media (max-width: 800px) {
      .attendance-row {
        grid-template-columns: 1fr;
      }
      .presence-toggle {
        width: 100%;
      }
      .resp-presence-card summary {
        grid-template-columns: 56px 1fr;
      }
      .resp-presence-badges {
        grid-column: 1 / -1;
        justify-items: start;
        grid-template-columns: auto auto;
      }
    }
    .presence-photo-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1200;
    }
    .presence-photo-modal.is-open {
      display: flex;
    }
    .presence-photo-content {
      width: min(92vw, 640px);
      background: #fff;
      border-radius: 14px;
      border: 1px solid #cbd5e1;
      box-shadow: 0 22px 50px rgba(15, 23, 42, .35);
      overflow: hidden;
    }
    .presence-photo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .6rem;
      padding: .6rem .8rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    .presence-photo-title {
      font-weight: 700;
      color: #0f172a;
      font-size: .95rem;
    }
    .presence-photo-close {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      padding: .25rem .55rem;
      font-weight: 800;
      color: #0f172a;
    }
    .presence-photo-body {
      padding: .7rem;
      display: grid;
      place-items: center;
      background: #fff;
    }
    .presence-photo-image {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
    }
  </style>
</head>
<body class="painel-page">
  {% if presenca_mode != 'responsavel' %}
    {{ presencas_json|json_script:"presencas-init-data" }}
  {% endif %}
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Presença</h2>
      {% if presenca_mode == 'responsavel' %}
        <p>Veja a presença dos aventureiros do seu cadastro em todos os eventos.</p>
      {% else %}
        <p>Selecione o evento e marque presença de forma rápida no celular.</p>
      {% endif %}
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          {% if presenca_mode == 'responsavel' %}
            <p data-state="info">Clique em um aventureiro para ver todos os eventos e a situação de presença.</p>
          {% else %}
            <p data-state="info">Eventos de hoje e amanhã aparecem primeiro.</p>
          {% endif %}
        {% endfor %}
      </div>
    </section>

    {% if presenca_mode == 'responsavel' %}
    <section class="painel-card">
      {% if aventureiro_cards %}
        <div class="resp-presence-grid">
          {% for card in aventureiro_cards %}
            <details class="resp-presence-card">
              <summary>
                {% if card.foto_url %}
                  <img src="{{ card.foto_url }}" alt="Foto de {{ card.aventureiro.nome }}" class="resp-presence-avatar" loading="lazy" />
                {% else %}
                  <div class="resp-presence-avatar-placeholder">Sem foto</div>
                {% endif %}
                <div class="resp-presence-main">
                  <div class="resp-presence-name">{{ card.aventureiro.nome }}</div>
                  <div class="resp-presence-sub">{{ card.total_presentes }}/{{ card.total_eventos }} evento(s) com presença</div>
                </div>
                <div class="resp-presence-badges">
                  <span class="resp-presence-chip">Eventos: {{ card.total_eventos }}</span>
                  <span class="resp-presence-toggle-indicator" aria-hidden="true"></span>
                </div>
              </summary>
              <div class="resp-presence-detail">
                <div class="resp-presence-detail-head">Histórico de eventos e presença</div>
                {% if card.eventos_status %}
                  <div class="resp-presence-events">
                    {% for item in card.eventos_status %}
                      <article class="resp-presence-event-row status-{{ item.status_key }}">
                        <div class="resp-presence-event-title">
                          <span>{{ item.evento.name }}</span>
                          <span class="resp-presence-presence-badge {% if item.presente %}is-present{% endif %}">
                            {{ item.presenca_label }}
                          </span>
                        </div>
                        <div class="resp-presence-event-meta">
                          {{ item.relative_label }} | {{ item.evento.event_date|date:"d/m/Y"|default:"sem data" }} {{ item.evento.event_time|time:"H:i"|default:"" }}
                        </div>
                        {% if item.updated_at %}
                          <div class="resp-presence-event-audit">
                            Atualizado em {{ item.updated_at|date:"d/m/Y H:i" }}{% if item.updated_by %} por {{ item.updated_by }}{% endif %}
                          </div>
                        {% endif %}
                      </article>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="panel-note">Nenhum evento cadastrado ainda.</p>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum aventureiro vinculado ao seu cadastro.</p>
      {% endif %}
    </section>
    {% else %}
    <section class="painel-card">
      <div class="attendance-toolbar">
        <div class="attendance-control-card">
          <div class="attendance-control-title">Evento</div>
          <label for="evento-select">
            <select id="evento-select">
              {% for row in eventos %}
                <option value="{{ row.evento.id }}" {% if selected_event and selected_event.id == row.evento.id %}selected{% endif %}>
                  {{ row.relative_label }} | {{ row.evento.name }} | {{ row.evento.event_date|date:"d/m/Y"|default:"sem data" }} {{ row.evento.event_time|time:"H:i"|default:"" }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>
        <div class="attendance-control-card">
          <div class="attendance-control-title">Buscar aventureiro</div>
          <label for="attendance-search">
            <input
              type="text"
              id="attendance-search"
              list="attendance-search-suggestions"
              autocomplete="off"
              placeholder="Digite nome, responsável ou username"
            />
          </label>
          <datalist id="attendance-search-suggestions"></datalist>
        </div>
      </div>

      <div class="event-highlight-list">
        {% for row in eventos %}
          <a href="?evento={{ row.evento.id }}" class="event-highlight-item status-{{ row.status_key }} {% if selected_event and selected_event.id == row.evento.id %}is-selected{% endif %}">
            <span class="event-status-badge status-{{ row.status_key }}">{{ row.relative_label }}</span>
            <strong>{{ row.evento.name }}</strong>
            <span class="event-highlight-meta">{{ row.evento.event_date|date:"d/m/Y"|default:"sem data" }} {{ row.evento.event_time|time:"H:i"|default:"" }}</span>
          </a>
        {% endfor %}
      </div>

      {% if selected_event %}
        <div class="attendance-summary">
          <div>
            {% if selected_event_row %}
              <span class="event-status-badge status-{{ selected_event_row.status_key }}">{{ selected_event_row.relative_label }}</span>
            {% endif %}
            <strong id="current-event-name">{{ selected_event.name }}</strong>
          </div>
          <span class="attendance-chip" id="attendance-counter">{{ present_count }}/{{ total_count }} presentes</span>
          <small id="last-sync-label">Sincronizando...</small>
        </div>
        <div class="attendance-list" id="attendance-list">
          {% for av in aventureiros %}
            <article
              class="attendance-row"
              data-aventureiro-id="{{ av.id }}"
              data-search="{{ av.nome|lower }} {{ av.responsavel.responsavel_nome|default:''|lower }} {{ av.responsavel.user.username|lower }}"
              data-name-display="{{ av.nome }}"
              data-responsavel-display="{{ av.responsavel.responsavel_nome|default:'' }}"
              data-username-display="{{ av.responsavel.user.username }}"
            >
              <div class="attendance-person">
                {% if av.presenca_foto_url %}
                  <button
                    type="button"
                    class="attendance-avatar-trigger js-open-presence-photo"
                    data-photo-url="{{ av.presenca_foto_url }}"
                    data-photo-title="Foto de {{ av.nome|escape }}"
                    aria-label="Ampliar foto de {{ av.nome }}"
                  >
                    <img src="{{ av.presenca_foto_url }}" alt="Foto de {{ av.nome }}" class="attendance-avatar" loading="lazy" />
                  </button>
                {% else %}
                  <div class="attendance-avatar-placeholder">Sem foto</div>
                {% endif %}
                <div class="attendance-person-info">
                  <div class="attendance-name">{{ av.nome }}</div>
                  <div class="attendance-meta">
                    Responsável: {{ av.responsavel.responsavel_nome|default:"-" }} | Usuário: {{ av.responsavel.user.username }}
                  </div>
                </div>
              </div>
              <button type="button" class="presence-toggle" data-aventureiro-id="{{ av.id }}">
                Ausente
              </button>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum evento cadastrado ainda.</p>
      {% endif %}
    </section>
    {% endif %}
  </main>

  {% if presenca_mode != 'responsavel' %}
  <div class="presence-photo-modal" id="presence-photo-modal" aria-hidden="true">
    <div class="presence-photo-content" role="dialog" aria-modal="true" aria-labelledby="presence-photo-title">
      <div class="presence-photo-header">
        <div class="presence-photo-title" id="presence-photo-title">Foto do aventureiro</div>
        <button type="button" class="presence-photo-close" id="presence-photo-close" aria-label="Fechar">Fechar</button>
      </div>
      <div class="presence-photo-body">
        <img id="presence-photo-image" class="presence-photo-image" src="" alt="Foto ampliada do aventureiro" />
      </div>
    </div>
  </div>
  <script>
    (function () {
      const eventSelect = document.getElementById('evento-select');
      const searchInput = document.getElementById('attendance-search');
      const searchSuggestionsNode = document.getElementById('attendance-search-suggestions');
      const listNode = document.getElementById('attendance-list');
      const counterNode = document.getElementById('attendance-counter');
      const lastSyncNode = document.getElementById('last-sync-label');
      const initNode = document.getElementById('presencas-init-data');
      const photoModal = document.getElementById('presence-photo-modal');
      const photoImage = document.getElementById('presence-photo-image');
      const photoTitle = document.getElementById('presence-photo-title');
      const photoClose = document.getElementById('presence-photo-close');
      let presencas = {};

      const parseInitData = () => {
        if (!initNode) return {};
        try {
          const parsed = JSON.parse(initNode.textContent || '{}');
          return (parsed && typeof parsed === 'object') ? parsed : {};
        } catch (_error) {
          return {};
        }
      };

      const getCookie = (name) => {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : '';
      };

      const selectedEventId = () => (eventSelect ? (eventSelect.value || '').trim() : '');
      const normalizeSearchText = (value) => (
        String(value || '')
          .toLocaleLowerCase('pt-BR')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9\s]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
      );

      const applyRowState = (row, payload) => {
        if (!row) return;
        const button = row.querySelector('.presence-toggle');
        const isPresent = !!(payload && payload.presente);
        row.classList.toggle('present', isPresent);
        if (button) {
          button.classList.toggle('is-present', isPresent);
          button.textContent = isPresent ? 'Presente' : 'Ausente';
        }
      };

      const refreshCounter = () => {
        if (!counterNode || !listNode) return;
        const rows = listNode.querySelectorAll('.attendance-row');
        const present = listNode.querySelectorAll('.attendance-row.present').length;
        counterNode.textContent = present + '/' + rows.length + ' presentes';
      };

      const applyAllRows = () => {
        if (!listNode) return;
        const rows = listNode.querySelectorAll('.attendance-row');
        rows.forEach((row) => {
          const avId = row.getAttribute('data-aventureiro-id');
          applyRowState(row, presencas[String(avId)] || { presente: false });
        });
        refreshCounter();
      };

      const filterRows = () => {
        if (!listNode || !searchInput) return;
        const term = normalizeSearchText(searchInput.value || '');
        listNode.querySelectorAll('.attendance-row').forEach((row) => {
          const cached = row.getAttribute('data-search-normalized');
          const haystack = cached || normalizeSearchText(row.getAttribute('data-search') || '');
          if (!cached) {
            row.setAttribute('data-search-normalized', haystack);
          }
          row.style.display = (!term || haystack.includes(term)) ? '' : 'none';
        });
      };

      const buildSearchSuggestions = () => {
        if (!listNode || !searchSuggestionsNode) return;
        const uniqueValues = new Map();
        listNode.querySelectorAll('.attendance-row').forEach((row) => {
          [
            row.getAttribute('data-name-display'),
            row.getAttribute('data-responsavel-display'),
            row.getAttribute('data-username-display'),
          ].forEach((rawValue) => {
            const value = (rawValue || '').trim();
            if (!value) return;
            const key = normalizeSearchText(value);
            if (!key) return;
            if (!uniqueValues.has(key)) {
              uniqueValues.set(key, value);
            }
          });
        });
        const sortedValues = Array.from(uniqueValues.values()).sort((a, b) => a.localeCompare(b, 'pt-BR'));
        searchSuggestionsNode.innerHTML = '';
        sortedValues.forEach((value) => {
          const option = document.createElement('option');
          option.value = value;
          searchSuggestionsNode.appendChild(option);
        });
      };

      const updateLastSync = () => {
        if (!lastSyncNode) return;
        const now = new Date();
        lastSyncNode.textContent = 'Atualizado às ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      };

      const fetchPresence = () => {
        const eventId = selectedEventId();
        if (!eventId || !listNode) return Promise.resolve();
        return fetch("{% url 'accounts:presenca_status_api' %}?evento_id=" + encodeURIComponent(eventId), {
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data || !data.ok) return;
            presencas = data.presencas || {};
            applyAllRows();
            updateLastSync();
          })
          .catch(() => {});
      };

      const sendToggle = (button) => {
        const eventId = selectedEventId();
        const avId = button.getAttribute('data-aventureiro-id');
        if (!eventId || !avId) return;
        const current = presencas[String(avId)] || { presente: false };
        const nextPresent = !current.presente;
        button.disabled = true;
        const formData = new FormData();
        formData.append('evento_id', eventId);
        formData.append('aventureiro_id', avId);
        formData.append('presente', nextPresent ? '1' : '0');
        fetch("{% url 'accounts:presenca_toggle_api' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data || !data.ok) return;
            presencas[String(avId)] = {
              presente: !!data.presente,
              updated_at: data.updated_at || '',
              updated_by: data.updated_by || '',
            };
            applyAllRows();
            updateLastSync();
          })
          .catch(() => {})
          .finally(() => {
            button.disabled = false;
          });
      };

      if (eventSelect) {
        eventSelect.addEventListener('change', () => {
          const eventId = selectedEventId();
          if (!eventId) return;
          const url = new URL(window.location.href);
          url.searchParams.set('evento', eventId);
          window.location.href = url.toString();
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', filterRows);
      }

      if (listNode) {
        listNode.addEventListener('click', (event) => {
          const button = event.target.closest('.presence-toggle');
          if (button) {
            sendToggle(button);
            return;
          }
          const photoBtn = event.target.closest('.js-open-presence-photo');
          if (!photoBtn || !photoModal || !photoImage) return;
          const url = photoBtn.getAttribute('data-photo-url') || '';
          const title = photoBtn.getAttribute('data-photo-title') || 'Foto do aventureiro';
          if (!url) return;
          photoImage.src = url;
          if (photoTitle) photoTitle.textContent = title;
          photoModal.classList.add('is-open');
          photoModal.setAttribute('aria-hidden', 'false');
        });
      }

      function closePhotoModal() {
        if (!photoModal) return;
        photoModal.classList.remove('is-open');
        photoModal.setAttribute('aria-hidden', 'true');
        if (photoImage) photoImage.src = '';
      }

      if (photoClose) {
        photoClose.addEventListener('click', closePhotoModal);
      }
      if (photoModal) {
        photoModal.addEventListener('click', (event) => {
          if (event.target === photoModal) {
            closePhotoModal();
          }
        });
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closePhotoModal();
        }
      });

      presencas = parseInitData();
      applyAllRows();
      buildSearchSuggestions();
      filterRows();
      fetchPresence();
      setInterval(fetchPresence, 2000);
    })();
  </script>
  {% endif %}
</body>
</html>



