<!DOCTYPE html>
{% load static %}
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Presença</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <style>
    .attendance-toolbar {
      display: grid;
      gap: 0.65rem;
      grid-template-columns: 1fr;
    }
    .attendance-control-card {
      border: 1px solid #dbeafe;
      background: linear-gradient(180deg, #f8fbff 0%, #eef6ff 100%);
      border-radius: 12px;
      padding: 0.7rem;
    }
    .attendance-control-card.is-action {
      display: grid;
      align-content: end;
    }
    .attendance-open-missing-btn {
      border: 1px solid #1d4ed8;
      border-radius: 10px;
      background: #1d4ed8;
      color: #fff;
      font-weight: 800;
      padding: 0.52rem 0.72rem;
      cursor: pointer;
      width: 100%;
    }
    .attendance-open-missing-btn:hover {
      background: #1e40af;
      border-color: #1e40af;
    }
    .attendance-control-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #1e3a8a;
      font-weight: 800;
      margin-bottom: 0.35rem;
    }
    .event-highlight-list {
      display: grid;
      gap: 0.45rem;
      margin: 0.75rem 0 0.35rem;
    }
    .event-highlight-item {
      border: 1px solid #cbd5e1;
      border-left-width: 5px;
      border-radius: 10px;
      background: #fff;
      padding: 0.5rem 0.65rem;
      display: grid;
      gap: 0.2rem;
      text-decoration: none;
      color: #0f172a;
    }
    .event-highlight-item.is-selected {
      box-shadow: 0 0 0 2px #2563eb inset;
      background: #eff6ff;
    }
    .event-highlight-meta {
      font-size: 0.82rem;
      color: #475569;
    }
    .status-hoje {
      border-left-color: #16a34a;
      background: #f0fdf4;
    }
    .status-amanha {
      border-left-color: #2563eb;
      background: #eff6ff;
    }
    .status-futuro {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    .status-passado {
      border-left-color: #64748b;
      background: #f8fafc;
    }
    .status-sem_data {
      border-left-color: #94a3b8;
      background: #f8fafc;
    }
    .attendance-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.65rem;
      flex-wrap: wrap;
      margin-top: 0.6rem;
    }
    .attendance-chip {
      border: 1px solid #1d4ed8;
      color: #1d4ed8;
      background: #eff6ff;
      border-radius: 999px;
      padding: 0.2rem 0.55rem;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .event-status-badge {
      display: inline-flex;
      width: fit-content;
      border-radius: 999px;
      padding: 0.12rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 800;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #1f2937;
      margin-bottom: 0.2rem;
    }
    .event-status-badge.status-hoje {
      border-color: #16a34a;
      color: #166534;
      background: #dcfce7;
    }
    .event-status-badge.status-amanha {
      border-color: #2563eb;
      color: #1d4ed8;
      background: #dbeafe;
    }
    .event-status-badge.status-futuro {
      border-color: #f59e0b;
      color: #92400e;
      background: #fef3c7;
    }
    .event-status-badge.status-passado {
      border-color: #94a3b8;
      color: #334155;
      background: #e2e8f0;
    }
    .event-status-badge.status-sem_data {
      border-color: #94a3b8;
      color: #334155;
      background: #e2e8f0;
    }
    .attendance-list {
      display: grid;
      gap: 0.55rem;
      margin-top: 0.8rem;
    }
    .attendance-row {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 0.65rem;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.7rem;
      align-items: center;
      background: #fff;
    }
    .attendance-person {
      display: grid;
      grid-template-columns: 52px 1fr;
      gap: 0.65rem;
      align-items: center;
      min-width: 0;
    }
    .attendance-avatar {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
    }
    .attendance-avatar-trigger {
      border: 0;
      padding: 0;
      margin: 0;
      background: transparent;
      border-radius: 12px;
      line-height: 0;
      cursor: zoom-in;
    }
    .attendance-avatar-trigger:focus-visible {
      outline: 3px solid rgba(59, 130, 246, .38);
      outline-offset: 2px;
    }
    .attendance-avatar-placeholder {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      border: 1px dashed #cbd5e1;
      background: #f8fafc;
      color: #64748b;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.1;
      padding: 0.2rem;
    }
    .attendance-person-info {
      min-width: 0;
    }
    .attendance-row.present {
      border-color: #16a34a;
      background: #f0fdf4;
    }
    .attendance-name {
      font-weight: 700;
      color: #0f172a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .attendance-meta {
      font-size: 0.82rem;
      color: #475569;
    }
    .presence-toggle {
      min-width: 110px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #334155;
      font-weight: 700;
      padding: 0.55rem 0.75rem;
      cursor: pointer;
    }
    .presence-toggle.is-present {
      background: #16a34a;
      border-color: #15803d;
      color: #fff;
    }
    .presence-toggle:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    .missing-inscricao-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1250;
    }
    .missing-inscricao-modal.is-open {
      display: flex;
    }
    .missing-inscricao-content {
      width: min(96vw, 720px);
      max-height: 92vh;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      background: #fff;
      border-radius: 14px;
      border: 1px solid #cbd5e1;
      box-shadow: 0 22px 50px rgba(15, 23, 42, .35);
    }
    .missing-inscricao-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .6rem;
      padding: .65rem .8rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    .missing-inscricao-title {
      font-weight: 800;
      color: #0f172a;
      font-size: .95rem;
    }
    .missing-inscricao-close {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      padding: .25rem .55rem;
      font-weight: 800;
      color: #0f172a;
    }
    .missing-inscricao-body {
      overflow: auto;
      padding: .75rem;
      display: grid;
      gap: .8rem;
      background: #fff;
    }
    .missing-inscricao-form {
      border: 1px solid #dbeafe;
      background: #f8fbff;
      border-radius: 12px;
      padding: .7rem;
      display: grid;
      gap: .55rem;
    }
    .missing-inscricao-grid {
      display: grid;
      gap: .55rem;
      grid-template-columns: 1fr 1fr;
    }
    .missing-inscricao-form label {
      display: grid;
      gap: .3rem;
      font-size: .86rem;
      color: #334155;
      font-weight: 700;
    }
    .missing-inscricao-form input[type="text"],
    .missing-inscricao-form input[type="file"] {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      padding: .48rem .55rem;
      font-size: .93rem;
    }
    .missing-inscricao-submit {
      border: 1px solid #15803d;
      border-radius: 10px;
      background: #16a34a;
      color: #fff;
      font-weight: 800;
      padding: .5rem .75rem;
      cursor: pointer;
      width: fit-content;
    }
    .missing-inscricao-submit:disabled {
      opacity: .65;
      cursor: wait;
    }
    .missing-inscricao-status {
      margin: 0;
      font-size: .82rem;
      color: #475569;
      min-height: 1.1rem;
    }
    .missing-inscricao-status[data-state="ok"] {
      color: #166534;
      font-weight: 700;
    }
    .missing-inscricao-status[data-state="error"] {
      color: #991b1b;
      font-weight: 700;
    }
    .missing-inscricao-list {
      display: grid;
      gap: .55rem;
    }
    .missing-inscricao-item {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: .55rem .6rem;
      background: #fff;
      display: grid;
      grid-template-columns: 54px 1fr;
      gap: .6rem;
      align-items: center;
    }
    .missing-inscricao-photo-btn {
      border: 0;
      background: transparent;
      border-radius: 10px;
      padding: 0;
      line-height: 0;
      cursor: zoom-in;
    }
    .missing-inscricao-photo {
      width: 54px;
      height: 54px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      display: block;
    }
    .missing-inscricao-name {
      color: #0f172a;
      font-weight: 800;
      line-height: 1.2;
      word-break: break-word;
    }
    .missing-inscricao-meta {
      color: #64748b;
      font-size: .78rem;
      margin-top: .12rem;
    }
    .missing-inscricao-empty {
      border: 1px dashed #cbd5e1;
      border-radius: 10px;
      padding: .55rem .6rem;
      background: #f8fafc;
      color: #64748b;
      font-size: .84rem;
    }
    .resp-presence-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 0.85rem;
      margin-top: 0.4rem;
    }
    .resp-presence-card {
      border: 1px solid #dbeafe;
      border-radius: 14px;
      background: #fff;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
    }
    .resp-presence-card summary {
      list-style: none;
      cursor: pointer;
      padding: 0.75rem;
      display: grid;
      grid-template-columns: 60px 1fr auto;
      gap: 0.75rem;
      align-items: center;
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
    }
    .resp-presence-card summary::-webkit-details-marker { display: none; }
    .resp-presence-avatar {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid #bfdbfe;
      background: #f8fafc;
      display: block;
    }
    .resp-presence-avatar-placeholder {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      border: 1px dashed #cbd5e1;
      background: #f8fafc;
      color: #64748b;
      display: grid;
      place-items: center;
      text-align: center;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 0.25rem;
      line-height: 1.1;
    }
    .resp-presence-main { min-width: 0; display: grid; gap: 0.15rem; }
    .resp-presence-name {
      color: #0f172a;
      font-weight: 800;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .resp-presence-sub { color: #475569; font-size: 0.82rem; }
    .resp-presence-badges { display: grid; justify-items: end; gap: 0.35rem; }
    .resp-presence-chip {
      border-radius: 999px;
      padding: 0.16rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 800;
      white-space: nowrap;
      border: 1px solid #dbeafe;
      color: #1d4ed8;
      background: #eff6ff;
    }
    .resp-presence-toggle-indicator {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      display: grid;
      place-items: center;
      color: #1d4ed8;
      font-weight: 900;
      background: #fff;
    }
    .resp-presence-toggle-indicator::before { content: "+"; }
    .resp-presence-card[open] .resp-presence-toggle-indicator { background: #eff6ff; }
    .resp-presence-card[open] .resp-presence-toggle-indicator::before { content: "-"; }
    .resp-presence-detail {
      border-top: 1px solid #e2e8f0;
      padding: 0.75rem;
      display: grid;
      gap: 0.6rem;
      background: #fff;
    }
    .resp-presence-detail-head { color: #334155; font-size: 0.84rem; font-weight: 700; }
    .resp-presence-events { display: grid; gap: 0.45rem; }
    .resp-presence-event-row {
      border: 1px solid #e2e8f0;
      border-left-width: 4px;
      border-radius: 10px;
      background: #fff;
      padding: 0.55rem 0.6rem;
      display: grid;
      gap: 0.2rem;
    }
    .resp-presence-event-row.status-hoje { border-left-color: #16a34a; }
    .resp-presence-event-row.status-amanha { border-left-color: #2563eb; }
    .resp-presence-event-row.status-futuro { border-left-color: #f59e0b; }
    .resp-presence-event-row.status-passado,
    .resp-presence-event-row.status-sem_data { border-left-color: #64748b; }
    .resp-presence-event-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
      color: #0f172a;
      font-weight: 700;
    }
    .resp-presence-event-meta { color: #475569; font-size: 0.8rem; }
    .resp-presence-presence-badge {
      border-radius: 999px;
      padding: 0.14rem 0.48rem;
      font-size: 0.74rem;
      font-weight: 800;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #334155;
      white-space: nowrap;
    }
    .resp-presence-presence-badge.is-present {
      border-color: #16a34a;
      background: #dcfce7;
      color: #166534;
    }
    .resp-presence-event-audit { color: #64748b; font-size: 0.75rem; }
    @media (max-width: 800px) {
      .attendance-row {
        grid-template-columns: 1fr;
      }
      .presence-toggle {
        width: 100%;
      }
      .missing-inscricao-grid {
        grid-template-columns: 1fr;
      }
      .resp-presence-card summary {
        grid-template-columns: 56px 1fr;
      }
      .resp-presence-badges {
        grid-column: 1 / -1;
        justify-items: start;
        grid-template-columns: auto auto;
      }
    }
    .presence-photo-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1200;
    }
    .presence-photo-modal.is-open {
      display: flex;
    }
    .presence-photo-content {
      width: min(92vw, 640px);
      background: #fff;
      border-radius: 14px;
      border: 1px solid #cbd5e1;
      box-shadow: 0 22px 50px rgba(15, 23, 42, .35);
      overflow: hidden;
    }
    .presence-photo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .6rem;
      padding: .6rem .8rem;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    .presence-photo-title {
      font-weight: 700;
      color: #0f172a;
      font-size: .95rem;
    }
    .presence-photo-close {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      padding: .25rem .55rem;
      font-weight: 800;
      color: #0f172a;
    }
    .presence-photo-body {
      padding: .7rem;
      display: grid;
      place-items: center;
      background: #fff;
    }
    .presence-photo-image {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
    }
  </style>
</head>
<body class="painel-page">
  {% if presenca_mode != 'responsavel' %}
    {{ presencas_json|json_script:"presencas-init-data" }}
    {{ faltas_inscricao_json|json_script:"faltas-inscricao-init-data" }}
  {% endif %}
  {% include '_painel_sidebar.html' %}
  <main class="painel-content">
    <header class="painel-header">
      <h2>Presença</h2>
      {% if presenca_mode == 'responsavel' %}
        <p>Veja a presença dos aventureiros do seu cadastro em todos os eventos.</p>
      {% else %}
        <p>Selecione o evento e marque presença de forma rápida no celular.</p>
      {% endif %}
    </header>

    <section class="painel-card">
      <div class="status" aria-live="polite">
        {% for message in messages %}
          <p data-state="{{ message.tags }}">{{ message }}</p>
        {% empty %}
          {% if presenca_mode == 'responsavel' %}
            <p data-state="info">Clique em um aventureiro para ver todos os eventos e a situação de presença.</p>
          {% else %}
            <p data-state="info">Eventos de hoje e amanhã aparecem primeiro.</p>
          {% endif %}
        {% endfor %}
      </div>
    </section>

    {% if presenca_mode == 'responsavel' %}
    <section class="painel-card">
      {% if aventureiro_cards %}
        <div class="resp-presence-grid">
          {% for card in aventureiro_cards %}
            <details class="resp-presence-card">
              <summary>
                {% if card.foto_url %}
                  <img src="{{ card.foto_url }}" alt="Foto de {{ card.aventureiro.nome }}" class="resp-presence-avatar" loading="lazy" />
                {% else %}
                  <div class="resp-presence-avatar-placeholder">Sem foto</div>
                {% endif %}
                <div class="resp-presence-main">
                  <div class="resp-presence-name">{{ card.aventureiro.nome }}</div>
                  <div class="resp-presence-sub">{{ card.total_presentes }}/{{ card.total_eventos }} evento(s) com presença</div>
                </div>
                <div class="resp-presence-badges">
                  <span class="resp-presence-chip">Eventos: {{ card.total_eventos }}</span>
                  <span class="resp-presence-toggle-indicator" aria-hidden="true"></span>
                </div>
              </summary>
              <div class="resp-presence-detail">
                <div class="resp-presence-detail-head">Histórico de eventos e presença</div>
                {% if card.eventos_status %}
                  <div class="resp-presence-events">
                    {% for item in card.eventos_status %}
                      <article class="resp-presence-event-row status-{{ item.status_key }}">
                        <div class="resp-presence-event-title">
                          <span>{{ item.evento.name }}</span>
                          <span class="resp-presence-presence-badge {% if item.presente %}is-present{% endif %}">
                            {{ item.presenca_label }}
                          </span>
                        </div>
                        <div class="resp-presence-event-meta">
                          {{ item.relative_label }} | {{ item.evento.event_date|date:"d/m/Y"|default:"sem data" }} {{ item.evento.event_time|time:"H:i"|default:"" }}
                        </div>
                        {% if item.updated_at %}
                          <div class="resp-presence-event-audit">
                            Atualizado em {{ item.updated_at|date:"d/m/Y H:i" }}{% if item.updated_by %} por {{ item.updated_by }}{% endif %}
                          </div>
                        {% endif %}
                      </article>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="panel-note">Nenhum evento cadastrado ainda.</p>
                {% endif %}
              </div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum aventureiro vinculado ao seu cadastro.</p>
      {% endif %}
    </section>
    {% else %}
    <section class="painel-card">
      <div class="attendance-toolbar">
        <div class="attendance-control-card">
          <div class="attendance-control-title">Evento</div>
          <label for="evento-select">
            <select id="evento-select">
              {% for row in eventos %}
                <option value="{{ row.evento.id }}" {% if selected_event and selected_event.id == row.evento.id %}selected{% endif %}>
                  {{ row.relative_label }} | {{ row.evento.name }} | {{ row.evento.event_date|date:"d/m/Y"|default:"sem data" }} {{ row.evento.event_time|time:"H:i"|default:"" }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>
        <div class="attendance-control-card">
          <div class="attendance-control-title">Buscar aventureiro</div>
          <label for="attendance-search">
            <input
              type="text"
              id="attendance-search"
              list="attendance-search-suggestions"
              autocomplete="off"
              placeholder="Digite nome, responsável ou username"
            />
          </label>
          <datalist id="attendance-search-suggestions"></datalist>
        </div>
        <div class="attendance-control-card is-action">
          <button type="button" class="attendance-open-missing-btn" id="open-missing-inscricao-btn" {% if not selected_event %}disabled{% endif %}>
            Falta inscrição
          </button>
        </div>
      </div>

      <div class="event-highlight-list">
        {% for row in eventos %}
          <a href="?evento={{ row.evento.id }}" class="event-highlight-item status-{{ row.status_key }} {% if selected_event and selected_event.id == row.evento.id %}is-selected{% endif %}">
            <span class="event-status-badge status-{{ row.status_key }}">{{ row.relative_label }}</span>
            <strong>{{ row.evento.name }}</strong>
            <span class="event-highlight-meta">{{ row.evento.event_date|date:"d/m/Y"|default:"sem data" }} {{ row.evento.event_time|time:"H:i"|default:"" }}</span>
          </a>
        {% endfor %}
      </div>

      {% if selected_event %}
        <div class="attendance-summary">
          <div>
            {% if selected_event_row %}
              <span class="event-status-badge status-{{ selected_event_row.status_key }}">{{ selected_event_row.relative_label }}</span>
            {% endif %}
            <strong id="current-event-name">{{ selected_event.name }}</strong>
          </div>
          <span class="attendance-chip" id="attendance-counter">{{ present_count }}/{{ total_count }} presentes</span>
          <small id="last-sync-label">Sincronizando...</small>
        </div>
        <div class="attendance-list" id="attendance-list">
          {% for av in aventureiros %}
            <article
              class="attendance-row"
              data-aventureiro-id="{{ av.id }}"
              data-search="{{ av.nome|lower }} {{ av.responsavel.responsavel_nome|default:''|lower }} {{ av.responsavel.user.username|lower }}"
              data-name-display="{{ av.nome }}"
              data-responsavel-display="{{ av.responsavel.responsavel_nome|default:'' }}"
              data-username-display="{{ av.responsavel.user.username }}"
            >
              <div class="attendance-person">
                {% if av.presenca_foto_url %}
                  <button
                    type="button"
                    class="attendance-avatar-trigger js-open-presence-photo"
                    data-photo-url="{{ av.presenca_foto_url }}"
                    data-photo-title="Foto de {{ av.nome|escape }}"
                    aria-label="Ampliar foto de {{ av.nome }}"
                  >
                    <img src="{{ av.presenca_foto_url }}" alt="Foto de {{ av.nome }}" class="attendance-avatar" loading="lazy" />
                  </button>
                {% else %}
                  <div class="attendance-avatar-placeholder">Sem foto</div>
                {% endif %}
                <div class="attendance-person-info">
                  <div class="attendance-name">{{ av.nome }}</div>
                  <div class="attendance-meta">
                    Responsável: {{ av.responsavel.responsavel_nome|default:"-" }} | Usuário: {{ av.responsavel.user.username }}
                  </div>
                </div>
              </div>
              <button type="button" class="presence-toggle" data-aventureiro-id="{{ av.id }}">
                Ausente
              </button>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="panel-note">Nenhum evento cadastrado ainda.</p>
      {% endif %}
    </section>
    {% endif %}
  </main>

  {% if presenca_mode != 'responsavel' %}
  <div class="missing-inscricao-modal" id="missing-inscricao-modal" aria-hidden="true">
    <div class="missing-inscricao-content" role="dialog" aria-modal="true" aria-labelledby="missing-inscricao-title">
      <div class="missing-inscricao-header">
        <div class="missing-inscricao-title" id="missing-inscricao-title">Registrar falta inscrição</div>
        <button type="button" class="missing-inscricao-close" id="missing-inscricao-close" aria-label="Fechar">Fechar</button>
      </div>
      <div class="missing-inscricao-body">
        <form id="missing-inscricao-form" class="missing-inscricao-form" novalidate>
          <input type="hidden" id="missing-inscricao-evento-id" value="{% if selected_event %}{{ selected_event.id }}{% endif %}" />
          <div class="missing-inscricao-grid">
            <label for="missing-inscricao-nome">
              Nome
              <input type="text" id="missing-inscricao-nome" name="nome" maxlength="255" required placeholder="Nome de quem faltou inscrição" />
            </label>
            <label for="missing-inscricao-foto">
              Foto
              <input type="file" id="missing-inscricao-foto" name="foto" accept="image/*" capture="environment" required />
            </label>
          </div>
          <button type="submit" class="missing-inscricao-submit" id="missing-inscricao-submit">Salvar</button>
          <p class="missing-inscricao-status" id="missing-inscricao-status" aria-live="polite"></p>
        </form>

        <div class="missing-inscricao-list" id="missing-inscricao-list">
          {% if faltas_inscricao %}
            {% for item in faltas_inscricao %}
              <article class="missing-inscricao-item">
                <button
                  type="button"
                  class="missing-inscricao-photo-btn js-open-presence-photo"
                  data-photo-url="{{ item.foto.url }}"
                  data-photo-title="Falta inscrição - {{ item.nome|escape }}"
                  aria-label="Ampliar foto de {{ item.nome }}"
                >
                  <img src="{{ item.foto.url }}" alt="Foto de {{ item.nome }}" class="missing-inscricao-photo" loading="lazy" />
                </button>
                <div>
                  <div class="missing-inscricao-name">{{ item.nome }}</div>
                  <div class="missing-inscricao-meta">
                    {{ item.created_at|date:"d/m/Y H:i" }}{% if item.created_by %} | por {{ item.created_by.username }}{% endif %}
                  </div>
                </div>
              </article>
            {% endfor %}
          {% else %}
            <div class="missing-inscricao-empty">Nenhum registro de falta inscrição neste evento ainda.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="presence-photo-modal" id="presence-photo-modal" aria-hidden="true">
    <div class="presence-photo-content" role="dialog" aria-modal="true" aria-labelledby="presence-photo-title">
      <div class="presence-photo-header">
        <div class="presence-photo-title" id="presence-photo-title">Foto do aventureiro</div>
        <button type="button" class="presence-photo-close" id="presence-photo-close" aria-label="Fechar">Fechar</button>
      </div>
      <div class="presence-photo-body">
        <img id="presence-photo-image" class="presence-photo-image" src="" alt="Foto ampliada do aventureiro" />
      </div>
    </div>
  </div>
  <script>
    (function () {
      const eventSelect = document.getElementById('evento-select');
      const searchInput = document.getElementById('attendance-search');
      const searchSuggestionsNode = document.getElementById('attendance-search-suggestions');
      const listNode = document.getElementById('attendance-list');
      const counterNode = document.getElementById('attendance-counter');
      const lastSyncNode = document.getElementById('last-sync-label');
      const initNode = document.getElementById('presencas-init-data');
      const faltasInitNode = document.getElementById('faltas-inscricao-init-data');
      const openMissingBtn = document.getElementById('open-missing-inscricao-btn');
      const missingModal = document.getElementById('missing-inscricao-modal');
      const missingClose = document.getElementById('missing-inscricao-close');
      const missingForm = document.getElementById('missing-inscricao-form');
      const missingEventInput = document.getElementById('missing-inscricao-evento-id');
      const missingNomeInput = document.getElementById('missing-inscricao-nome');
      const missingFotoInput = document.getElementById('missing-inscricao-foto');
      const missingSubmit = document.getElementById('missing-inscricao-submit');
      const missingStatus = document.getElementById('missing-inscricao-status');
      const missingListNode = document.getElementById('missing-inscricao-list');
      const photoModal = document.getElementById('presence-photo-modal');
      const photoImage = document.getElementById('presence-photo-image');
      const photoTitle = document.getElementById('presence-photo-title');
      const photoClose = document.getElementById('presence-photo-close');
      let presencas = {};
      let faltasInscricao = [];

      const parseInitData = () => {
        if (!initNode) return {};
        try {
          const parsed = JSON.parse(initNode.textContent || '{}');
          return (parsed && typeof parsed === 'object') ? parsed : {};
        } catch (_error) {
          return {};
        }
      };
      const parseFaltasInitData = () => {
        if (!faltasInitNode) return [];
        try {
          const parsed = JSON.parse(faltasInitNode.textContent || '[]');
          return Array.isArray(parsed) ? parsed : [];
        } catch (_error) {
          return [];
        }
      };

      const getCookie = (name) => {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : '';
      };

      const selectedEventId = () => (eventSelect ? (eventSelect.value || '').trim() : '');
      const normalizeSearchText = (value) => (
        String(value || '')
          .toLocaleLowerCase('pt-BR')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9\s]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
      );
      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      const selectedEventName = () => {
        if (!eventSelect) return '';
        const option = eventSelect.options[eventSelect.selectedIndex];
        return option ? (option.textContent || '').trim() : '';
      };
      const openPhotoModal = (url, title) => {
        if (!photoModal || !photoImage || !url) return;
        photoImage.src = url;
        if (photoTitle) photoTitle.textContent = title || 'Foto';
        photoModal.classList.add('is-open');
        photoModal.setAttribute('aria-hidden', 'false');
      };
      const setMissingStatus = (message, state) => {
        if (!missingStatus) return;
        missingStatus.textContent = message || '';
        if (!state) {
          missingStatus.removeAttribute('data-state');
          return;
        }
        missingStatus.setAttribute('data-state', state);
      };
      const renderMissingList = () => {
        if (!missingListNode) return;
        if (!faltasInscricao.length) {
          missingListNode.innerHTML = '<div class="missing-inscricao-empty">Nenhum registro de falta inscrição neste evento ainda.</div>';
          return;
        }
        missingListNode.innerHTML = faltasInscricao.map((item) => {
          const nome = escapeHtml(item.nome || '-');
          const fotoUrl = escapeHtml(item.foto_url || '');
          const createdAt = escapeHtml(item.created_at_label || '');
          const createdBy = escapeHtml(item.created_by || '');
          const auditLabel = createdBy ? `${createdAt} | por ${createdBy}` : createdAt;
          return `
            <article class="missing-inscricao-item">
              <button
                type="button"
                class="missing-inscricao-photo-btn js-open-presence-photo"
                data-photo-url="${fotoUrl}"
                data-photo-title="Falta inscrição - ${nome}"
                aria-label="Ampliar foto de ${nome}"
              >
                <img src="${fotoUrl}" alt="Foto de ${nome}" class="missing-inscricao-photo" loading="lazy" />
              </button>
              <div>
                <div class="missing-inscricao-name">${nome}</div>
                <div class="missing-inscricao-meta">${auditLabel}</div>
              </div>
            </article>
          `;
        }).join('');
      };
      const compressImageForUpload = async (file) => {
        if (!file || !String(file.type || '').startsWith('image/')) return file;
        if (String(file.type || '').toLowerCase() === 'image/gif') return file;
        if (file.size <= 450 * 1024) return file;

        const objectUrl = URL.createObjectURL(file);
        try {
          const image = await new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = objectUrl;
          });

          const maxSide = 1600;
          const sourceWidth = Number(image.naturalWidth || image.width || 0);
          const sourceHeight = Number(image.naturalHeight || image.height || 0);
          if (!sourceWidth || !sourceHeight) return file;
          const scale = Math.min(1, maxSide / Math.max(sourceWidth, sourceHeight));
          const targetWidth = Math.max(1, Math.round(sourceWidth * scale));
          const targetHeight = Math.max(1, Math.round(sourceHeight * scale));

          const canvas = document.createElement('canvas');
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          const ctx = canvas.getContext('2d');
          if (!ctx) return file;
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(image, 0, 0, targetWidth, targetHeight);

          const qualities = [0.82, 0.74, 0.66];
          let bestBlob = null;
          for (const quality of qualities) {
            // eslint-disable-next-line no-await-in-loop
            const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
            if (!blob) continue;
            if (!bestBlob || blob.size < bestBlob.size) {
              bestBlob = blob;
            }
            if (blob.size <= 450 * 1024) break;
          }
          if (!bestBlob) return file;
          if (bestBlob.size >= file.size * 0.98) return file;

          const originalBaseName = (file.name || 'foto')
            .replace(/\.[^.]+$/, '')
            .replace(/[^\w\-]+/g, '_')
            .slice(0, 64) || 'foto';
          return new File([bestBlob], `${originalBaseName}.jpg`, {
            type: 'image/jpeg',
            lastModified: Date.now(),
          });
        } catch (_error) {
          return file;
        } finally {
          URL.revokeObjectURL(objectUrl);
        }
      };

      const applyRowState = (row, payload) => {
        if (!row) return;
        const button = row.querySelector('.presence-toggle');
        const isPresent = !!(payload && payload.presente);
        row.classList.toggle('present', isPresent);
        if (button) {
          button.classList.toggle('is-present', isPresent);
          button.textContent = isPresent ? 'Presente' : 'Ausente';
        }
      };

      const refreshCounter = () => {
        if (!counterNode || !listNode) return;
        const rows = listNode.querySelectorAll('.attendance-row');
        const present = listNode.querySelectorAll('.attendance-row.present').length;
        counterNode.textContent = present + '/' + rows.length + ' presentes';
      };

      const applyAllRows = () => {
        if (!listNode) return;
        const rows = listNode.querySelectorAll('.attendance-row');
        rows.forEach((row) => {
          const avId = row.getAttribute('data-aventureiro-id');
          applyRowState(row, presencas[String(avId)] || { presente: false });
        });
        refreshCounter();
      };

      const filterRows = () => {
        if (!listNode || !searchInput) return;
        const term = normalizeSearchText(searchInput.value || '');
        listNode.querySelectorAll('.attendance-row').forEach((row) => {
          const cached = row.getAttribute('data-search-normalized');
          const haystack = cached || normalizeSearchText(row.getAttribute('data-search') || '');
          if (!cached) {
            row.setAttribute('data-search-normalized', haystack);
          }
          row.style.display = (!term || haystack.includes(term)) ? '' : 'none';
        });
      };

      const buildSearchSuggestions = () => {
        if (!listNode || !searchSuggestionsNode) return;
        const uniqueValues = new Map();
        listNode.querySelectorAll('.attendance-row').forEach((row) => {
          [
            row.getAttribute('data-name-display'),
            row.getAttribute('data-responsavel-display'),
            row.getAttribute('data-username-display'),
          ].forEach((rawValue) => {
            const value = (rawValue || '').trim();
            if (!value) return;
            const key = normalizeSearchText(value);
            if (!key) return;
            if (!uniqueValues.has(key)) {
              uniqueValues.set(key, value);
            }
          });
        });
        const sortedValues = Array.from(uniqueValues.values()).sort((a, b) => a.localeCompare(b, 'pt-BR'));
        searchSuggestionsNode.innerHTML = '';
        sortedValues.forEach((value) => {
          const option = document.createElement('option');
          option.value = value;
          searchSuggestionsNode.appendChild(option);
        });
      };

      const updateLastSync = () => {
        if (!lastSyncNode) return;
        const now = new Date();
        lastSyncNode.textContent = 'Atualizado às ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      };

      const fetchPresence = () => {
        const eventId = selectedEventId();
        if (!eventId || !listNode) return Promise.resolve();
        return fetch("{% url 'accounts:presenca_status_api' %}?evento_id=" + encodeURIComponent(eventId), {
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data || !data.ok) return;
            presencas = data.presencas || {};
            applyAllRows();
            updateLastSync();
          })
          .catch(() => {});
      };
      const fetchMissingInscricaoList = () => {
        const eventId = selectedEventId();
        if (!eventId) return Promise.resolve();
        if (missingEventInput) missingEventInput.value = eventId;
        return fetch("{% url 'accounts:presenca_falta_inscricao_api' %}?evento_id=" + encodeURIComponent(eventId), {
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data || !data.ok) {
              throw new Error((data && data.error) || 'Não foi possível carregar os registros.');
            }
            faltasInscricao = Array.isArray(data.itens) ? data.itens : [];
            renderMissingList();
          })
          .catch((error) => {
            setMissingStatus(error.message || 'Falha ao carregar os registros.', 'error');
          });
      };

      const sendToggle = (button) => {
        const eventId = selectedEventId();
        const avId = button.getAttribute('data-aventureiro-id');
        if (!eventId || !avId) return;
        const current = presencas[String(avId)] || { presente: false };
        const nextPresent = !current.presente;
        button.disabled = true;
        const formData = new FormData();
        formData.append('evento_id', eventId);
        formData.append('aventureiro_id', avId);
        formData.append('presente', nextPresent ? '1' : '0');
        fetch("{% url 'accounts:presenca_toggle_api' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data || !data.ok) return;
            presencas[String(avId)] = {
              presente: !!data.presente,
              updated_at: data.updated_at || '',
              updated_by: data.updated_by || '',
            };
            applyAllRows();
            updateLastSync();
          })
          .catch(() => {})
          .finally(() => {
            button.disabled = false;
          });
      };
      const submitMissingInscricao = async () => {
        const eventId = selectedEventId();
        if (!eventId) {
          setMissingStatus('Selecione um evento antes de registrar.', 'error');
          return;
        }
        const nome = (missingNomeInput ? missingNomeInput.value : '').trim();
        const foto = (missingFotoInput && missingFotoInput.files) ? missingFotoInput.files[0] : null;
        if (!nome) {
          setMissingStatus('Informe o nome.', 'error');
          if (missingNomeInput) missingNomeInput.focus();
          return;
        }
        if (!foto) {
          setMissingStatus('Capture ou selecione uma foto.', 'error');
          return;
        }
        if (missingSubmit) missingSubmit.disabled = true;
        try {
          setMissingStatus('Otimizando foto...', null);
          const fotoOtimizada = await compressImageForUpload(foto);
          setMissingStatus('Enviando...', null);

          const formData = new FormData();
          formData.append('evento_id', eventId);
          formData.append('nome', nome);
          formData.append('foto', fotoOtimizada);

          const response = await fetch("{% url 'accounts:presenca_falta_inscricao_api' %}", {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'X-Requested-With': 'XMLHttpRequest',
            },
          });
          const data = await response.json();
          if (!data || !data.ok || !data.item) {
            throw new Error((data && data.error) || 'Não foi possível salvar o registro.');
          }
          faltasInscricao = [data.item].concat(faltasInscricao || []);
          renderMissingList();
          setMissingStatus('Registro salvo com sucesso.', 'ok');
          if (missingForm) missingForm.reset();
          if (missingNomeInput) missingNomeInput.focus();
        } catch (error) {
          setMissingStatus((error && error.message) || 'Falha ao salvar o registro.', 'error');
        } finally {
          if (missingSubmit) missingSubmit.disabled = false;
        }
      };

      if (eventSelect) {
        eventSelect.addEventListener('change', () => {
          const eventId = selectedEventId();
          if (!eventId) return;
          const url = new URL(window.location.href);
          url.searchParams.set('evento', eventId);
          window.location.href = url.toString();
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', filterRows);
      }

      if (listNode) {
        listNode.addEventListener('click', (event) => {
          const button = event.target.closest('.presence-toggle');
          if (button) {
            sendToggle(button);
            return;
          }
          const photoBtn = event.target.closest('.js-open-presence-photo');
          if (!photoBtn) return;
          const url = photoBtn.getAttribute('data-photo-url') || '';
          const title = photoBtn.getAttribute('data-photo-title') || 'Foto do aventureiro';
          openPhotoModal(url, title);
        });
      }

      if (openMissingBtn && missingModal) {
        openMissingBtn.addEventListener('click', () => {
          const eventId = selectedEventId();
          if (!eventId) return;
          if (missingEventInput) missingEventInput.value = eventId;
          missingModal.classList.add('is-open');
          missingModal.setAttribute('aria-hidden', 'false');
          setMissingStatus('Evento: ' + selectedEventName(), null);
          fetchMissingInscricaoList();
          setTimeout(() => {
            if (missingNomeInput) missingNomeInput.focus();
          }, 30);
        });
      }

      function closeMissingModal() {
        if (!missingModal) return;
        missingModal.classList.remove('is-open');
        missingModal.setAttribute('aria-hidden', 'true');
        setMissingStatus('', null);
      }
      if (missingClose) {
        missingClose.addEventListener('click', closeMissingModal);
      }
      if (missingModal) {
        missingModal.addEventListener('click', (event) => {
          if (event.target === missingModal) {
            closeMissingModal();
          }
        });
      }
      if (missingForm) {
        missingForm.addEventListener('submit', (event) => {
          event.preventDefault();
          submitMissingInscricao();
        });
      }
      if (missingListNode) {
        missingListNode.addEventListener('click', (event) => {
          const photoBtn = event.target.closest('.js-open-presence-photo');
          if (!photoBtn) return;
          const url = photoBtn.getAttribute('data-photo-url') || '';
          const title = photoBtn.getAttribute('data-photo-title') || 'Falta inscrição';
          openPhotoModal(url, title);
        });
      }

      function closePhotoModal() {
        if (!photoModal) return;
        photoModal.classList.remove('is-open');
        photoModal.setAttribute('aria-hidden', 'true');
        if (photoImage) photoImage.src = '';
      }

      if (photoClose) {
        photoClose.addEventListener('click', closePhotoModal);
      }
      if (photoModal) {
        photoModal.addEventListener('click', (event) => {
          if (event.target === photoModal) {
            closePhotoModal();
          }
        });
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (missingModal && missingModal.classList.contains('is-open')) {
            closeMissingModal();
            return;
          }
          closePhotoModal();
        }
      });

      presencas = parseInitData();
      faltasInscricao = parseFaltasInitData();
      applyAllRows();
      buildSearchSuggestions();
      filterRows();
      renderMissingList();
      fetchPresence();
      setInterval(fetchPresence, 2000);
    })();
  </script>
  {% endif %}
</body>
</html>



